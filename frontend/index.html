<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blueshift Observatory - Premium Dashboard</title>
  <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f1f5f9;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Premium Design System Colors & Variables */
    :root {
      --gradient-primary: linear-gradient(135deg, #2563eb, #1d4ed8);
      --gradient-header: linear-gradient(135deg, #1e3a5f 0%, #2563eb 50%, #3b82f6 100%);
      --gradient-sidebar: linear-gradient(180deg, #0b1929 0%, #152e4d 50%, #1e4976 100%);

      --color-green: #10b981;
      --color-yellow: #f59e0b;
      --color-orange: #f97316;
      --color-red: #ef4444;
      --color-blue: #3b82f6;
      --color-purple: #8b5cf6;

      --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    /* App Layout */
    .app-container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: var(--gradient-sidebar);
      color: #fff;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.3s ease;
      overflow: hidden;
    }

    .sidebar.collapsed {
      width: 64px;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-logo-icon {
      width: 32px;
      height: 32px;
      background: var(--gradient-primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .sidebar-logo-icon span {
      font-size: 16px;
      font-weight: 900;
      color: #fff;
    }

    .sidebar-logo-text p {
      margin: 0;
      font-size: 14px;
      font-weight: 800;
    }

    .sidebar-logo-text p:last-child {
      font-size: 11px;
      opacity: 0.6;
    }

    .sidebar.collapsed .sidebar-logo-text {
      display: none;
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s;
      width: 100%;
    }

    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: rgba(255, 255, 255, 0.9);
    }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.2);
      color: #fff;
      font-weight: 600;
    }

    .nav-item svg {
      flex-shrink: 0;
      opacity: 0.7;
    }

    .nav-item.active svg {
      opacity: 1;
    }

    .nav-item-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar.collapsed .nav-item-text {
      display: none;
    }

    .nav-item-indicator {
      margin-left: auto;
      width: 6px;
      height: 6px;
      background: #3b82f6;
      border-radius: 50%;
    }

    .sidebar.collapsed .nav-item-indicator {
      display: none;
    }

    .sidebar-footer {
      padding: 12px 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Active Filter State for Stat Cards */
    .stat-card.active-filter {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      transform: translateY(-4px);
    }

    .collapse-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      font-size: 12px;
    }

    .collapse-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow: auto;
      padding: 24px 28px;
    }

    /* Page Header Component */
    .page-header {
      background: var(--gradient-header);
      border-radius: var(--radius-lg);
      padding: 28px 32px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .page-header-orb-1 {
      position: absolute;
      top: -40px;
      right: -40px;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
      border-radius: 50%;
    }

    .page-header-orb-2 {
      position: absolute;
      bottom: -20px;
      left: 30%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
      border-radius: 50%;
    }

    .page-header-content {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .page-header-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .page-header-title {
      color: #fff;
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .page-header-subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      margin: 4px 0 0;
    }

    /* Control Panel */
    .control-panel {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .control-group {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .control-label {
      color: #94a3b8;
    }

    .control-value {
      font-weight: 600;
      color: #334155;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: #fff;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary {
      background: #fff;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #f8fafc;
    }

    .btn-sm {
      padding: 6px 12px !important;
      font-size: 13px !important;
      border-radius: 6px !important;
      display: inline-flex !important;
      align-items: center;
      gap: 4px;
    }

    .btn-success {
      background: var(--color-green);
      color: #fff;
    }

    .date-input {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 13px;
      color: #475569;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }

    .stat-card {
      border-radius: 14px;
      padding: 20px 22px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card-healthy {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border-left: 4px solid var(--color-green);
    }

    .stat-card-monitor {
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
      border-left: 4px solid var(--color-yellow);
    }

    .stat-card-low {
      background: linear-gradient(135deg, #fff7ed, #fed7aa);
      border-left: 4px solid var(--color-orange);
    }

    .stat-card-critical {
      background: linear-gradient(135deg, #fef2f2, #fecaca);
      border-left: 4px solid var(--color-red);
    }

    .stat-card-icon-badge {
      position: absolute;
      top: 12px;
      right: 14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
    }

    .stat-card-healthy .stat-card-icon-badge { background: var(--color-green); }
    .stat-card-monitor .stat-card-icon-badge { background: var(--color-yellow); }
    .stat-card-low .stat-card-icon-badge { background: var(--color-orange); }
    .stat-card-critical .stat-card-icon-badge { background: var(--color-red); }

    .stat-card-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.06em;
      margin: 0 0 6px;
      text-transform: uppercase;
    }

    .stat-card-healthy .stat-card-label { color: var(--color-green); }
    .stat-card-monitor .stat-card-label { color: var(--color-yellow); }
    .stat-card-low .stat-card-label { color: var(--color-orange); }
    .stat-card-critical .stat-card-label { color: var(--color-red); }

    .stat-card-value {
      font-size: 36px;
      font-weight: 800;
      color: #1e293b;
      margin: 0 0 4px;
      line-height: 1;
    }

    .stat-card-subtitle {
      font-size: 12px;
      color: #64748b;
      margin: 0;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: #f1f5f9;
      border-radius: 12px;
      padding: 4px;
    }

    .tab {
      padding: 9px 18px;
      border-radius: 9px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: #64748b;
      transition: all 0.2s;
    }

    .tab.active {
      background: #fff;
      color: #1e40af;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    /* Card Section */
    .card-section {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 16px 22px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
    }

    .card-meta {
      font-size: 12px;
      color: #94a3b8;
    }

    /* Data Table */
    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 1200px;
    }

    .data-table thead tr {
      background: #f8fafc;
    }

    .data-table th {
      padding: 12px 14px;
      text-align: left;
      font-weight: 700;
      font-size: 11px;
      color: #64748b;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      border-bottom: 2px solid #e2e8f0;
      cursor: pointer;
      user-select: none;
    }

    .data-table th:hover {
      background: #f1f5f9;
    }

    .data-table td {
      padding: 14px;
      font-feature-settings: 'tnum';
      border-bottom: 1px solid #f1f5f9;
    }

    .data-table tbody tr {
      transition: background 0.15s;
    }

    .data-table tbody tr:hover {
      background: #f8fafc;
    }

    /* Badges */
    .badge {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: inline-block;
      white-space: nowrap;
    }

    .badge-region-us {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #eff6ff;
      color: #1e40af;
    }

    .badge-region-eu {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #f0fdf4;
      color: #166534;
    }

    .badge-esp-sendgrid {
      background: linear-gradient(135deg, #1A82E2, #1565C0);
      color: #fff;
    }

    .badge-esp-sparkpost {
      background: linear-gradient(135deg, #FF6600, #E65100);
      color: #fff;
    }

    .badge-esp-mailgun {
      background: linear-gradient(135deg, #D4463B, #B71C1C);
      color: #fff;
    }

    /* Progress Ring */
    .progress-ring-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress-value {
      font-weight: 700;
    }

    .progress-value-excellent { color: var(--color-green); }
    .progress-value-good { color: var(--color-yellow); }
    .progress-value-poor { color: var(--color-red); }

    /* Domain Link */
    .domain-link {
      font-weight: 600;
      color: #1e40af;
      cursor: pointer;
      text-decoration: none;
    }

    .domain-link:hover {
      text-decoration: underline;
    }

    /* Loading State */
    .loading-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Utility Classes */
    .text-mono {
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }

    .text-center {
      text-align: center;
    }

    /* Row Colors Based on Classification */
    .row-healthy {
      background: linear-gradient(90deg, rgba(220, 252, 231, 0.3) 0%, rgba(255, 255, 255, 0) 100%) !important;
    }

    .row-monitor {
      background: linear-gradient(90deg, rgba(254, 243, 199, 0.3) 0%, rgba(255, 255, 255, 0) 100%) !important;
    }

    .row-low {
      background: linear-gradient(90deg, rgba(255, 237, 213, 0.3) 0%, rgba(255, 255, 255, 0) 100%) !important;
    }

    .row-critical {
      background: linear-gradient(90deg, rgba(254, 226, 226, 0.3) 0%, rgba(255, 255, 255, 0) 100%) !important;
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 500px;
      pointer-events: auto;
      animation: slideIn 0.3s ease;
      border-left: 4px solid;
    }

    .toast.toast-success {
      border-left-color: #10b981;
    }

    .toast.toast-error {
      border-left-color: #ef4444;
    }

    .toast.toast-info {
      border-left-color: #3b82f6;
    }

    .toast.toast-warning {
      border-left-color: #f59e0b;
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 14px;
      color: #1e293b;
      margin: 0 0 4px;
    }

    .toast-message {
      font-size: 13px;
      color: #64748b;
      margin: 0;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.hiding {
      animation: slideOut 0.3s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeInUp {
      from {
        transform: translateY(10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Chart Containers */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 24px;
    }

    .chart-container {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
    }

    .chart-container h4 {
      font-size: 14px;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 18px;
      color: #1e293b;
      margin-bottom: 8px;
    }

    /* Select Dropdown */
    select.date-input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 90vw;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 24px 28px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: white;
      border-radius: 8px;
      font-size: 24px;
      color: #64748b;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .modal-close:hover {
      background: #fee2e2;
      color: #dc2626;
      transform: scale(1.05);
    }

    .modal-body {
      padding: 24px 28px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 20px 28px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: #f8fafc;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: #475569;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f1f5f9;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .chart-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 64px;
      }

      .sidebar-logo-text,
      .nav-item-text,
      .nav-item-indicator {
        display: none;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Toast Container -->
    <div class="toast-container">
      <div
        v-for="(toast, index) in toasts"
        :key="toast.id"
        :class="['toast', `toast-${toast.type}`, { hiding: toast.hiding }]"
      >
        <div class="toast-icon">{{ toast.icon }}</div>
        <div class="toast-content">
          <div class="toast-title">{{ toast.title }}</div>
          <div class="toast-message">{{ toast.message }}</div>
        </div>
      </div>
    </div>

    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar" :class="{ collapsed: sidebarCollapsed }">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <div class="sidebar-logo-icon">
              <span>B</span>
            </div>
            <div class="sidebar-logo-text">
              <p>Blueshift</p>
              <p>Observatory</p>
            </div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <button
            v-for="page in pages"
            :key="page.key"
            class="nav-item"
            :class="{ active: activePage === page.key }"
            @click="activePage = page.key"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" v-html="page.icon"></svg>
            <span class="nav-item-text">{{ page.label }}</span>
            <span v-if="activePage === page.key" class="nav-item-indicator"></span>
          </button>
        </nav>

        <div class="sidebar-footer">
          <button class="collapse-btn" @click="sidebarCollapsed = !sidebarCollapsed">
            {{ sidebarCollapsed ? '‚Üí' : '‚Üê Collapse' }}
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Pulsation Page -->
        <div v-if="activePage === 'pulsation'">
          <!-- Page Header -->
          <div class="page-header">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content">
              <div class="page-header-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
              </div>
              <div>
                <h1 class="page-header-title">Pulsation ‚Äî Deliverability Health Monitor</h1>
                <p class="page-header-subtitle">Real-time monitoring of domain health with historical trends and intelligent risk classification</p>
              </div>
            </div>
          </div>

          <!-- Control Panel -->
          <div class="control-panel">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üìÖ Time Period:</label>
              <select class="date-input" v-model="pulsationViewType" :disabled="pulsationLoading">
                <option value="yesterday">Yesterday</option>
                <option value="7day">Last 7 Days</option>
                <option value="30day">Last 30 Days</option>
              </select>
            </div>

            <button class="btn btn-primary" @click="fetchPulsationData" :disabled="pulsationLoading">
              <span v-if="pulsationLoading">‚è≥</span>
              <span v-else>üîÑ</span>
              {{ pulsationLoading ? 'Loading...' : 'Load Data' }}
            </button>

            <button class="btn btn-secondary" @click="collectYesterdayData" :disabled="pulsationLoading">
              üì• Collect Yesterday
            </button>

            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
              <input type="date" class="date-input" v-model="pulsationCustomCollectDate" :disabled="pulsationLoading" />
              <button class="btn btn-secondary" @click="collectCustomDate" :disabled="pulsationLoading">
                Collect Custom Date
              </button>
            </div>
          </div>

          <!-- Stats Grid -->
          <div v-if="pulsationData" class="stats-grid">
            <div
              class="stat-card stat-card-healthy"
              :class="{ 'active-filter': activeClassificationFilter === 'Green (Healthy)' }"
              v-if="pulsationData.classification_counts['Green (Healthy)']"
              @click="toggleClassificationFilter('Green (Healthy)')"
            >
              <div class="stat-card-icon-badge">‚úì</div>
              <p class="stat-card-label">HEALTHY DOMAINS</p>
              <p class="stat-card-value">{{ formatAnimatedNumber(animatedCounts.healthy) }}</p>
              <p class="stat-card-subtitle">Excellent Performance</p>
            </div>

            <div
              class="stat-card stat-card-monitor"
              :class="{ 'active-filter': activeClassificationFilter === 'Yellow (Monitor)' }"
              v-if="pulsationData.classification_counts['Yellow (Monitor)']"
              @click="toggleClassificationFilter('Yellow (Monitor)')"
            >
              <div class="stat-card-icon-badge">‚ö†</div>
              <p class="stat-card-label">MONITOR REQUIRED</p>
              <p class="stat-card-value">{{ formatAnimatedNumber(animatedCounts.monitor) }}</p>
              <p class="stat-card-subtitle">Needs Attention</p>
            </div>

            <div
              class="stat-card stat-card-low"
              :class="{ 'active-filter': activeClassificationFilter === 'Orange (Low Delivery)' }"
              v-if="pulsationData.classification_counts['Orange (Low Delivery)']"
              @click="toggleClassificationFilter('Orange (Low Delivery)')"
            >
              <div class="stat-card-icon-badge">!</div>
              <p class="stat-card-label">LOW DELIVERY</p>
              <p class="stat-card-value">{{ formatAnimatedNumber(animatedCounts.low) }}</p>
              <p class="stat-card-subtitle">Action Required</p>
            </div>

            <div
              class="stat-card stat-card-critical"
              :class="{ 'active-filter': activeClassificationFilter === 'Red (High Spam Complaints)' }"
              v-if="pulsationData.classification_counts['Red (High Spam Complaints)']"
              @click="toggleClassificationFilter('Red (High Spam Complaints)')"
            >
              <div class="stat-card-icon-badge">‚úï</div>
              <p class="stat-card-label">HIGH SPAM RISK</p>
              <p class="stat-card-value">{{ formatAnimatedNumber(animatedCounts.critical) }}</p>
              <p class="stat-card-subtitle">Critical Issue</p>
            </div>
          </div>

          <!-- Tabs -->
          <div v-if="pulsationData" class="tabs">
            <button class="tab" :class="{ active: pulsationTab === 'overall' }" @click="pulsationTab = 'overall'">
              Overall
            </button>
            <button class="tab" :class="{ active: pulsationTab === 'low_delivery' }" @click="pulsationTab = 'low_delivery'">
              Top 20 Low Delivery
            </button>
            <button class="tab" :class="{ active: pulsationTab === 'spam' }" @click="pulsationTab = 'spam'">
              Top 20 Spam
            </button>
            <button class="tab" :class="{ active: pulsationTab === 'bounce' }" @click="pulsationTab = 'bounce'">
              Top 20 Bounce
            </button>
            <button class="tab" :class="{ active: pulsationTab === 'risk' }" @click="pulsationTab = 'risk'">
              Top 20 Risk
            </button>
            <button class="tab" :class="{ active: pulsationTab === 'charts' }" @click="pulsationTab = 'charts'">
              Trend
            </button>
          </div>

          <!-- Overall Tab -->
          <div v-if="pulsationData && pulsationTab === 'overall'" class="card-section">
            <div class="card-header">
              <h3 class="card-title">Overall <span style="color: #94a3b8; font-weight: 400;">(Sent > 0)</span></h3>
              <span class="card-meta">{{ filteredOverallData.length }} domains</span>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th @click="sortTable('Region')">Region</th>
                    <th @click="sortTable('From_domain')">Domain</th>
                    <th @click="sortTable('ESP')">ESP</th>
                    <th @click="sortTable('Sent')">Sent</th>
                    <th @click="sortTable('Delivered')">Delivered</th>
                    <th @click="sortTable('delivery_rate')">Delivery %</th>
                    <th @click="sortTable('soft_bounce_pct')">Soft Bounce %</th>
                    <th @click="sortTable('Spam_report')">Spam</th>
                    <th @click="sortTable('spam_rate')">Spam %</th>
                    <th @click="sortTable('bounce_rate')">Bounce %</th>
                    <th @click="sortTable('risk_score')">Risk Score</th>
                    <th @click="sortTable('classification')">Classification</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, idx) in filteredOverallData" :key="idx" :class="getRowClass(row.classification)">
                    <td>
                      <span class="badge" :class="row.Region === 'US' ? 'badge-region-us' : 'badge-region-eu'">
                        {{ row.Region === 'US' ? 'üá∫üá∏' : 'üá™üá∫' }} {{ row.Region }}
                      </span>
                    </td>
                    <td>
                      <span class="domain-link" @click="viewDomainCharts(row.From_domain)">{{ row.From_domain }}</span>
                    </td>
                    <td>
                      <span class="badge" :class="getESPBadgeClass(row.ESP)">{{ row.ESP }}</span>
                    </td>
                    <td class="text-mono">{{ formatNumber(row.Sent) }}</td>
                    <td class="text-mono">{{ formatNumber(row.Delivered) }}</td>
                    <td>
                      <div class="progress-ring-wrapper">
                        <svg width="30" height="30" style="transform: rotate(-90deg)">
                          <circle cx="15" cy="15" r="12" fill="none" stroke="#e5e7eb" stroke-width="3" />
                          <circle
                            cx="15"
                            cy="15"
                            r="12"
                            fill="none"
                            :stroke="getProgressColor(row.delivery_rate)"
                            stroke-width="3"
                            :stroke-dasharray="75.4"
                            :stroke-dashoffset="75.4 - (row.delivery_rate / 100) * 75.4"
                            stroke-linecap="round"
                            style="transition: stroke-dashoffset 0.8s ease"
                          />
                        </svg>
                        <span class="progress-value" :class="getProgressClass(row.delivery_rate)">
                          {{ formatRate(row.delivery_rate) }}%
                        </span>
                      </div>
                    </td>
                    <td class="text-mono">{{ formatRate(row.soft_bounce_pct) }}%</td>
                    <td class="text-mono">{{ formatNumber(row.Spam_report) }}</td>
                    <td class="text-mono">{{ formatRate(row.spam_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.bounce_rate) }}%</td>
                    <td class="text-mono">{{ formatRiskScore(row.risk_score) }}</td>
                    <td><span class="badge">{{ row.classification }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Low Delivery Tab -->
          <div v-if="pulsationData && pulsationTab === 'low_delivery'" class="card-section">
            <div class="card-header">
              <h3 class="card-title">Top 20 ‚Äî Lowest Delivery %</h3>
              <span class="card-meta">{{ filteredLowDeliveryData.length }} domains</span>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th @click="sortTable('Region')">Region</th>
                    <th @click="sortTable('From_domain')">Domain</th>
                    <th @click="sortTable('ESP')">ESP</th>
                    <th @click="sortTable('Sent')">Sent</th>
                    <th @click="sortTable('Delivered')">Delivered</th>
                    <th @click="sortTable('delivery_rate')">Delivery %</th>
                    <th @click="sortTable('soft_bounce_pct')">Soft Bounce %</th>
                    <th @click="sortTable('Spam_report')">Spam</th>
                    <th @click="sortTable('spam_rate')">Spam %</th>
                    <th @click="sortTable('bounce_rate')">Bounce %</th>
                    <th @click="sortTable('risk_score')">Risk Score</th>
                    <th @click="sortTable('classification')">Classification</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, idx) in filteredLowDeliveryData" :key="idx" :class="getRowClass(row.classification)">
                    <td><span class="badge" :class="row.Region === 'US' ? 'badge-region-us' : 'badge-region-eu'">{{ row.Region === 'US' ? 'üá∫üá∏' : 'üá™üá∫' }} {{ row.Region }}</span></td>
                    <td><span class="domain-link" @click="viewDomainCharts(row.From_domain)">{{ row.From_domain }}</span></td>
                    <td><span class="badge" :class="getESPBadgeClass(row.ESP)">{{ row.ESP }}</span></td>
                    <td class="text-mono">{{ formatNumber(row.Sent) }}</td>
                    <td class="text-mono">{{ formatNumber(row.Delivered) }}</td>
                    <td class="text-mono">{{ formatRate(row.delivery_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.soft_bounce_pct) }}%</td>
                    <td class="text-mono">{{ formatNumber(row.Spam_report) }}</td>
                    <td class="text-mono">{{ formatRate(row.spam_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.bounce_rate) }}%</td>
                    <td class="text-mono">{{ formatRiskScore(row.risk_score) }}</td>
                    <td><span class="badge">{{ row.classification }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Spam Tab -->
          <div v-if="pulsationData && pulsationTab === 'spam'" class="card-section">
            <div class="card-header">
              <h3 class="card-title">Top 20 ‚Äî Highest Spam %</h3>
              <span class="card-meta">{{ filteredSpamData.length }} domains</span>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th @click="sortTable('Region')">Region</th>
                    <th @click="sortTable('From_domain')">Domain</th>
                    <th @click="sortTable('ESP')">ESP</th>
                    <th @click="sortTable('Sent')">Sent</th>
                    <th @click="sortTable('Delivered')">Delivered</th>
                    <th @click="sortTable('delivery_rate')">Delivery %</th>
                    <th @click="sortTable('soft_bounce_pct')">Soft Bounce %</th>
                    <th @click="sortTable('Spam_report')">Spam</th>
                    <th @click="sortTable('spam_rate')">Spam %</th>
                    <th @click="sortTable('bounce_rate')">Bounce %</th>
                    <th @click="sortTable('risk_score')">Risk Score</th>
                    <th @click="sortTable('classification')">Classification</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, idx) in filteredSpamData" :key="idx" :class="getRowClass(row.classification)">
                    <td><span class="badge" :class="row.Region === 'US' ? 'badge-region-us' : 'badge-region-eu'">{{ row.Region === 'US' ? 'üá∫üá∏' : 'üá™üá∫' }} {{ row.Region }}</span></td>
                    <td><span class="domain-link" @click="viewDomainCharts(row.From_domain)">{{ row.From_domain }}</span></td>
                    <td><span class="badge" :class="getESPBadgeClass(row.ESP)">{{ row.ESP }}</span></td>
                    <td class="text-mono">{{ formatNumber(row.Sent) }}</td>
                    <td class="text-mono">{{ formatNumber(row.Delivered) }}</td>
                    <td class="text-mono">{{ formatRate(row.delivery_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.soft_bounce_pct) }}%</td>
                    <td class="text-mono">{{ formatNumber(row.Spam_report) }}</td>
                    <td class="text-mono">{{ formatRate(row.spam_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.bounce_rate) }}%</td>
                    <td class="text-mono">{{ formatRiskScore(row.risk_score) }}</td>
                    <td><span class="badge">{{ row.classification }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Bounce Tab -->
          <div v-if="pulsationData && pulsationTab === 'bounce'" class="card-section">
            <div class="card-header">
              <h3 class="card-title">Top 20 ‚Äî Highest Bounce %</h3>
              <span class="card-meta">{{ filteredBounceData.length }} domains</span>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th @click="sortTable('Region')">Region</th>
                    <th @click="sortTable('From_domain')">Domain</th>
                    <th @click="sortTable('ESP')">ESP</th>
                    <th @click="sortTable('Sent')">Sent</th>
                    <th @click="sortTable('Delivered')">Delivered</th>
                    <th @click="sortTable('delivery_rate')">Delivery %</th>
                    <th @click="sortTable('soft_bounce_pct')">Soft Bounce %</th>
                    <th @click="sortTable('Spam_report')">Spam</th>
                    <th @click="sortTable('spam_rate')">Spam %</th>
                    <th @click="sortTable('bounce_rate')">Bounce %</th>
                    <th @click="sortTable('risk_score')">Risk Score</th>
                    <th @click="sortTable('classification')">Classification</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, idx) in filteredBounceData" :key="idx" :class="getRowClass(row.classification)">
                    <td><span class="badge" :class="row.Region === 'US' ? 'badge-region-us' : 'badge-region-eu'">{{ row.Region === 'US' ? 'üá∫üá∏' : 'üá™üá∫' }} {{ row.Region }}</span></td>
                    <td><span class="domain-link" @click="viewDomainCharts(row.From_domain)">{{ row.From_domain }}</span></td>
                    <td><span class="badge" :class="getESPBadgeClass(row.ESP)">{{ row.ESP }}</span></td>
                    <td class="text-mono">{{ formatNumber(row.Sent) }}</td>
                    <td class="text-mono">{{ formatNumber(row.Delivered) }}</td>
                    <td class="text-mono">{{ formatRate(row.delivery_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.soft_bounce_pct) }}%</td>
                    <td class="text-mono">{{ formatNumber(row.Spam_report) }}</td>
                    <td class="text-mono">{{ formatRate(row.spam_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.bounce_rate) }}%</td>
                    <td class="text-mono">{{ formatRiskScore(row.risk_score) }}</td>
                    <td><span class="badge">{{ row.classification }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Risk Tab -->
          <div v-if="pulsationData && pulsationTab === 'risk'" class="card-section">
            <div class="card-header">
              <h3 class="card-title">Top 20 ‚Äî Composite Risk Score</h3>
              <span class="card-meta">{{ filteredRiskData.length }} domains</span>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th @click="sortTable('Region')">Region</th>
                    <th @click="sortTable('From_domain')">Domain</th>
                    <th @click="sortTable('ESP')">ESP</th>
                    <th @click="sortTable('Sent')">Sent</th>
                    <th @click="sortTable('Delivered')">Delivered</th>
                    <th @click="sortTable('delivery_rate')">Delivery %</th>
                    <th @click="sortTable('soft_bounce_pct')">Soft Bounce %</th>
                    <th @click="sortTable('Spam_report')">Spam</th>
                    <th @click="sortTable('spam_rate')">Spam %</th>
                    <th @click="sortTable('bounce_rate')">Bounce %</th>
                    <th @click="sortTable('risk_score')">Risk Score</th>
                    <th @click="sortTable('classification')">Classification</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, idx) in filteredRiskData" :key="idx" :class="getRowClass(row.classification)">
                    <td><span class="badge" :class="row.Region === 'US' ? 'badge-region-us' : 'badge-region-eu'">{{ row.Region === 'US' ? 'üá∫üá∏' : 'üá™üá∫' }} {{ row.Region }}</span></td>
                    <td><span class="domain-link" @click="viewDomainCharts(row.From_domain)">{{ row.From_domain }}</span></td>
                    <td><span class="badge" :class="getESPBadgeClass(row.ESP)">{{ row.ESP }}</span></td>
                    <td class="text-mono">{{ formatNumber(row.Sent) }}</td>
                    <td class="text-mono">{{ formatNumber(row.Delivered) }}</td>
                    <td class="text-mono">{{ formatRate(row.delivery_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.soft_bounce_pct) }}%</td>
                    <td class="text-mono">{{ formatNumber(row.Spam_report) }}</td>
                    <td class="text-mono">{{ formatRate(row.spam_rate) }}%</td>
                    <td class="text-mono">{{ formatRate(row.bounce_rate) }}%</td>
                    <td class="text-mono">{{ formatRiskScore(row.risk_score) }}</td>
                    <td><span class="badge">{{ row.classification }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Charts Tab -->
          <div v-if="pulsationData && pulsationTab === 'charts'" class="card-section">
            <div class="card-header">
              <h3 class="card-title">Trends by Domain</h3>
            </div>
            <div style="padding: 24px;">
              <div style="display: grid; grid-template-columns: 1fr 200px; gap: 16px; margin-bottom: 24px;">
                <div>
                  <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;">Select Domain:</label>
                  <select class="date-input" v-model="selectedDomain" @change="loadDomainCharts" style="width: 100%;">
                    <option value="">-- Select a domain --</option>
                    <option v-for="domain in pulsationData.all_domains" :key="domain" :value="domain">
                      {{ domain }}
                    </option>
                  </select>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;">Time Period:</label>
                  <select class="date-input" v-model="chartDays" @change="loadDomainCharts" :disabled="!selectedDomain" style="width: 100%;">
                    <option :value="7">Last 7 Days</option>
                    <option :value="30">Last 30 Days</option>
                    <option :value="60">Last 60 Days</option>
                    <option :value="90">Last 90 Days</option>
                    <option :value="180">Last 180 Days</option>
                    <option :value="365">Last 365 Days</option>
                  </select>
                </div>
              </div>

              <div v-if="!selectedDomain" class="empty-state">
                <div class="empty-state-icon">üìà</div>
                <div class="empty-state-text">Please select a domain to view trends</div>
              </div>

              <div v-if="selectedDomain && chartData" class="chart-grid">
                <div class="chart-container">
                  <h4>Sent Volume</h4>
                  <canvas ref="chartSent"></canvas>
                </div>
                <div class="chart-container">
                  <h4>Delivered Volume</h4>
                  <canvas ref="chartDelivered"></canvas>
                </div>
                <div class="chart-container">
                  <h4>Delivery Rate (%)</h4>
                  <canvas ref="chartDeliveryRate"></canvas>
                </div>
                <div class="chart-container">
                  <h4>Spam Rate (%)</h4>
                  <canvas ref="chartSpamRate"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-if="!pulsationData" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px;">No Data Loaded</h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 24px;">Click "Load Data" to fetch pulsation metrics</p>
          </div>
        </div>

        <!-- MBR Deliverability Page -->
        <div v-if="activePage === 'mbr'">
          <!-- Page Header -->
          <div class="page-header">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content">
              <div class="page-header-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <path d="M3 3v18h18"/>
                  <path d="M18 17V9"/>
                  <path d="M13 17V5"/>
                  <path d="M8 17v-3"/>
                </svg>
              </div>
              <div>
                <h1 class="page-header-title">MBR Deliverability Report</h1>
                <p class="page-header-subtitle">View email deliverability metrics by ESP (SparkPost, SendGrid, Mailgun)</p>
              </div>
            </div>
          </div>

          <!-- View Mode Toggle -->
          <div style="display: flex; gap: 12px; margin-bottom: 24px; padding: 4px; background: #f1f5f9; border-radius: 12px; width: fit-content;">
            <button
              class="btn"
              :class="mbrViewMode === 'domain' ? 'btn-primary' : 'btn-secondary'"
              @click="mbrViewMode = 'domain'"
              style="border-radius: 9px;"
            >
              üåç View by Domain
            </button>
            <button
              class="btn"
              :class="mbrViewMode === 'account' ? 'btn-primary' : 'btn-secondary'"
              @click="mbrViewMode = 'account'"
              style="border-radius: 9px;"
            >
              üè¢ View by Account
            </button>
          </div>

          <!-- Control Panel -->
          <div class="control-panel" style="margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üìÖ From Date:</label>
              <input type="date" class="date-input" v-model="fromDate" :disabled="loading" />
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üìÖ To Date:</label>
              <input type="date" class="date-input" v-model="toDate" :disabled="loading" />
            </div>

            <button class="btn btn-primary" @click="fetchMBRData" :disabled="!canFetch">
              <span v-if="loading" class="loading-spinner"></span>
              <span v-else>üîç</span>
              {{ loading ? 'Loading...' : 'Fetch Data' }}
            </button>
          </div>

          <!-- Save Report to DB Button -->
          <div v-if="hasData || hasAccountData" style="margin-bottom: 24px;">
            <div style="display: flex; gap: 12px; align-items: center; padding: 16px 20px; background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px;">
              <button
                class="btn btn-primary"
                @click="saveReportToDB"
                :disabled="savingToDb"
                style="flex-shrink: 0;"
              >
                <span v-if="savingToDb" class="loading-spinner"></span>
                <span v-else>üíæ</span>
                {{ savingToDb ? 'Saving...' : 'Load Data into DB' }}
              </button>
              <span style="color: #1e40af; font-size: 13px; font-weight: 500;">
                ‚Üê Save this {{ mbrViewMode }} report as a timestamped snapshot for historical tracking
              </span>
            </div>
          </div>

          <!-- Export & Email Buttons (Domain View Only) -->
          <div v-if="mbrViewMode === 'domain' && hasData" style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
            <button
              class="btn"
              @click="exportExcel"
              :disabled="exporting"
              style="background: #10b981; color: white; border: none;"
            >
              <span v-if="exporting" class="loading-spinner"></span>
              <span v-else>üìä</span>
              Export to Excel
            </button>

            <button
              class="btn btn-secondary"
              @click="exportPDF"
              :disabled="exporting"
            >
              <span v-if="exporting" class="loading-spinner"></span>
              <span v-else>üìÑ</span>
              Export to PDF
            </button>

            <button
              class="btn btn-primary"
              @click="openSendEmailModal"
              :disabled="sendingEmail"
            >
              <span v-if="sendingEmail" class="loading-spinner"></span>
              <span v-else>üìß</span>
              Send Email
            </button>

            <button
              class="btn btn-secondary"
              @click="openManageRecipientsModal"
              style="margin-left: auto;"
            >
              <span>üë•</span>
              Manage Recipients
            </button>
          </div>

          <!-- Domain View -->
          <div v-if="mbrViewMode === 'domain' && hasData">
            <!-- Executive Summary -->
            <div class="card-section">
              <div class="card-header">
                <h3 class="card-title">Executive Summary <span style="color: #94a3b8; font-weight: 400;">(All ESPs Combined)</span></h3>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Sent</th>
                      <th>Delivered</th>
                      <th>Delivery %</th>
                      <th>Bounces</th>
                      <th>Bounce %</th>
                      <th>Spam</th>
                      <th>Spam %</th>
                      <th>Unsub</th>
                      <th>Unsub %</th>
                      <th>Opens</th>
                      <th>Open %</th>
                      <th>Clicks</th>
                      <th>Click %</th>
                      <th>CTOR %</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="overallSummary">
                      <td class="text-mono">{{ formatNumber(overallSummary.Total_Sent) }}</td>
                      <td class="text-mono">{{ formatNumber(overallSummary.Total_Delivered) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(overallSummary['Delivery_Rate_%'], 'delivery') === 'rate-good' ? '#10b981' : getRateClass(overallSummary['Delivery_Rate_%'], 'delivery') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(overallSummary['Delivery_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(overallSummary.Total_Bounces) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(overallSummary['Bounce_Rate_%'], 'bounce') === 'rate-good' ? '#10b981' : getRateClass(overallSummary['Bounce_Rate_%'], 'bounce') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(overallSummary['Bounce_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(overallSummary.Total_Spam_Reports) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(overallSummary['Spam_Rate_%'], 'spam') === 'rate-good' ? '#10b981' : getRateClass(overallSummary['Spam_Rate_%'], 'spam') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(overallSummary['Spam_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(overallSummary.Total_Unsubscribes) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(overallSummary['Unsub_Rate_%'], 'unsub') === 'rate-good' ? '#10b981' : getRateClass(overallSummary['Unsub_Rate_%'], 'unsub') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(overallSummary['Unsub_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(overallSummary.Total_Unique_Opens) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(overallSummary['Open_Rate_%'], 'open') === 'rate-good' ? '#10b981' : getRateClass(overallSummary['Open_Rate_%'], 'open') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(overallSummary['Open_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(overallSummary.Total_Unique_Clicks) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(overallSummary['Click_Rate_%'], 'click') === 'rate-good' ? '#10b981' : getRateClass(overallSummary['Click_Rate_%'], 'click') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(overallSummary['Click_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatRate(overallSummary['CTOR_%']) }}%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ESP-wise Sections -->
            <div v-for="esp in espList" :key="esp" class="card-section">
              <div class="card-header">
                <h3 class="card-title">
                  <span class="badge" :class="getESPBadgeClass(esp)">{{ esp }}</span>
                  Regional Breakdown
                </h3>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Region</th>
                      <th>Sent</th>
                      <th>MoM Send %</th>
                      <th>Delivered</th>
                      <th>Delivery %</th>
                      <th>Bounces</th>
                      <th>Bounce %</th>
                      <th>Spam</th>
                      <th>Spam %</th>
                      <th>Opens</th>
                      <th>Open %</th>
                      <th>Clicks</th>
                      <th>Click %</th>
                      <th>Health Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="row in getESPRegionData(esp)" :key="row.region" :style="row.isTotal ? 'background: #f8fafc; font-weight: 600;' : ''">
                      <td>
                        <span v-if="row.region === 'US'" class="badge badge-region-us">üá∫üá∏ US</span>
                        <span v-else-if="row.region === 'EU'" class="badge badge-region-eu">üá™üá∫ EU</span>
                        <strong v-else>{{ row.region }}</strong>
                      </td>
                      <td class="text-mono">{{ formatNumber(row.Total_Sent) }}</td>
                      <td class="text-mono" :style="{ color: getMoMClass(row.MoM_Send_Change) === 'mom-increase' ? '#10b981' : getMoMClass(row.MoM_Send_Change) === 'mom-decrease' ? '#ef4444' : '#94a3b8' }">
                        {{ formatMoM(row.MoM_Send_Change) }}
                      </td>
                      <td class="text-mono">{{ formatNumber(row.Total_Delivered) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(row['Delivery_Rate_%'], 'delivery') === 'rate-good' ? '#10b981' : getRateClass(row['Delivery_Rate_%'], 'delivery') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(row['Delivery_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(row.Total_Bounces) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(row['Bounce_Rate_%'], 'bounce') === 'rate-good' ? '#10b981' : getRateClass(row['Bounce_Rate_%'], 'bounce') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(row['Bounce_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(row.Total_Spam_Reports) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(row['Spam_Rate_%'], 'spam') === 'rate-good' ? '#10b981' : getRateClass(row['Spam_Rate_%'], 'spam') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(row['Spam_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(row.Total_Unique_Opens) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(row['Open_Rate_%'], 'open') === 'rate-good' ? '#10b981' : getRateClass(row['Open_Rate_%'], 'open') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(row['Open_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(row.Total_Unique_Clicks) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(row['Click_Rate_%'], 'click') === 'rate-good' ? '#10b981' : getRateClass(row['Click_Rate_%'], 'click') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(row['Click_Rate_%']) }}%
                      </td>
                      <td>
                        <span v-if="row.Health_Score" class="badge" :style="{
                          background: getHealthScoreClass(row.Health_Rating) === 'health-excellent' ? '#dcfce7' :
                                      getHealthScoreClass(row.Health_Rating) === 'health-good' ? '#fef3c7' :
                                      getHealthScoreClass(row.Health_Rating) === 'health-fair' ? '#fed7aa' :
                                      getHealthScoreClass(row.Health_Rating) === 'health-poor' ? '#fecaca' : '#fca5a5',
                          color: getHealthScoreClass(row.Health_Rating) === 'health-excellent' ? '#166534' :
                                 getHealthScoreClass(row.Health_Rating) === 'health-good' ? '#854d0e' :
                                 getHealthScoreClass(row.Health_Rating) === 'health-fair' ? '#9a3412' :
                                 getHealthScoreClass(row.Health_Rating) === 'health-poor' ? '#991b1b' : '#7f1d1d'
                        }">
                          {{ row.Health_Score }} - {{ row.Health_Rating }}
                        </span>
                        <span v-else style="color: #94a3b8;">N/A</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Top 10 Domains for this ESP -->
              <div style="padding: 20px; border-top: 1px solid #f1f5f9;">
                <h4 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">Top 10 Domains by Send Volume</h4>
                <div class="table-wrapper">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Domain</th>
                        <th>Sent</th>
                        <th>MoM Send %</th>
                        <th>Delivered</th>
                        <th>Delivery %</th>
                        <th>Bounces</th>
                        <th>Bounce %</th>
                        <th>Open %</th>
                        <th>Click %</th>
                        <th>CTOR %</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="(domain, idx) in getESPTop10(esp)" :key="idx">
                        <td style="font-weight: 600; color: #1e40af;">{{ domain.From_domain }}</td>
                        <td class="text-mono">{{ formatNumber(domain.Sent) }}</td>
                        <td class="text-mono" :style="{ color: getMoMClass(domain['MoM_Send_Change_%']) === 'mom-increase' ? '#10b981' : getMoMClass(domain['MoM_Send_Change_%']) === 'mom-decrease' ? '#ef4444' : '#94a3b8' }">
                          {{ formatMoM(domain['MoM_Send_Change_%']) }}
                        </td>
                        <td class="text-mono">{{ formatNumber(domain.Delivered) }}</td>
                        <td class="text-mono" :style="{ color: getRateClass(domain['Delivery_Rate_%'], 'delivery') === 'rate-good' ? '#10b981' : getRateClass(domain['Delivery_Rate_%'], 'delivery') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                          {{ formatRate(domain['Delivery_Rate_%']) }}%
                        </td>
                        <td class="text-mono">{{ formatNumber(domain.Bounces) }}</td>
                        <td class="text-mono" :style="{ color: getRateClass(domain['Bounce_Rate_%'], 'bounce') === 'rate-good' ? '#10b981' : getRateClass(domain['Bounce_Rate_%'], 'bounce') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                          {{ formatRate(domain['Bounce_Rate_%']) }}%
                        </td>
                        <td class="text-mono" :style="{ color: getRateClass(domain['Open_Rate_%'], 'open') === 'rate-good' ? '#10b981' : getRateClass(domain['Open_Rate_%'], 'open') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                          {{ formatRate(domain['Open_Rate_%']) }}%
                        </td>
                        <td class="text-mono" :style="{ color: getRateClass(domain['Click_Rate_%'], 'click') === 'rate-good' ? '#10b981' : getRateClass(domain['Click_Rate_%'], 'click') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                          {{ formatRate(domain['Click_Rate_%']) }}%
                        </td>
                        <td class="text-mono">{{ formatRate(domain['CTOR_%']) }}%</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Top 10 Overall -->
            <div v-if="top10Overall.length > 0" class="card-section">
              <div class="card-header">
                <h3 class="card-title">Top 10 Domains Across All ESPs</h3>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Domain</th>
                      <th>ESP</th>
                      <th>Sent</th>
                      <th>MoM Send %</th>
                      <th>Delivered</th>
                      <th>Delivery %</th>
                      <th>Open %</th>
                      <th>Click %</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(domain, idx) in top10Overall" :key="idx">
                      <td style="font-weight: 600; color: #1e40af;">{{ domain.From_domain }}</td>
                      <td><span class="badge" :class="getESPBadgeClass(domain.ESP)">{{ domain.ESP }}</span></td>
                      <td class="text-mono">{{ formatNumber(domain.Sent) }}</td>
                      <td class="text-mono" :style="{ color: getMoMClass(domain['MoM_Send_Change_%']) === 'mom-increase' ? '#10b981' : getMoMClass(domain['MoM_Send_Change_%']) === 'mom-decrease' ? '#ef4444' : '#94a3b8' }">
                        {{ formatMoM(domain['MoM_Send_Change_%']) }}
                      </td>
                      <td class="text-mono">{{ formatNumber(domain.Delivered) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(domain['Delivery_Rate_%'], 'delivery') === 'rate-good' ? '#10b981' : getRateClass(domain['Delivery_Rate_%'], 'delivery') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(domain['Delivery_Rate_%']) }}%
                      </td>
                      <td class="text-mono" :style="{ color: getRateClass(domain['Open_Rate_%'], 'open') === 'rate-good' ? '#10b981' : getRateClass(domain['Open_Rate_%'], 'open') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(domain['Open_Rate_%']) }}%
                      </td>
                      <td class="text-mono" :style="{ color: getRateClass(domain['Click_Rate_%'], 'click') === 'rate-good' ? '#10b981' : getRateClass(domain['Click_Rate_%'], 'click') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(domain['Click_Rate_%']) }}%
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Account View -->
          <div v-if="mbrViewMode === 'account' && hasAccountData">
            <!-- Top 10 Accounts Overall -->
            <div class="card-section">
              <div class="card-header">
                <h3 class="card-title">Top 10 Accounts <span style="color: #94a3b8; font-weight: 400;">(Across All ESPs)</span></h3>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Account Name</th>
                      <th>Sent</th>
                      <th>MoM Send %</th>
                      <th>Delivered</th>
                      <th>Delivery %</th>
                      <th>Bounces</th>
                      <th>Bounce %</th>
                      <th>Spam</th>
                      <th>Spam %</th>
                      <th>Opens</th>
                      <th>Open %</th>
                      <th>Clicks</th>
                      <th>Click %</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="account in topAccountsOverall" :key="account.Rank">
                      <td style="font-weight: 700; color: #1e40af;">{{ account.Rank }}</td>
                      <td style="font-weight: 600;">{{ account.Account }}</td>
                      <td class="text-mono">{{ formatNumber(account.Sent) }}</td>
                      <td class="text-mono" :style="{ color: getMoMClass(account['MoM_Send_Change_%']) === 'mom-increase' ? '#10b981' : getMoMClass(account['MoM_Send_Change_%']) === 'mom-decrease' ? '#ef4444' : '#94a3b8' }">
                        {{ formatMoM(account['MoM_Send_Change_%']) }}
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Delivered) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Delivery_Rate_%'], 'delivery') === 'rate-good' ? '#10b981' : getRateClass(account['Delivery_Rate_%'], 'delivery') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Delivery_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Bounces) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Bounce_Rate_%'], 'bounce') === 'rate-good' ? '#10b981' : getRateClass(account['Bounce_Rate_%'], 'bounce') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Bounce_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Spam_Reports || account.Spam_report) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Spam_Rate_%'], 'spam') === 'rate-good' ? '#10b981' : getRateClass(account['Spam_Rate_%'], 'spam') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Spam_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Total_Unique_Opens) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Open_Rate_%'], 'open') === 'rate-good' ? '#10b981' : getRateClass(account['Open_Rate_%'], 'open') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Open_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.unique_click) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Click_Rate_%'], 'click') === 'rate-good' ? '#10b981' : getRateClass(account['Click_Rate_%'], 'click') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Click_Rate_%']) }}%
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ESP-wise Top 10 Accounts -->
            <div v-for="esp in Object.keys(topAccountsByESP)" :key="esp" class="card-section">
              <div class="card-header">
                <h3 class="card-title">
                  <span class="badge" :class="getESPBadgeClass(esp)">{{ esp }}</span>
                  Top 10 Accounts by Send Volume
                </h3>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Account Name</th>
                      <th>Sent</th>
                      <th>MoM Send %</th>
                      <th>Delivered</th>
                      <th>Delivery %</th>
                      <th>Bounces</th>
                      <th>Bounce %</th>
                      <th>Spam</th>
                      <th>Spam %</th>
                      <th>Opens</th>
                      <th>Open %</th>
                      <th>Clicks</th>
                      <th>Click %</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="account in getESPAccountTop10(esp)" :key="account.Rank">
                      <td style="font-weight: 700; color: #1e40af;">{{ account.Rank }}</td>
                      <td style="font-weight: 600;">{{ account.Account }}</td>
                      <td class="text-mono">{{ formatNumber(account.Sent) }}</td>
                      <td class="text-mono" :style="{ color: getMoMClass(account['MoM_Send_Change_%']) === 'mom-increase' ? '#10b981' : getMoMClass(account['MoM_Send_Change_%']) === 'mom-decrease' ? '#ef4444' : '#94a3b8' }">
                        {{ formatMoM(account['MoM_Send_Change_%']) }}
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Delivered) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Delivery_Rate_%'], 'delivery') === 'rate-good' ? '#10b981' : getRateClass(account['Delivery_Rate_%'], 'delivery') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Delivery_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Bounces) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Bounce_Rate_%'], 'bounce') === 'rate-good' ? '#10b981' : getRateClass(account['Bounce_Rate_%'], 'bounce') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Bounce_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Spam_Reports || account.Spam_report) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Spam_Rate_%'], 'spam') === 'rate-good' ? '#10b981' : getRateClass(account['Spam_Rate_%'], 'spam') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Spam_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Total_Unique_Opens) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Open_Rate_%'], 'open') === 'rate-good' ? '#10b981' : getRateClass(account['Open_Rate_%'], 'open') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Open_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.unique_click) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Click_Rate_%'], 'click') === 'rate-good' ? '#10b981' : getRateClass(account['Click_Rate_%'], 'click') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Click_Rate_%']) }}%
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Affiliate Accounts -->
            <div v-if="affiliateAccounts && affiliateAccounts.length > 0" class="card-section" style="border-left: 4px solid #8b5cf6;">
              <div class="card-header" style="background: linear-gradient(135deg, #faf5ff, #f3e8ff);">
                <h3 class="card-title" style="color: #6b21a8;">
                  ü§ù Affiliate Accounts <span style="color: #a855f7; font-weight: 400;">(IsAffiliate = Yes)</span>
                </h3>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Account Name</th>
                      <th>Sent</th>
                      <th>Delivered</th>
                      <th>Delivery %</th>
                      <th>Bounces</th>
                      <th>Bounce %</th>
                      <th>Spam</th>
                      <th>Spam %</th>
                      <th>Opens</th>
                      <th>Open %</th>
                      <th>Clicks</th>
                      <th>Click %</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="account in affiliateAccounts" :key="account.Rank">
                      <td style="font-weight: 700; color: #7c3aed;">{{ account.Rank }}</td>
                      <td style="font-weight: 600; color: #7c3aed;">{{ account.Account }}</td>
                      <td class="text-mono">{{ formatNumber(account.Sent) }}</td>
                      <td class="text-mono">{{ formatNumber(account.Delivered) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Delivery_Rate_%'], 'delivery') === 'rate-good' ? '#10b981' : getRateClass(account['Delivery_Rate_%'], 'delivery') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Delivery_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Bounces) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Bounce_Rate_%'], 'bounce') === 'rate-good' ? '#10b981' : getRateClass(account['Bounce_Rate_%'], 'bounce') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Bounce_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Spam_Reports || account.Spam_report) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Spam_Rate_%'], 'spam') === 'rate-good' ? '#10b981' : getRateClass(account['Spam_Rate_%'], 'spam') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Spam_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.Total_Unique_Opens) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Open_Rate_%'], 'open') === 'rate-good' ? '#10b981' : getRateClass(account['Open_Rate_%'], 'open') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Open_Rate_%']) }}%
                      </td>
                      <td class="text-mono">{{ formatNumber(account.unique_click) }}</td>
                      <td class="text-mono" :style="{ color: getRateClass(account['Click_Rate_%'], 'click') === 'rate-good' ? '#10b981' : getRateClass(account['Click_Rate_%'], 'click') === 'rate-warning' ? '#f59e0b' : '#ef4444' }">
                        {{ formatRate(account['Click_Rate_%']) }}%
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-if="!hasData && !hasAccountData" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px;">No Data Loaded</h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 24px;">Select a date range and click "Fetch Data" to view deliverability metrics</p>
          </div>

          <!-- Load Saved Reports Section -->
          <div style="margin-top: 32px; padding: 24px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 16px; border: 1px solid #cbd5e1;">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #2563eb, #1d4ed8); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                üíæ
              </div>
              <h3 style="margin: 0; font-size: 20px; color: #1e293b; font-weight: 700;">Load Saved Reports</h3>
              <button
                class="btn btn-secondary"
                @click="fetchSavedReports"
                :disabled="loadingReports"
                style="margin-left: auto; padding: 8px 16px; font-size: 13px;"
              >
                <span v-if="loadingReports" class="loading-spinner"></span>
                <span v-else>üîÑ</span>
                {{ loadingReports ? 'Loading...' : 'Refresh List' }}
              </button>
            </div>

            <!-- Filter Controls -->
            <div v-if="savedReportsList.length > 0" style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 1px solid #e2e8f0;">
              <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                <label style="font-weight: 600; font-size: 13px; color: #475569;">
                  üîç Filter by:
                </label>

                <select v-model.number="filterMonth" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; min-width: 140px;">
                  <option :value="null">All Months</option>
                  <option v-for="month in availableMonths" :key="month" :value="month">
                    {{ getMonthName(month) }}
                  </option>
                </select>

                <select v-model.number="filterYear" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; min-width: 120px;">
                  <option :value="null">All Years</option>
                  <option v-for="year in availableYears" :key="year" :value="year">
                    {{ year }}
                  </option>
                </select>

                <button
                  v-if="filterMonth !== null || filterYear !== null"
                  @click="clearFilters"
                  class="btn btn-secondary"
                  style="padding: 8px 16px; font-size: 12px;"
                >
                  ‚ùå Clear
                </button>

                <span style="margin-left: auto; font-size: 12px; color: #64748b; font-weight: 500;">
                  Showing {{ filteredSavedReports.length }} of {{ savedReportsList.length }} reports
                </span>
              </div>
            </div>

            <!-- Reports Table -->
            <div v-if="filteredSavedReports.length > 0" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0;">
              <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table" style="font-size: 13px;">
                  <thead>
                    <tr>
                      <th style="width: 60px;">ID</th>
                      <th style="width: 100px;">Type</th>
                      <th>Date Range</th>
                      <th style="width: 100px;">Duration</th>
                      <th style="width: 120px;">Domains/Accounts</th>
                      <th style="width: 160px;">Created</th>
                      <th style="width: 180px; text-align: center;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="report in filteredSavedReports" :key="report.id">
                      <td style="font-weight: 700; color: #1e40af;">{{ report.id }}</td>
                      <td>
                        <span class="badge" :style="report.report_type === 'domain' ? 'background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;' : 'background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;'">
                          {{ report.report_type }}
                        </span>
                      </td>
                      <td>
                        <div v-if="report.month && report.year" style="display: flex; align-items: center; gap: 8px;">
                          <span class="badge" style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 11px;">
                            üìÖ {{ formatMonthYear(report.month, report.year) }}
                          </span>
                          <span style="font-size: 11px; color: #64748b;">
                            ({{ report.from_date }} ‚Üí {{ report.to_date }})
                          </span>
                        </div>
                        <span v-else style="font-size: 12px;">
                          {{ report.from_date }} ‚Üí {{ report.to_date }}
                        </span>
                      </td>
                      <td class="text-mono" style="color: #64748b;">{{ report.duration_days }} days</td>
                      <td class="text-mono" style="font-weight: 600; color: #1e293b;">
                        {{ report.report_type === 'domain' ? report.total_domains : report.total_accounts }}
                      </td>
                      <td style="font-size: 12px; color: #64748b;">{{ formatDateTime(report.created_at) }}</td>
                      <td style="text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                          <button
                            class="btn btn-sm btn-primary"
                            @click="loadSavedReport(report.id)"
                            :disabled="loadingReportId === report.id"
                            style="padding: 6px 14px; font-size: 12px;"
                          >
                            <span v-if="loadingReportId === report.id" class="loading-spinner" style="width: 12px; height: 12px;"></span>
                            <span v-else>üì•</span>
                            {{ loadingReportId === report.id ? 'Loading...' : 'Load' }}
                          </button>
                          <button
                            class="btn btn-sm"
                            @click="deleteSavedReport(report.id)"
                            :disabled="deletingReportId === report.id"
                            style="padding: 6px 14px; font-size: 12px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;"
                            title="Delete this report"
                          >
                            <span v-if="deletingReportId === report.id" class="loading-spinner" style="width: 12px; height: 12px;"></span>
                            <span v-else>üóëÔ∏è</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- No Reports Match Filters -->
            <div v-else-if="savedReportsList.length > 0 && filteredSavedReports.length === 0" style="padding: 48px; text-align: center; background: white; border-radius: 12px;">
              <div style="font-size: 40px; margin-bottom: 16px; opacity: 0.5;">üîç</div>
              <p style="margin: 0 0 12px 0; font-weight: 600; color: #475569;">No reports match the selected filters</p>
              <button @click="clearFilters" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                ‚ùå Clear Filters
              </button>
            </div>

            <!-- Empty State -->
            <div v-else-if="!loadingReports" style="padding: 48px; text-align: center; background: white; border-radius: 12px;">
              <div style="font-size: 40px; margin-bottom: 16px; opacity: 0.5;">üì¶</div>
              <p style="margin: 0; color: #64748b;">No saved reports found. Fetch data and save it to database first.</p>
            </div>

            <!-- Loading State -->
            <div v-if="loadingReports" style="padding: 48px; text-align: center; background: white; border-radius: 12px;">
              <span class="loading-spinner"></span>
              <p style="margin-top: 16px; color: #64748b;">Loading saved reports...</p>
            </div>
          </div>
        </div>

        <!-- Account Mappings Page -->
        <div v-if="activePage === 'mappings'">
          <!-- Page Header -->
          <div class="page-header">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content">
              <div class="page-header-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
              </div>
              <div>
                <h1 class="page-header-title">Account Mappings Management</h1>
                <p class="page-header-subtitle">Manage domain-to-account mappings for consolidated reporting</p>
              </div>
            </div>
          </div>

          <!-- Stats Cards -->
          <div v-if="accountStats" class="stats-grid" style="margin-bottom: 32px; grid-template-columns: repeat(6, 1fr);">
            <div class="stat-card" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                üîó
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Total Mappings</div>
                <div class="stat-card-value">{{ animatedMappingCounts.totalMappings }}</div>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                üè¢
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Total Accounts</div>
                <div class="stat-card-value">{{ animatedMappingCounts.totalAccounts }}</div>
              </div>
            </div>
          </div>

          <!-- Control Panel -->
          <div class="control-panel" style="margin-bottom: 24px;">
            <div style="flex: 1; max-width: 400px;">
              <input
                type="text"
                class="date-input"
                v-model="accountSearchQuery"
                @input="searchAccountMappings"
                placeholder="üîç Search domain or account..."
                style="width: 100%;"
              />
            </div>

            <div style="display: flex; gap: 12px;">
              <button class="btn btn-primary" @click="showAddMappingModal = true">
                ‚ûï Add Mapping
              </button>
              <button class="btn btn-secondary" @click="importCSV">
                üì• Import CSV
              </button>
              <button class="btn btn-secondary" @click="exportCSV">
                üì§ Export CSV
              </button>
              <button class="btn btn-secondary" @click="loadAccountMappings">
                üîÑ Refresh
              </button>
            </div>
          </div>

          <!-- Mappings Table -->
          <div class="card-section">
            <div class="card-header">
              <h3 class="card-title">Domain-Account Mappings</h3>
              <span class="card-meta">{{ accountMappings.length }} of {{ accountMappingsTotal }} mappings</span>
            </div>

            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="width: 80px;">ID</th>
                    <th>Sending Domain</th>
                    <th>Account Name</th>
                    <th style="width: 120px;">IsAffiliate</th>
                    <th>Notes</th>
                    <th style="width: 140px;">Created</th>
                    <th style="width: 200px; text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-if="accountMappingsLoading">
                    <td colspan="7" style="text-align: center; padding: 48px;">
                      <span class="loading-spinner"></span>
                      <p style="margin-top: 16px; color: #64748b;">Loading mappings...</p>
                    </td>
                  </tr>
                  <tr v-else-if="accountMappings.length === 0">
                    <td colspan="7" style="text-align: center; padding: 48px;">
                      <div style="font-size: 40px; margin-bottom: 16px; opacity: 0.5;">üì¶</div>
                      <p style="color: #64748b;">No mappings found</p>
                    </td>
                  </tr>
                  <tr v-else v-for="mapping in accountMappings" :key="mapping.id">
                    <td style="font-weight: 600; color: #64748b;">{{ mapping.id }}</td>
                    <td>
                      <span style="font-weight: 600; color: #1e293b; font-family: monospace;">{{ mapping.sending_domain }}</span>
                    </td>
                    <td style="font-weight: 500; color: #3b82f6;">{{ mapping.account_name }}</td>
                    <td>
                      <span class="badge" :style="mapping.is_affiliate ? 'background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; font-weight: 600;' : 'background: #f1f5f9; color: #64748b;'">
                        {{ mapping.is_affiliate ? '‚úì Yes' : 'No' }}
                      </span>
                    </td>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #64748b;">
                      {{ mapping.notes || '-' }}
                    </td>
                    <td style="font-size: 12px; color: #94a3b8;">
                      {{ formatDate(mapping.created_at) }}
                    </td>
                    <td style="text-align: center; white-space: nowrap;">
                      <button
                        @click="editMapping(mapping)"
                        style="
                          margin-right: 8px;
                          padding: 8px 16px;
                          font-size: 13px;
                          font-weight: 600;
                          background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                          color: #0369a1;
                          border: 1px solid #bae6fd;
                          border-radius: 8px;
                          cursor: pointer;
                          transition: all 0.2s;
                          display: inline-flex;
                          align-items: center;
                          gap: 6px;
                        "
                        onmouseover="this.style.background='linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)';"
                        onmouseout="this.style.background='linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';"
                      >
                        <span style="font-size: 14px;">‚úèÔ∏è</span>
                        <span>Edit</span>
                      </button>
                      <button
                        @click="confirmDeleteMapping(mapping)"
                        style="
                          padding: 8px 16px;
                          font-size: 13px;
                          font-weight: 600;
                          background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                          color: #b91c1c;
                          border: 1px solid #fecaca;
                          border-radius: 8px;
                          cursor: pointer;
                          transition: all 0.2s;
                          display: inline-flex;
                          align-items: center;
                          gap: 6px;
                        "
                        onmouseover="this.style.background='linear-gradient(135deg, #fecaca 0%, #fca5a5 100%)';"
                        onmouseout="this.style.background='linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';"
                      >
                        <span style="font-size: 14px;">üóëÔ∏è</span>
                        <span>Delete</span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Empty State -->
          <div v-if="!accountStats && !accountMappingsLoading" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîó</div>
            <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px;">No Data Loaded</h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 24px;">Click "Refresh" to load account mappings</p>
          </div>
        </div>

        <!-- Account Info Page -->
        <div v-if="activePage === 'info'">
          <!-- Page Header -->
          <div class="page-header">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content">
              <div class="page-header-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <rect x="2" y="3" width="20" height="14" rx="2"/>
                  <path d="M8 21h8"/>
                  <path d="M12 17v4"/>
                </svg>
              </div>
              <div>
                <h1 class="page-header-title">Account Info ‚Äî ESP Integration</h1>
                <p class="page-header-subtitle">Real-time account information from Mailgun, Sparkpost, and Sendgrid</p>
              </div>
            </div>
          </div>

          <!-- Control Panel -->
          <div class="control-panel" style="margin-bottom: 24px;">
            <div v-if="accountInfo" style="font-size: 13px; color: #64748b; display: flex; align-items: center; gap: 16px;">
              <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Last updated: {{ formatDateTime(accountInfo.last_updated) }}
              </span>
              <span v-if="accountInfo.cached" style="background: #f0f9ff; padding: 4px 10px; border-radius: 6px; color: #0369a1; font-weight: 500;">
                üì¶ Cached (expires in {{ Math.floor(accountInfo.cache_expires_in / 60) }}m)
              </span>
            </div>

            <div style="display: flex; gap: 12px; margin-left: auto;">
              <button
                v-if="accountInfo"
                class="btn btn-secondary"
                @click="clearAccountInfoFilters"
              >
                üîÑ Clear Filters
              </button>

              <button
                class="btn btn-primary"
                @click="fetchAccountInfo(false)"
                :disabled="accountInfoLoading"
              >
                <span v-if="accountInfoLoading" class="loading-spinner" style="width: 14px; height: 14px;"></span>
                <span v-else>üîÑ</span>
                {{ accountInfoLoading ? 'Loading...' : 'Refresh' }}
              </button>

              <button
                class="btn btn-secondary"
                @click="clearAccountInfoCache"
                :disabled="accountInfoLoading"
              >
                üóëÔ∏è Clear Cache
              </button>
            </div>
          </div>

          <!-- API Warnings -->
          <div v-if="accountInfo && (accountInfo.errors.mailgun || accountInfo.errors.sparkpost || accountInfo.errors.sendgrid)" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #fbbf24; border-radius: 12px; padding: 16px 20px; margin-bottom: 24px;">
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: 20px;">‚ö†Ô∏è</span>
              <div style="flex: 1;">
                <strong style="color: #92400e; font-size: 14px; display: block; margin-bottom: 8px;">API Warnings:</strong>
                <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 13px;">
                  <li v-if="accountInfo.errors.mailgun">Mailgun: {{ accountInfo.errors.mailgun }}</li>
                  <li v-if="accountInfo.errors.sparkpost">Sparkpost: {{ accountInfo.errors.sparkpost }}</li>
                  <li v-if="accountInfo.errors.sendgrid">Sendgrid: {{ accountInfo.errors.sendgrid }}</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div v-if="accountInfoLoading && !accountInfo" style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
            <span class="loading-spinner" style="width: 40px; height: 40px;"></span>
            <p style="margin-top: 20px; color: #64748b; font-size: 14px;">Fetching data from ESPs...</p>
          </div>

          <!-- Data Table -->
          <div v-if="accountInfo && accountInfo.data && accountInfo.data.length > 0" class="card-section">
            <div class="card-header">
              <h3 class="card-title">ESP Account Information</h3>
              <span class="card-meta">{{ filteredAccountInfo.length }} of {{ accountInfo.total_records }} records</span>
            </div>

            <div class="table-wrapper" style="max-height: 600px; overflow-y: auto;">
              <table class="data-table" style="font-size: 12px;">
                <thead style="position: sticky; top: 0; z-index: 10; background: #f8fafc;">
                  <tr>
                    <th style="padding: 8px 10px;">ESP</th>
                    <th style="padding: 8px 10px;">Region</th>
                    <th style="padding: 8px 10px;">Domain</th>
                    <th style="padding: 8px 10px;">Account Name</th>
                    <th style="padding: 8px 10px;">IP Address</th>
                    <th style="padding: 8px 10px;">Subaccount/Subuser</th>
                    <th style="padding: 8px 10px;">IP Pool</th>
                    <th style="padding: 8px 10px;">Status</th>
                    <th style="padding: 8px 10px;">Verified</th>
                    <th style="padding: 8px 10px;">Created Date</th>
                  </tr>
                  <!-- Filter Row -->
                  <tr style="background: #f1f5f9;">
                    <th style="padding: 4px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.esp"
                        placeholder="Filter..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.region"
                        placeholder="Filter..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.domain"
                        placeholder="Filter domain..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.account_name"
                        placeholder="Filter account..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.ip_addresses"
                        placeholder="Filter IP..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.subaccount"
                        placeholder="Filter..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.ip_pool"
                        placeholder="Filter..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.status"
                        placeholder="Filter..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.verified"
                        placeholder="yes/no"
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                    <th style="padding: 6px 8px;">
                      <input
                        type="text"
                        class="date-input"
                        v-model="accountInfoFilters.created_at"
                        placeholder="Filter..."
                        style="width: 100%; padding: 4px 8px; font-size: 12px; height: 32px;"
                      />
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(item, index) in filteredAccountInfo" :key="index">
                    <td style="padding: 6px 10px;">
                      <span class="badge" :style="
                        item.esp === 'Mailgun' ? 'background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; font-size: 11px; padding: 3px 8px;' :
                        item.esp === 'Sparkpost' ? 'background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412; font-size: 11px; padding: 3px 8px;' :
                        'background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; font-size: 11px; padding: 3px 8px;'
                      ">
                        {{ item.esp }}
                      </span>
                    </td>
                    <td style="padding: 6px 10px;">
                      <span v-if="item.region !== 'N/A'" class="badge" :class="item.region === 'US' ? 'badge-region-us' : 'badge-region-eu'" style="font-size: 11px; padding: 3px 8px;">
                        {{ item.region === 'US' ? 'üá∫üá∏' : 'üá™üá∫' }} {{ item.region }}
                      </span>
                      <span v-else style="color: #cbd5e1;">-</span>
                    </td>
                    <td style="padding: 6px 10px; font-weight: 500; font-family: monospace; color: #1e293b;">{{ item.domain }}</td>
                    <td style="padding: 6px 10px;">
                      <span v-if="item.account_name !== 'Unmapped'" style="font-weight: 500; color: #3b82f6;">
                        {{ item.account_name }}
                      </span>
                      <span v-else style="color: #cbd5e1; font-style: italic;">
                        Unmapped
                      </span>
                    </td>
                    <td style="padding: 6px 10px; font-size: 11px; font-family: monospace; color: #64748b;">
                      {{ item.ip_addresses }}
                    </td>
                    <td style="padding: 6px 10px; font-size: 11px; color: #64748b;">{{ item.subaccount }}</td>
                    <td style="padding: 6px 10px; font-size: 11px; color: #64748b;">{{ item.ip_pool }}</td>
                    <td style="padding: 6px 10px;">
                      <span class="badge" :style="
                        item.status === 'active' || item.status === 'Active' ? 'background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; font-size: 11px; padding: 3px 8px;' :
                        'background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; font-size: 11px; padding: 3px 8px;'
                      ">
                        {{ item.status }}
                      </span>
                    </td>
                    <td style="padding: 6px 10px; text-align: center;">
                      <span v-if="item.verified" style="color: #10b981; font-size: 14px;">‚úì</span>
                      <span v-else style="color: #cbd5e1; font-size: 14px;">‚úó</span>
                    </td>
                    <td style="padding: 6px 10px; font-size: 11px; color: #94a3b8;">{{ item.created_at }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Filter Summary -->
            <div v-if="filteredAccountInfo.length < accountInfo.total_records" style="margin-top: 16px; padding: 12px 16px; background: #f0f9ff; border-radius: 8px; font-size: 13px; color: #0369a1; display: flex; align-items: center; gap: 8px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              <strong>Filtered:</strong> Showing {{ filteredAccountInfo.length }} of {{ accountInfo.total_records }} records
            </div>
          </div>

          <!-- Empty State -->
          <div v-if="!accountInfo && !accountInfoLoading" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px;">No Data Loaded</h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 24px;">Click "Refresh" to fetch ESP account information</p>
          </div>
        </div>

        <!-- SNDS Page -->
        <div v-if="activePage === 'snds'">
          <!-- Page Header -->
          <div class="page-header">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content">
              <div class="page-header-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
              </div>
              <div>
                <h1 class="page-header-title">SNDS Analytics</h1>
                <p class="page-header-subtitle">Microsoft Smart Network Data Services - IP Reputation & Traffic Monitoring</p>
              </div>
            </div>
          </div>

          <!-- Control Panel -->
          <div class="control-panel" style="margin-bottom: 24px; flex-wrap: wrap;">
            <div style="display: flex; gap: 12px; flex-wrap: wrap; flex: 1;">
              <!-- Time Period -->
              <div style="min-width: 150px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;">üìÖ Time Period</label>
                <select class="date-input" v-model="sndsTimePeriod" :disabled="sndsLoading" style="width: 100%;">
                  <option value="yesterday">Yesterday</option>
                  <option value="7day">Last 7 Days</option>
                  <option value="30day">Last 30 Days</option>
                  <option value="60day">Last 60 Days</option>
                  <option value="90day">Last 90 Days</option>
                  <option value="120day">Last 120 Days</option>
                  <option value="1year">Last Year</option>
                </select>
              </div>

              <!-- View By -->
              <div style="min-width: 130px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;">üëÅÔ∏è View By</label>
                <select class="date-input" v-model="sndsViewBy" @change="loadSNDSData" :disabled="sndsLoading" style="width: 100%;">
                  <option value="ip">IP Address</option>
                  <option value="account">Account</option>
                </select>
              </div>

              <!-- Account Filter -->
              <div v-if="sndsViewBy === 'account'" style="min-width: 180px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;">üè¢ Account</label>
                <select class="date-input" v-model="sndsSelectedAccount" :disabled="sndsLoading" style="width: 100%;">
                  <option value="">All Accounts</option>
                  <option v-for="account in sndsAccountsList" :key="account" :value="account">{{ account }}</option>
                </select>
              </div>

              <!-- IP Filter -->
              <div v-if="sndsViewBy === 'ip'" style="min-width: 150px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;">üñ•Ô∏è IP Address</label>
                <select class="date-input" v-model="sndsSelectedIP" :disabled="sndsLoading" style="width: 100%;">
                  <option value="">All IPs</option>
                  <option v-for="ip in sndsIPsList" :key="ip" :value="ip">{{ ip }}</option>
                </select>
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; align-items: flex-end;">
              <button class="btn btn-primary" @click="loadSNDSData" :disabled="sndsLoading">
                <span v-if="sndsLoading" class="loading-spinner" style="width: 14px; height: 14px;"></span>
                <span v-else>üîÑ</span>
                {{ sndsLoading ? 'Loading...' : 'Load Data' }}
              </button>

              <button class="btn btn-secondary" @click="exportSNDSData" :disabled="!sndsData || sndsData.length === 0">
                üì• Export CSV
              </button>
            </div>
          </div>

          <!-- Loading State -->
          <div v-if="sndsLoading && !sndsOverview" style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; margin-bottom: 24px;">
            <span class="loading-spinner" style="width: 40px; height: 40px;"></span>
            <p style="margin-top: 20px; color: #64748b; font-size: 14px;">Loading SNDS data...</p>
          </div>

          <!-- Empty State -->
          <div v-if="!sndsLoading && !sndsOverview" style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üõ°Ô∏è</div>
            <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px;">SNDS Analytics Dashboard</h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 24px;">Click Load Data to view IP reputation and traffic analytics</p>
            <button class="btn btn-primary" @click="loadSNDSData">
              üîÑ Load SNDS Data
            </button>
          </div>

          <!-- Overview Statistics with Animations -->
          <div v-if="sndsOverview" class="stats-grid" style="margin-bottom: 32px; grid-template-columns: repeat(6, 1fr);">
            <div class="stat-card" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                üñ•Ô∏è
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Total IPs</div>
                <div class="stat-card-value">{{ animatedSNDSCounts.totalIPs }}</div>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #a855f7, #9333ea);">
                üè¢
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Accounts</div>
                <div class="stat-card-value">{{ animatedSNDSCounts.totalAccounts }}</div>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #14b8a6, #0d9488);">
                ‚úâÔ∏è
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Total Messages</div>
                <div class="stat-card-value">{{ formatLargeNumber(animatedSNDSCounts.totalMessages) }}</div>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                ‚≠ê
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Avg Reputation</div>
                <div class="stat-card-value">{{ animatedSNDSCounts.avgReputation }}</div>
                <div class="stat-card-trend">{{ sndsOverview.avg_reputation_rating }}</div>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                ‚ö†Ô∏è
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Avg Spam Rate</div>
                <div class="stat-card-value">{{ animatedSNDSCounts.avgSpamRate }}%</div>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
              <div class="stat-card-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                üêõ
              </div>
              <div class="stat-card-content">
                <div class="stat-card-label">Total Trap Hits</div>
                <div class="stat-card-value">{{ animatedSNDSCounts.totalTrapHits }}</div>
              </div>
            </div>
          </div>

          <!-- Filter Distribution -->
          <div v-if="sndsOverview && sndsOverview.filter_distribution" class="card-section" style="margin-bottom: 32px;">
            <div class="card-header">
              <h3 class="card-title">üîç Filter Result Distribution</h3>
            </div>
            <div style="padding: 24px; display: flex; gap: 32px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 150px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <div style="width: 14px; height: 14px; background: #10b981; border-radius: 50%;"></div>
                  <span style="font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase;">GREEN</span>
                </div>
                <div style="font-size: 32px; font-weight: 800; color: #10b981;">
                  {{ animatedSNDSCounts.greenCount }}
                </div>
              </div>
              <div style="flex: 1; min-width: 150px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <div style="width: 14px; height: 14px; background: #f59e0b; border-radius: 50%;"></div>
                  <span style="font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase;">YELLOW</span>
                </div>
                <div style="font-size: 32px; font-weight: 800; color: #f59e0b;">
                  {{ animatedSNDSCounts.yellowCount }}
                </div>
              </div>
              <div style="flex: 1; min-width: 150px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <div style="width: 14px; height: 14px; background: #ef4444; border-radius: 50%;"></div>
                  <span style="font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase;">RED</span>
                </div>
                <div style="font-size: 32px; font-weight: 800; color: #ef4444;">
                  {{ animatedSNDSCounts.redCount }}
                </div>
              </div>
            </div>
          </div>

          <!-- Problem IPs Alert -->
          <div v-if="sndsProblemIPs && sndsProblemIPs.length > 0" style="background: linear-gradient(135deg, #fee2e2, #fecaca); border: 1px solid #fca5a5; border-radius: 12px; padding: 20px; margin-bottom: 32px;">
            <div style="display: flex; align-items: start; gap: 16px;">
              <span style="font-size: 28px;">‚ö†Ô∏è</span>
              <div style="flex: 1;">
                <h3 style="font-size: 16px; font-weight: 700; color: #991b1b; margin-bottom: 10px;">
                  {{ sndsProblemIPs.length }} IP{{ sndsProblemIPs.length > 1 ? 's' : '' }} Need Attention
                </h3>
                <p style="font-size: 14px; color: #7f1d1d; margin-bottom: 14px;">
                  The following IPs have reputation scores below 50 and require immediate investigation:
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                  <span
                    v-for="problem in sndsProblemIPs.slice(0, 10)"
                    :key="problem.ip_address"
                    style="background: white; padding: 8px 14px; border-radius: 6px; font-size: 12px; font-family: monospace; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #fca5a5;"
                  >
                    {{ problem.ip_address }}
                    <span style="color: #dc2626; font-weight: 600;">
                      ({{ problem.reputation_score }})
                    </span>
                  </span>
                  <span v-if="sndsProblemIPs.length > 10" style="padding: 8px 14px; font-size: 12px; color: #7f1d1d;">
                    +{{ sndsProblemIPs.length - 10 }} more
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Anomalies Detection -->
          <div v-if="sndsAnomalies && sndsAnomalies.length > 0" class="card-section" style="margin-bottom: 32px;">
            <div class="card-header">
              <h3 class="card-title">üîî Anomaly Detection ({{ sndsAnomalies.length }})</h3>
            </div>
            <div style="padding: 20px;">
              <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                Automated detection of reputation drops, spam spikes, trap hits, and traffic anomalies
              </p>
              <div style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                <div
                  v-for="anomaly in sndsAnomalies"
                  :key="`${anomaly.entity}-${anomaly.type}-${anomaly.date}`"
                  style="display: flex; align-items: center; gap: 14px; padding: 14px; border-radius: 8px; border: 1px solid;"
                  :style="{
                    background: getAnomalySeverityBg(anomaly.severity),
                    borderColor: getAnomalySeverityBorder(anomaly.severity)
                  }"
                >
                  <div
                    style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px;"
                    :style="{
                      background: getAnomalySeverityIconBg(anomaly.severity),
                      color: getAnomalySeverityColor(anomaly.severity)
                    }"
                  >
                    {{ getAnomalyTypeIcon(anomaly.type) }}
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap;">
                      <span style="font-weight: 600; font-size: 13px; color: #1e293b; font-family: monospace;">
                        {{ anomaly.entity }}
                      </span>
                      <span style="font-size: 11px; color: #64748b;">
                        {{ anomaly.date }}
                      </span>
                      <span
                        style="font-size: 10px; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;"
                        :style="{
                          background: getAnomalySeverityColor(anomaly.severity),
                          color: 'white'
                        }"
                      >
                        {{ anomaly.severity }}
                      </span>
                    </div>
                    <div style="font-size: 13px; color: #475569; margin-bottom: 4px;">
                      <strong>{{ anomaly.type.replace(/_/g, ' ').toUpperCase() }}:</strong> {{ anomaly.message }}
                    </div>
                    <div v-if="anomaly.previous_value !== undefined || anomaly.current_value !== undefined" style="font-size: 12px; color: #64748b;">
                      <span v-if="anomaly.previous_value !== undefined">
                        Previous: {{ typeof anomaly.previous_value === 'number' ? anomaly.previous_value.toLocaleString() : anomaly.previous_value }}
                      </span>
                      <span v-if="anomaly.current_value !== undefined">
                        ‚Üí Current: {{ typeof anomaly.current_value === 'number' ? anomaly.current_value.toLocaleString() : anomaly.current_value }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Insights -->
          <div v-if="sndsOverview" class="card-section" style="margin-bottom: 32px;">
            <div class="card-header">
              <h3 class="card-title">üí° Quick Insights</h3>
            </div>
            <div style="padding: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
              <div style="padding: 16px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Highest Volume Period
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #1e40af; font-family: monospace;">
                  {{ formatLargeNumber(sndsOverview.total_messages) }}
                </div>
                <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                  messages in {{ sndsTimePeriod === '30day' ? '30 days' : sndsTimePeriod }}
                </div>
              </div>

              <div style="padding: 16px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 8px; border-left: 4px solid #10b981;">
                <div style="font-size: 11px; color: #166534; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Overall Health
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #166534;">
                  {{ sndsOverview.avg_reputation_rating }}
                </div>
                <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                  avg score: {{ sndsOverview.avg_reputation_score }}/100
                </div>
              </div>

              <div style="padding: 16px; background: linear-gradient(135deg, #ccfbf1, #99f6e4); border-radius: 8px; border-left: 4px solid #14b8a6;">
                <div style="font-size: 11px; color: #0f766e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Clean IPs
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #0f766e;">
                  {{ sndsOverview.filter_distribution.GREEN || 0 }}
                </div>
                <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                  {{ ((sndsOverview.filter_distribution.GREEN / sndsOverview.total_ips) * 100).toFixed(1) }}% with GREEN status
                </div>
              </div>

              <div style="padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="font-size: 11px; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Network Spam Rate
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #92400e; font-family: monospace;">
                  {{ sndsOverview.avg_spam_rate }}%
                </div>
                <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                  {{ sndsOverview.total_trap_hits }} trap hits detected
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div v-if="sndsOverview" style="margin-bottom: 32px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <!-- Reputation Trends Chart -->
              <div class="card-section">
                <div class="card-header">
                  <h3 class="card-title">üìà Reputation Trends</h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="reputationTrendsChart" style="max-height: 300px;"></canvas>
                </div>
              </div>

              <!-- Traffic Volume Chart -->
              <div class="card-section">
                <div class="card-header">
                  <h3 class="card-title">üìä Traffic Volume</h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="trafficVolumeChart" style="max-height: 300px;"></canvas>
                </div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <!-- Spam & Trap Analysis Chart -->
              <div class="card-section">
                <div class="card-header">
                  <h3 class="card-title">üêõ Spam & Trap Analysis</h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="spamTrapChart" style="max-height: 300px;"></canvas>
                </div>
              </div>

              <!-- Filter Status Distribution Chart -->
              <div class="card-section">
                <div class="card-header">
                  <h3 class="card-title">ü•ß Filter Status Distribution</h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="filterDistributionChart" style="max-height: 300px;"></canvas>
                </div>
              </div>
            </div>

            <!-- Reputation Score Distribution Chart -->
            <div class="card-section" style="margin-bottom: 32px;">
              <div class="card-header">
                <h3 class="card-title">üìä Reputation Score Distribution</h3>
              </div>
              <div style="padding: 20px;">
                <canvas id="reputationDistributionChart" style="max-height: 250px;"></canvas>
              </div>
            </div>
          </div>

          <!-- Tabs for Different Views -->
          <div v-if="sndsData && sndsData.length > 0" class="card-section" style="margin-bottom: 32px;">
            <div class="card-header">
              <h3 class="card-title">üìä Data Views</h3>
            </div>

            <!-- Tabs -->
            <div style="border-bottom: 2px solid #e2e8f0; padding: 0 20px; display: flex; gap: 4px; flex-wrap: wrap;">
              <button
                @click="sndsActiveTab = 'all'"
                :class="['tab-button', { 'tab-button-active': sndsActiveTab === 'all' }]"
                style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 13px; border-bottom: 3px solid transparent; transition: all 0.2s;"
                :style="sndsActiveTab === 'all' ? 'border-bottom-color: #3b82f6; color: #3b82f6;' : 'color: #64748b;'"
              >
                üìã All Data ({{ sndsData.length }})
              </button>
              <button
                @click="sndsActiveTab = 'top'"
                :class="['tab-button', { 'tab-button-active': sndsActiveTab === 'top' }]"
                style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 13px; border-bottom: 3px solid transparent; transition: all 0.2s;"
                :style="sndsActiveTab === 'top' ? 'border-bottom-color: #10b981; color: #10b981;' : 'color: #64748b;'"
              >
                üèÜ Top Performers ({{ sndsTopPerformers.length }})
              </button>
              <button
                @click="sndsActiveTab = 'worst'"
                :class="['tab-button', { 'tab-button-active': sndsActiveTab === 'worst' }]"
                style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 13px; border-bottom: 3px solid transparent; transition: all 0.2s;"
                :style="sndsActiveTab === 'worst' ? 'border-bottom-color: #ef4444; color: #ef4444;' : 'color: #64748b;'"
              >
                ‚ö†Ô∏è Worst Performers ({{ filteredSNDSWorst.length }})
              </button>
              <button
                @click="sndsActiveTab = 'green'"
                :class="['tab-button', { 'tab-button-active': sndsActiveTab === 'green' }]"
                style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 13px; border-bottom: 3px solid transparent; transition: all 0.2s;"
                :style="sndsActiveTab === 'green' ? 'border-bottom-color: #10b981; color: #10b981;' : 'color: #64748b;'"
              >
                üü¢ GREEN ({{ filteredSNDSGreen.length }})
              </button>
              <button
                @click="sndsActiveTab = 'yellow'"
                :class="['tab-button', { 'tab-button-active': sndsActiveTab === 'yellow' }]"
                style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 13px; border-bottom: 3px solid transparent; transition: all 0.2s;"
                :style="sndsActiveTab === 'yellow' ? 'border-bottom-color: #f59e0b; color: #f59e0b;' : 'color: #64748b;'"
              >
                üü° YELLOW ({{ filteredSNDSYellow.length }})
              </button>
              <button
                @click="sndsActiveTab = 'red'"
                :class="['tab-button', { 'tab-button-active': sndsActiveTab === 'red' }]"
                style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 13px; border-bottom: 3px solid transparent; transition: all 0.2s;"
                :style="sndsActiveTab === 'red' ? 'border-bottom-color: #ef4444; color: #ef4444;' : 'color: #64748b;'"
              >
                üî¥ RED ({{ filteredSNDSRed.length }})
              </button>
            </div>

            <!-- Tab Content -->
            <div style="padding: 20px;">
              <!-- No Data Message -->
              <div v-if="!currentTabData || currentTabData.length === 0" style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                <h3 style="font-size: 16px; color: #1e293b; margin-bottom: 8px;">No Data Available</h3>
                <p style="font-size: 14px; color: #64748b;">
                  <span v-if="sndsActiveTab === 'top'">No top performers found. Try selecting a different time period.</span>
                  <span v-else-if="sndsActiveTab === 'worst'">No worst performers found (reputation score < 50).</span>
                  <span v-else>No records match the selected filter.</span>
                </p>
              </div>

              <!-- Data Table -->
              <div v-else class="table-wrapper" style="max-height: 600px; overflow-y: auto;">
                <table class="data-table" style="font-size: 12px;">
                  <thead style="position: sticky; top: 0; z-index: 10; background: #f8fafc;">
                    <tr>
                      <th v-if="sndsViewBy === 'ip'" style="padding: 8px 10px;">IP Address</th>
                      <th style="padding: 8px 10px;">Account</th>
                      <th v-if="sndsActiveTab !== 'top'" style="padding: 8px 10px;">Date</th>
                      <th style="padding: 8px 10px;">Message Volume</th>
                      <th style="padding: 8px 10px;">Spam Rate</th>
                      <th style="padding: 8px 10px;">Trap Hits</th>
                      <th style="padding: 8px 10px;">Filter Result</th>
                      <th style="padding: 8px 10px;">Reputation Score</th>
                      <th style="padding: 8px 10px;">Rating</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="record in currentTabData" :key="`${record.ip_address || record.account_name}-${record.date || 'agg'}`">
                      <td v-if="sndsViewBy === 'ip'" style="padding: 6px 10px; font-family: monospace; color: #1e293b; font-weight: 500;">{{ record.ip_address }}</td>
                      <td style="padding: 6px 10px; color: #3b82f6; font-weight: 500;">{{ record.account_name }}</td>
                      <td v-if="sndsActiveTab !== 'top'" style="padding: 6px 10px; font-family: monospace; color: #64748b;">{{ record.date }}</td>
                      <td style="padding: 6px 10px; font-family: monospace; color: #1e293b; font-weight: 500;">{{ (record.message_volume || record.total_volume || 0).toLocaleString() }}</td>
                      <td style="padding: 6px 10px; font-family: monospace; color: #64748b;">{{ record.spam_rate || 0 }}%</td>
                      <td style="padding: 6px 10px; color: #64748b;">{{ record.trap_hits || 0 }}</td>
                      <td style="padding: 6px 10px;">
                        <span class="badge" :style="{
                          background: getFilterBgColor(record.filter_result),
                          color: getFilterColor(record.filter_result),
                          fontSize: '11px',
                          padding: '3px 8px'
                        }">
                          {{ record.filter_result }}
                        </span>
                      </td>
                      <td style="padding: 6px 10px;">
                        <span :style="{
                          fontWeight: 700,
                          color: getReputationColor(record.reputation_score)
                        }">
                          {{ record.reputation_score }}
                        </span>
                      </td>
                      <td style="padding: 6px 10px;">
                        <span class="badge" :style="{
                          background: getReputationBgColor(record.reputation_score),
                          color: getReputationColor(record.reputation_score),
                          fontSize: '11px',
                          padding: '3px 8px'
                        }">
                          {{ record.reputation_rating }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- GPT Page -->
        <div v-if="activePage === 'gpt'" @click="showGPTNotifications = false">
          <!-- Page Header -->
          <div class="page-header" style="position: relative;">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content" style="display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div class="page-header-icon">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                  </svg>
                </div>
                <div>
                  <h1 class="page-header-title">Google Postmaster Tools</h1>
                  <p class="page-header-subtitle">Domain Reputation & Email Authentication Monitoring</p>
                </div>
              </div>

              <!-- Notification Bell -->
              <div v-if="gptAuthorized" @click.stop="toggleGPTNotifications" style="position: relative; cursor: pointer; z-index: 10;">
                <div style="width: 44px; height: 44px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border: 1px solid rgba(255, 255, 255, 0.2);" :style="gptEnhancedChanges.length > 0 ? 'animation: pulse 2s infinite;' : ''" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                  </svg>
                </div>
                <span v-if="gptEnhancedChanges.length > 0" style="position: absolute; top: -6px; right: -6px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);">
                  {{ gptEnhancedChanges.length }}
                </span>
              </div>
            </div>

            <!-- Notifications Dropdown -->
            <div v-if="showGPTNotifications && gptAuthorized" @click.stop style="position: fixed; top: 80px; right: 20px; background: white; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0, 0, 0, 0.05); width: 480px; max-height: 600px; overflow: hidden; z-index: 2000; animation: slideDown 0.2s ease-out;">
              <!-- Header -->
              <div style="padding: 20px 24px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); position: sticky; top: 0; z-index: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 36px; height: 36px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                      </svg>
                    </div>
                    <div>
                      <h3 style="margin: 0; font-size: 16px; font-weight: 700; color: white;">Reputation Changes</h3>
                      <p style="margin: 0; font-size: 12px; color: rgba(255, 255, 255, 0.8);">Since yesterday</p>
                    </div>
                  </div>
                  <button @click="showGPTNotifications = false" style="background: rgba(255, 255, 255, 0.15); border: none; color: white; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; font-size: 18px; font-weight: 600;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">√ó</button>
                </div>

                <!-- Count Badge -->
                <div v-if="gptEnhancedChanges.length > 0" style="margin-top: 12px; padding: 8px 12px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 8px; display: inline-flex; align-items: center; gap: 6px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                  </svg>
                  <span style="font-size: 12px; color: white; font-weight: 600;">{{ gptEnhancedChanges.length }} domain{{ gptEnhancedChanges.length !== 1 ? 's' : '' }} changed</span>
                </div>
              </div>

              <!-- Notifications List -->
              <div style="max-height: 480px; overflow-y: auto; padding: 8px;">
                <div v-if="gptEnhancedChanges.length > 0">
                  <div v-for="(change, index) in gptEnhancedChanges" :key="change.domain" @click="selectDomainForDetails(change.domain); showGPTNotifications = false;" style="margin: 8px; padding: 16px; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; background: white;" :style="'animation: fadeInUp 0.3s ease-out ' + (index * 0.05) + 's backwards;'" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px -4px rgba(0, 0, 0, 0.12)'; this.style.borderColor='#3b82f6';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='#e2e8f0';">
                    <!-- Domain & Badge -->
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                      <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                        <div :style="{
                          width: '8px',
                          height: '8px',
                          borderRadius: '50%',
                          flexShrink: '0',
                          background: change.change_type === 'degraded' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : change.change_type === 'improved' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #3b82f6, #2563eb)',
                          boxShadow: change.change_type === 'degraded' ? '0 0 8px rgba(239, 68, 68, 0.5)' : change.change_type === 'improved' ? '0 0 8px rgba(16, 185, 129, 0.5)' : '0 0 8px rgba(59, 130, 246, 0.5)'
                        }"></div>
                        <div style="font-weight: 700; color: #1e293b; font-size: 14px; font-family: monospace; overflow: hidden; text-overflow: ellipsis;">{{ change.domain }}</div>
                      </div>
                      <div :style="{
                        padding: '4px 12px',
                        borderRadius: '8px',
                        fontSize: '10px',
                        fontWeight: '700',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        flexShrink: '0',
                        marginLeft: '8px',
                        background: change.change_type === 'degraded' ? 'linear-gradient(135deg, #fee2e2, #fecaca)' : change.change_type === 'improved' ? 'linear-gradient(135deg, #dcfce7, #bbf7d0)' : 'linear-gradient(135deg, #dbeafe, #bfdbfe)',
                        color: change.change_type === 'degraded' ? '#991b1b' : change.change_type === 'improved' ? '#166534' : '#1e40af',
                        border: change.change_type === 'degraded' ? '1px solid #fca5a5' : change.change_type === 'improved' ? '1px solid #86efac' : '1px solid #93c5fd'
                      }">
                        {{ change.change_type }}
                      </div>
                    </div>

                    <!-- Change Icon & Message -->
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                      <div :style="{
                        width: '28px',
                        height: '28px',
                        borderRadius: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: '0',
                        background: change.change_type === 'degraded' ? 'linear-gradient(135deg, #fee2e2, #fecaca)' : change.change_type === 'improved' ? 'linear-gradient(135deg, #dcfce7, #bbf7d0)' : 'linear-gradient(135deg, #dbeafe, #bfdbfe)'
                      }">
                        <svg v-if="change.change_type === 'degraded'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5">
                          <line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/>
                        </svg>
                        <svg v-else-if="change.change_type === 'improved'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5">
                          <line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>
                        </svg>
                        <svg v-else width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5">
                          <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                        </svg>
                      </div>
                      <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 13px; color: #475569; line-height: 1.6; font-weight: 500;">{{ change.message }}</div>
                      </div>
                    </div>

                    <!-- Timestamp & Previous Value -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #f1f5f9;">
                      <div style="font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 4px;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        {{ change.recent_date }}
                      </div>
                      <div v-if="change.previous_reputation" style="font-size: 11px; color: #64748b; font-weight: 600;">
                        Was: <span :style="{
                          padding: '2px 6px',
                          borderRadius: '4px',
                          background: getGPTReputationBgColor(change.previous_reputation),
                          color: getGPTReputationColor(change.previous_reputation, 1)
                        }">{{ change.previous_reputation }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Empty State -->
                <div v-else style="padding: 60px 20px; text-align: center;">
                  <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  </div>
                  <p style="font-size: 15px; font-weight: 600; color: #1e293b; margin: 0 0 6px 0;">All Clear!</p>
                  <p style="font-size: 13px; color: #64748b; margin: 0;">No reputation changes detected since yesterday</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Authorization Check -->
          <div v-if="!gptAuthorized && !gptLoading" style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)); border-radius: 16px; margin-bottom: 32px; border: 2px dashed #93c5fd;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
              </svg>
            </div>
            <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 10px;">Authorization Required</h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">Connect to Google Postmaster Tools to view domain reputation data</p>
            <button class="btn btn-primary" @click="authorizeGPT" :disabled="gptLoading" style="padding: 12px 32px; font-size: 15px; font-weight: 600;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>
              </svg>
              Authorize Google Postmaster
            </button>
          </div>

          <!-- Control Panel -->
          <div v-if="gptAuthorized" class="control-panel">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üìÖ Time Period:</label>
              <select class="date-input" v-model="gptTimePeriod" :disabled="gptLoading">
                <option value="yesterday">Yesterday</option>
                <option value="7day">Last 7 Days</option>
                <option value="30day">Last 30 Days</option>
                <option value="60day">Last 60 Days</option>
                <option value="90day">Last 90 Days</option>
                <option value="120day">Last 120 Days</option>
                <option value="180day">Last 180 Days</option>
                <option value="365day">Last 365 Days</option>
              </select>
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üåê Domain:</label>
              <input list="gpt-domains-list" class="date-input" v-model="gptSelectedDomain" placeholder="All Domains" :disabled="gptLoading" @change="onDomainChange" style="min-width: 260px;" />
              <datalist id="gpt-domains-list">
                <option value="">All Domains (Overview)</option>
                <option v-for="domain in gptDomainsList" :key="domain" :value="domain">{{ domain }}</option>
              </datalist>
            </div>

            <button class="btn btn-primary" @click="loadGPTData" :disabled="gptLoading">
              <span v-if="gptLoading">‚è≥</span>
              <span v-else>üîÑ</span>
              {{ gptLoading ? 'Loading...' : 'Load Data' }}
            </button>

            <button v-if="!gptSelectedDomain" class="btn btn-secondary" @click="collectGPTData" :disabled="gptLoading">
              üì• Collect New
            </button>

            <button v-if="gptSelectedDomain" class="btn btn-secondary" @click="clearDomainSelection" :disabled="gptLoading">
              ‚Üê Back to Overview
            </button>

            <div v-if="gptLastUpdated" style="margin-left: auto; font-size: 12px; color: #94a3b8;">
              Last updated: {{ gptLastUpdated }}
            </div>
          </div>

          <!-- Error Display -->
          <div v-if="gptError" style="background: linear-gradient(135deg, #fee2e2, #fecaca); border: 1px solid #fca5a5; border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
              <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span style="color: #991b1b; font-size: 14px; font-weight: 500;">{{ gptError }}</span>
          </div>

          <!-- Loading State -->
          <div v-if="gptLoading && !gptOverviewTable && !gptDomainDetails" class="card-section" style="text-align: center; padding: 60px 20px;">
            <div class="loading-spinner" style="width: 48px; height: 48px; margin: 0 auto 20px;"></div>
            <p style="color: #64748b; font-size: 14px; font-weight: 500;">Loading GPT data...</p>
          </div>

          <!-- OVERVIEW TABLE VIEW -->
          <div v-if="gptAuthorized && !gptSelectedDomain && gptOverviewTable && gptOverviewTable.length > 0">
            <!-- Stats Tiles -->
            <div style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 12px; margin-bottom: 24px;">
              <!-- Total Domains -->
              <div style="padding: 16px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Total Domains
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #1e40af; font-family: monospace;">
                  {{ animatedGPTCounts.totalDomains }}
                </div>
              </div>

              <!-- HIGH Domain Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 8px; border-left: 4px solid #10b981;">
                <div style="font-size: 11px; color: #166534; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  High Dom
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #166534; font-family: monospace;">
                  {{ animatedGPTCounts.highDom }}
                </div>
              </div>

              <!-- MEDIUM Domain Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="font-size: 11px; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Med Dom
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #92400e; font-family: monospace;">
                  {{ animatedGPTCounts.medDom }}
                </div>
              </div>

              <!-- LOW Domain Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #fed7aa, #fdba74); border-radius: 8px; border-left: 4px solid #f97316;">
                <div style="font-size: 11px; color: #9a3412; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Low Dom
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #9a3412; font-family: monospace;">
                  {{ animatedGPTCounts.lowDom }}
                </div>
              </div>

              <!-- BAD Domain Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 8px; border-left: 4px solid #ef4444;">
                <div style="font-size: 11px; color: #991b1b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Bad Dom
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #991b1b; font-family: monospace;">
                  {{ animatedGPTCounts.badDom }}
                </div>
              </div>

              <!-- HIGH IP Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 8px; border-left: 4px solid #10b981;">
                <div style="font-size: 11px; color: #166534; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  High IP
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #166534; font-family: monospace;">
                  {{ animatedGPTCounts.highIP }}
                </div>
              </div>

              <!-- MEDIUM IP Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="font-size: 11px; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Med IP
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #92400e; font-family: monospace;">
                  {{ animatedGPTCounts.medIP }}
                </div>
              </div>

              <!-- LOW IP Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #fed7aa, #fdba74); border-radius: 8px; border-left: 4px solid #f97316;">
                <div style="font-size: 11px; color: #9a3412; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Low IP
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #9a3412; font-family: monospace;">
                  {{ animatedGPTCounts.lowIP }}
                </div>
              </div>

              <!-- BAD IP Reputation -->
              <div style="padding: 16px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 8px; border-left: 4px solid #ef4444;">
                <div style="font-size: 11px; color: #991b1b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">
                  Bad IP
                </div>
                <div style="font-size: 24px; font-weight: 800; color: #991b1b; font-family: monospace;">
                  {{ animatedGPTCounts.badIP }}
                </div>
              </div>
            </div>

            <!-- Reputation Changes Alert -->
            <div v-if="gptEnhancedChanges && gptEnhancedChanges.length > 0" class="card-section" style="margin-bottom: 24px; border-left: 4px solid #f59e0b;">
              <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px;">
                <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                </div>
                <div>
                  <h3 style="font-size: 17px; font-weight: 700; color: #1e293b; margin: 0 0 4px 0;">Reputation Changes Detected</h3>
                  <p style="font-size: 13px; color: #64748b; margin: 0;">{{ gptEnhancedChanges.length }} domain(s) had reputation changes since yesterday</p>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                <div v-for="change in gptEnhancedChanges.slice(0, 6)" :key="change.domain" style="padding: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); background: #fef9e7; border-radius: 10px; border-left: 3px solid #f59e0b;">
                  <div style="display: flex; align-items: start; gap: 10px;">
                    <svg v-if="change.change_type === 'degraded'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                      <line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/>
                    </svg>
                    <svg v-if="change.change_type === 'improved'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                      <line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>
                    </svg>
                    <svg v-if="change.change_type !== 'degraded' && change.change_type !== 'improved'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                      <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                    </svg>
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-size: 13px; font-weight: 600; color: #1e293b; margin-bottom: 6px;">{{ change.domain }}</div>
                      <div style="font-size: 12px; color: #475569; line-height: 1.5;">{{ change.message }}</div>
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="gptEnhancedChanges.length > 6" style="margin-top: 16px; text-align: center; font-size: 12px; color: #64748b;">
                Showing 6 of {{ gptEnhancedChanges.length }} changes. Check the table below for all domains.
              </div>
            </div>

            <!-- Overview Table -->
            <div class="card-section">
              <div class="card-header">
                <h3 class="card-title">All Domains ‚Äî Yesterday's Reputation</h3>
                <span class="card-meta">{{ gptOverviewTable.length }} domains</span>
              </div>
              <div class="table-wrapper">
                <table class="data-table" style="font-size: 12px;">
                  <thead style="position: sticky; top: 0; z-index: 10; background: #f8fafc;">
                    <tr>
                      <th style="width: 40px; text-align: center; padding: 8px 10px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                      </th>
                      <th @click="sortGPTTable('domain')" style="cursor: pointer; padding: 8px 10px;">
                        Domain
                        <svg v-if="gptSortColumn === 'domain'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-left: 4px;">
                          <polyline :points="gptSortOrder === 'asc' ? '18 15 12 9 6 15' : '6 9 12 15 18 9'"/>
                        </svg>
                      </th>
                      <th @click="sortGPTTable('account_name')" style="cursor: pointer; padding: 8px 10px;">
                        Account Name
                        <svg v-if="gptSortColumn === 'account_name'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-left: 4px;">
                          <polyline :points="gptSortOrder === 'asc' ? '18 15 12 9 6 15' : '6 9 12 15 18 9'"/>
                        </svg>
                      </th>
                      <th @click="sortGPTTable('domain_reputation')" style="text-align: center; cursor: pointer; padding: 8px 10px;">
                        Domain Rep.
                        <svg v-if="gptSortColumn === 'domain_reputation'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-left: 4px;">
                          <polyline :points="gptSortOrder === 'asc' ? '18 15 12 9 6 15' : '6 9 12 15 18 9'"/>
                        </svg>
                      </th>
                      <th @click="sortGPTTable('ip_reputation')" style="text-align: center; cursor: pointer; padding: 8px 10px;">
                        IP Rep.
                        <svg v-if="gptSortColumn === 'ip_reputation'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-left: 4px;">
                          <polyline :points="gptSortOrder === 'asc' ? '18 15 12 9 6 15' : '6 9 12 15 18 9'"/>
                        </svg>
                      </th>
                      <th @click="sortGPTTable('spam_rate')" style="text-align: center; cursor: pointer; padding: 8px 10px;">
                        Spam Rate
                        <svg v-if="gptSortColumn === 'spam_rate'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-left: 4px;">
                          <polyline :points="gptSortOrder === 'asc' ? '18 15 12 9 6 15' : '6 9 12 15 18 9'"/>
                        </svg>
                      </th>
                      <th style="text-align: center; padding: 8px 10px;">SPF</th>
                      <th style="text-align: center; padding: 8px 10px;">DKIM</th>
                      <th style="text-align: center; padding: 8px 10px;">DMARC</th>
                      <th style="text-align: center; padding: 8px 10px;">TLS</th>
                      <th style="text-align: center; padding: 8px 10px;">Date</th>
                      <th style="text-align: center; padding: 8px 10px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="item in sortedGPTTable" :key="item.domain">
                      <td style="text-align: center; padding: 6px 10px;">
                        <svg v-if="hasGPTChange(item.domain)" width="14" height="14" viewBox="0 0 24 24" fill="none" :stroke="getGPTChangeColor(item.domain)" stroke-width="2" style="animation: pulse 2s infinite;" :title="getGPTChangeMessages(item.domain)">
                          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                      </td>
                      <td style="padding: 6px 10px; font-weight: 600;">
                        <a href="#" @click.prevent="selectDomainForDetails(item.domain)" style="color: #3b82f6; text-decoration: none;">{{ item.domain }}</a>
                      </td>
                      <td style="padding: 6px 10px; color: #64748b; font-size: 13px;">{{ item.account_name }}</td>
                      <td style="text-align: center; padding: 6px 10px;">
                        <span :style="{
                          padding: '4px 12px',
                          borderRadius: '6px',
                          fontSize: '11px',
                          fontWeight: '600',
                          background: getGPTReputationBgColor(item.domain_reputation),
                          color: getGPTReputationColor(item.domain_reputation, 1)
                        }">
                          {{ item.domain_reputation }}
                        </span>
                      </td>
                      <td style="text-align: center; padding: 6px 10px;">
                        <div v-if="item.ip_reputation && Object.keys(item.ip_reputation).length > 0" style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                          <span v-for="(count, reputation) in item.ip_reputation" :key="reputation" :style="{
                            padding: '4px 8px',
                            borderRadius: '6px',
                            fontSize: '10px',
                            fontWeight: '600',
                            background: getGPTReputationBgColor(reputation),
                            color: getGPTReputationColor(reputation, 1)
                          }">
                            {{ reputation }}({{ count }})
                          </span>
                        </div>
                        <span v-else style="color: #94a3b8; font-size: 12px;">N/A</span>
                      </td>
                      <td style="text-align: center; padding: 6px 10px; font-family: monospace; color: #64748b;">{{ item.spam_rate }}%</td>
                      <td style="text-align: center; padding: 6px 10px; font-family: monospace; color: #64748b;">{{ item.spf_rate }}%</td>
                      <td style="text-align: center; padding: 6px 10px; font-family: monospace; color: #64748b;">{{ item.dkim_rate }}%</td>
                      <td style="text-align: center; padding: 6px 10px; font-family: monospace; color: #64748b;">{{ item.dmarc_rate }}%</td>
                      <td style="text-align: center; padding: 6px 10px; font-family: monospace; color: #64748b;">{{ item.tls_rate }}%</td>
                      <td style="text-align: center; padding: 6px 10px; font-size: 11px; color: #94a3b8;">{{ item.date }}</td>
                      <td style="text-align: center; padding: 6px 10px;">
                        <button class="btn btn-sm btn-default" @click="selectDomainForDetails(item.domain)" style="padding: 5px 10px; font-size: 11px;">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                          </svg>
                          View
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- DETAILED DOMAIN VIEW -->
          <div v-if="gptAuthorized && gptSelectedDomain && gptDomainDetails">
            <!-- Domain Header -->
            <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #bfdbfe 100%); border-radius: 16px; padding: 28px 32px; margin-bottom: 24px; border: 1px solid #bfdbfe; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 16px;">
                  <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                  </div>
                  <div>
                    <h2 style="font-size: 26px; font-weight: 800; color: #1e293b; margin: 0 0 4px 0; letter-spacing: -0.5px;">{{ gptSelectedDomain }}</h2>
                    <p style="font-size: 14px; color: #64748b; margin: 0; display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      {{ gptTimePeriod.replace('day', ' Days').replace('yesterday', 'Yesterday') }}
                    </p>
                  </div>
                </div>
                <button @click="clearDomainSelection" class="btn btn-secondary" style="padding: 10px 20px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
                  </svg>
                  Back to Overview
                </button>
              </div>
            </div>

            <!-- Latest Metrics Cards -->
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 24px; overflow-x: auto;">
              <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: none; text-align: center; padding: 20px 12px;">
                <div style="width: 44px; height: 44px; background: rgba(234, 179, 8, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#ca8a04" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                  </svg>
                </div>
                <div style="font-size: 10px; font-weight: 600; color: #854d0e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Domain Reputation</div>
                <div style="font-size: 22px; font-weight: 800; color: #a16207;">{{ gptDomainDetails.latest.domain_reputation }}</div>
              </div>

              <div class="stat-card" @click="showIPReputationModal" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: none; text-align: center; padding: 20px 12px; cursor: pointer;" title="Click to view IP addresses">
                <div style="width: 44px; height: 44px; background: rgba(59, 130, 246, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                    <rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3M12 12V8"/>
                  </svg>
                </div>
                <div style="font-size: 10px; font-weight: 600; color: #1e40af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">IP Reputation üîó</div>
                <div v-if="gptDomainDetails.latest.ip_reputation && Object.keys(gptDomainDetails.latest.ip_reputation).length > 0" style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;">
                  <span v-for="(count, reputation) in gptDomainDetails.latest.ip_reputation" :key="reputation" style="padding: 2px 6px; borderRadius: 4px; fontSize: 11px; fontWeight: 700;" :style="{background: getGPTReputationBgColor(reputation), color: getGPTReputationColor(reputation, 1)}">
                    {{ reputation }}({{ count }})
                  </span>
                </div>
                <div v-else style="font-size: 18px; font-weight: 800; color: #64748b;">N/A</div>
              </div>

              <div class="stat-card" style="background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); border: none; text-align: center; padding: 20px 12px;">
                <div style="width: 44px; height: 44px; background: rgba(249, 115, 22, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#c2410c" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                </div>
                <div style="font-size: 10px; font-weight: 600; color: #9a3412; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Spam Rate</div>
                <div style="font-size: 22px; font-weight: 800; color: #c2410c;">{{ gptDomainDetails.latest.spam_rate }}%</div>
              </div>

              <div class="stat-card" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: none; text-align: center; padding: 20px 12px;">
                <div style="width: 44px; height: 44px; background: rgba(34, 197, 94, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  </svg>
                </div>
                <div style="font-size: 10px; font-weight: 600; color: #166534; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">SPF Success</div>
                <div style="font-size: 22px; font-weight: 800; color: #16a34a;">{{ gptDomainDetails.latest.spf_rate }}%</div>
              </div>

              <div class="stat-card" style="background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%); border: none; text-align: center; padding: 20px 12px;">
                <div style="width: 44px; height: 44px; background: rgba(168, 85, 247, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                  </svg>
                </div>
                <div style="font-size: 10px; font-weight: 600; color: #6b21a8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">DKIM Success</div>
                <div style="font-size: 22px; font-weight: 800; color: #7c3aed;">{{ gptDomainDetails.latest.dkim_rate }}%</div>
              </div>

              <div class="stat-card" style="background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%); border: none; text-align: center; padding: 20px 12px;">
                <div style="width: 44px; height: 44px; background: rgba(20, 184, 166, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#0f766e" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                </div>
                <div style="font-size: 10px; font-weight: 600; color: #134e4a; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">DMARC Success</div>
                <div style="font-size: 22px; font-weight: 800; color: #0f766e;">{{ gptDomainDetails.latest.dmarc_rate }}%</div>
              </div>
            </div>

            <!-- Charts Section -->
            <div v-if="gptDomainDetails.trends.dates.length > 0">
              <!-- Domain Reputation Chart -->
              <div class="card-section" style="margin-bottom: 20px;">
                <div class="card-header">
                  <h3 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    Domain Reputation Over Time
                  </h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="gptReputationChart" style="max-height: 300px;"></canvas>
                </div>
              </div>

              <!-- IP Reputation Chart -->
              <div class="card-section" style="margin-bottom: 20px;">
                <div class="card-header">
                  <h3 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                      <rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3M12 12V8"/>
                    </svg>
                    IP Reputation Over Time
                  </h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="gptIpReputationChart" style="max-height: 300px;"></canvas>
                </div>
              </div>

              <!-- Authentication Rates Chart -->
              <div class="card-section" style="margin-bottom: 20px;">
                <div class="card-header">
                  <h3 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    Authentication Success Rates (SPF, DKIM, DMARC)
                  </h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="gptAuthChart" style="max-height: 300px;"></canvas>
                </div>
              </div>

              <!-- Spam Rate Chart -->
              <div class="card-section" style="margin-bottom: 20px;">
                <div class="card-header">
                  <h3 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Spam Rate Over Time
                  </h3>
                </div>
                <div style="padding: 20px;">
                  <canvas id="gptSpamChart" style="max-height: 250px;"></canvas>
                </div>
              </div>
            </div>

            <!-- Delivery Errors -->
            <div v-if="gptDomainDetails.latest.delivery_errors && gptDomainDetails.latest.delivery_errors.length > 0" class="card-section" style="margin-bottom: 20px;">
              <div class="card-header">
                <h3 class="card-title">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  Delivery Errors
                </h3>
              </div>
              <div style="padding: 20px;">
                <div v-for="(error, index) in gptDomainDetails.latest.delivery_errors" :key="index" style="padding: 14px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-left: 4px solid #dc2626; margin-bottom: 12px; border-radius: 8px;">
                  <div style="font-size: 13px; font-weight: 600; color: #991b1b; margin-bottom: 4px;">{{ error.error_type || 'Error' }}</div>
                  <div style="font-size: 12px; color: #7f1d1d;">{{ error.error_ratio || 'N/A' }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- IP Reputation Modal -->
          <div v-if="showIPModal" @click="showIPModal = false" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(6px); animation: fadeIn 0.2s;">
            <div @click.stop style="background: white; border-radius: 20px; max-width: 1100px; width: 100%; max-height: 88vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.35); animation: slideUp 0.3s;">
              <div style="padding: 32px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                  <h3 style="font-size: 24px; font-weight: 800; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                        <rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3M12 12V8"/>
                      </svg>
                    </div>
                    IP Addresses by Reputation
                  </h3>
                  <button @click="showIPModal = false" style="background: rgba(255, 255, 255, 0.8); border: none; color: #64748b; font-size: 24px; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: all 0.2s; font-weight: 300;" onmouseover="this.style.background='rgba(255, 255, 255, 1)'; this.style.color='#1e293b'" onmouseout="this.style.background='rgba(255, 255, 255, 0.8)'; this.style.color='#64748b'">√ó</button>
                </div>
                <p style="font-size: 15px; color: #475569; margin: 0; padding-left: 60px;">{{ gptSelectedDomain }}</p>
              </div>

              <div style="padding: 32px; overflow-y: auto; max-height: calc(88vh - 160px);">
                <div v-if="gptDomainDetails && gptDomainDetails.latest.ip_reputation_samples && Object.keys(gptDomainDetails.latest.ip_reputation_samples).length > 0">
                  <div v-for="(ips, reputation) in gptDomainDetails.latest.ip_reputation_samples" :key="reputation" style="margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; margin-bottom: 16px; gap: 12px;">
                      <span :style="{
                        padding: '10px 20px',
                        borderRadius: '10px',
                        fontSize: '16px',
                        fontWeight: '800',
                        background: getGPTReputationBgColor(reputation),
                        color: getGPTReputationColor(reputation, 1),
                        letterSpacing: '0.5px',
                        boxShadow: '0 2px 8px ' + getGPTReputationColor(reputation, 0.2)
                      }">
                        {{ reputation }}
                      </span>
                      <span style="padding: 6px 14px; background: #f1f5f9; border-radius: 8px; font-size: 13px; font-weight: 700; color: #64748b;">{{ ips.length }} {{ ips.length === 1 ? 'IP' : 'IPs' }}</span>
                      <div style="flex: 1; height: 2px; background: linear-gradient(to right, #e2e8f0, transparent);"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                      <div v-for="(ip, index) in ips" :key="index" :style="{
                        padding: '12px 16px',
                        background: '#f8fafc',
                        borderRadius: '10px',
                        fontFamily: 'Monaco, Courier New, monospace',
                        fontSize: '13px',
                        fontWeight: '600',
                        color: '#1e293b',
                        border: '1px solid #e2e8f0',
                        transition: 'all 0.2s',
                        cursor: 'default'
                      }" onmouseover="this.style.background='#fff'; this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                        {{ ip }}
                      </div>
                    </div>
                  </div>
                </div>
                <div v-else style="text-align: center; padding: 80px 20px; color: #94a3b8;">
                  <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5">
                      <rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3M12 12V8"/>
                    </svg>
                  </div>
                  <p style="font-size: 18px; font-weight: 600; color: #64748b; margin: 0 0 8px 0;">No IP addresses available</p>
                  <p style="font-size: 14px; margin: 0;">This domain has no IP reputation data</p>
                </div>
              </div>
            </div>
          </div>

          <!-- No Data Message -->
          <div v-if="gptAuthorized && !gptLoading && !gptOverviewTable && !gptDomainDetails" class="card-section" style="text-align: center; padding: 80px 20px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5" style="margin: 0 auto 20px;">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </svg>
            <p style="color: #64748b; font-size: 18px; font-weight: 600; margin: 0 0 8px 0;">No data available</p>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">Click "Load Data" to view reputation metrics</p>
          </div>
        </div>

        <!-- Bounce Analytics Page -->
        <div v-if="activePage === 'bounces'">
          <!-- Page Header -->
          <div class="page-header">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content">
              <div class="page-header-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
              <div>
                <h1 class="page-header-title">Bounce Analytics</h1>
                <p class="page-header-subtitle">Email bounce tracking across Mailgun, SparkPost, and SendGrid</p>
              </div>
            </div>
          </div>

          <!-- ESP Tabs -->
          <div class="tabs">
            <button
              v-for="esp in ['Mailgun', 'Sparkpost', 'Sendgrid']"
              :key="esp"
              class="tab"
              :class="{ active: activeBounceESP === esp }"
              @click="activeBounceESP = esp; loadBounceData()">
              {{ esp }}
            </button>
          </div>

          <!-- Control Panel -->
          <div class="control-panel" style="flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üìÖ From:</label>
              <input type="date" class="date-input" v-model="bounceStartDate" :disabled="bounceLoading" />
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">To:</label>
              <input type="date" class="date-input" v-model="bounceEndDate" :disabled="bounceLoading" />
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üîç Domain:</label>
              <select class="date-input" v-model="bounceSelectedDomain" :disabled="bounceLoading" style="min-width: 220px;">
                <option value="all">All Domains</option>
                <option v-for="domain in bounceSendingDomains" :key="domain" :value="domain">{{ domain }}</option>
              </select>
            </div>

            <button class="btn btn-primary" @click="loadBounceData" :disabled="bounceLoading">
              <span v-if="bounceLoading">‚è≥</span>
              <span v-else>üîç</span>
              {{ bounceLoading ? 'Loading...' : 'Search' }}
            </button>

            <button class="btn btn-success" @click="exportBounceCSV" :disabled="bounceLoading || !bounceData.length">
              üì• Export CSV
            </button>

            <div v-if="bounceData.length > 0" style="margin-left: auto; font-size: 13px; color: #64748b; font-weight: 500;">
              <strong>{{ bounceData.length }}</strong> bounce events
            </div>
          </div>

          <!-- Loading State -->
          <div v-if="bounceLoading" class="card-section" style="text-align: center; padding: 80px 20px;">
            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
            <p style="font-size: 16px; font-weight: 500; color: #64748b;">Loading bounce data...</p>
          </div>

          <!-- Bounce Data Table -->
          <div v-else-if="bounceData.length > 0" class="card-section">
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th @click="sortBounceTable('event_date')" style="cursor: pointer;">
                      Date
                      <svg v-if="bounceSortColumn === 'event_date'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('sending_domain')" style="cursor: pointer;">
                      Sending Domain
                      <svg v-if="bounceSortColumn === 'sending_domain'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('sending_ip')" style="cursor: pointer;">
                      Sending IP
                      <svg v-if="bounceSortColumn === 'sending_ip'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('recipient_domain')" style="cursor: pointer;">
                      Recipient Domain
                      <svg v-if="bounceSortColumn === 'recipient_domain'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('isp')" style="cursor: pointer;">
                      ISP
                      <svg v-if="bounceSortColumn === 'isp'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('bounce_type')" style="cursor: pointer;">
                      Bounce Type
                      <svg v-if="bounceSortColumn === 'bounce_type'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('bounce_reason')" style="cursor: pointer;">
                      Bounce Reason
                      <svg v-if="bounceSortColumn === 'bounce_reason'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('bounce_code')" style="cursor: pointer;">
                      Code
                      <svg v-if="bounceSortColumn === 'bounce_code'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                    <th @click="sortBounceTable('count')" style="cursor: pointer;">
                      Count
                      <svg v-if="bounceSortColumn === 'count'" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-left: 4px;" :style="{ transform: bounceSortOrder === 'desc' ? 'rotate(180deg)' : 'none' }">
                        <path d="M7 10l5 5 5-5z"/>
                      </svg>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(bounce, index) in sortedBounceData" :key="index">
                    <td>{{ bounce.event_date }}</td>
                    <td style="font-weight: 500; color: #1e293b;">{{ bounce.sending_domain }}</td>
                    <td class="text-mono" style="font-size: 12px; color: #64748b;">{{ bounce.sending_ip }}</td>
                    <td>{{ bounce.recipient_domain }}</td>
                    <td>
                      <span class="badge" :style="{
                        background: bounce.isp === 'Other' ? '#f1f5f9' : '#eff6ff',
                        color: bounce.isp === 'Other' ? '#64748b' : '#1e40af',
                        fontSize: '11px'
                      }">
                        {{ bounce.isp }}
                      </span>
                    </td>
                    <td style="text-align: center;">
                      <span class="badge" :style="{
                        background: getBounceTypeColor(bounce.bounce_type, 0.1),
                        color: getBounceTypeColor(bounce.bounce_type, 1),
                        fontSize: '11px',
                        fontWeight: '700'
                      }">
                        {{ bounce.bounce_type.toUpperCase() }}
                      </span>
                    </td>
                    <td style="max-width: 350px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" :title="bounce.bounce_reason">
                      {{ bounce.bounce_reason }}
                    </td>
                    <td class="text-mono" style="text-align: center; font-size: 12px; color: #64748b;">{{ bounce.bounce_code }}</td>
                    <td style="text-align: center; font-weight: 600; color: #1e293b;">{{ bounce.count }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Empty State -->
          <div v-else class="card-section" style="text-align: center; padding: 80px 20px;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <p style="font-size: 18px; font-weight: 600; color: #64748b; margin: 0 0 8px 0;">No bounce data found</p>
            <p style="font-size: 14px; color: #94a3b8; margin: 0;">Try selecting a different date range or domain</p>
          </div>
        </div>

        <!-- Industry Updates Page -->
        <div v-if="activePage === 'updates'">
          <!-- Page Header -->
          <div class="page-header">
            <div class="page-header-orb-1"></div>
            <div class="page-header-orb-2"></div>
            <div class="page-header-content">
              <div class="page-header-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/>
                </svg>
              </div>
              <div>
                <h1 class="page-header-title">Industry Updates</h1>
                <p class="page-header-subtitle">Critical news and updates from email deliverability ecosystem (Gmail, Outlook, Spamhaus, Barracuda, Proofpoint)</p>
              </div>
            </div>
          </div>

          <!-- Control Panel -->
          <div class="control-panel" style="flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üîç Source:</label>
              <select class="date-input" v-model="industrySourceType" :disabled="industryLoading" style="min-width: 160px;">
                <option value="">All Sources</option>
                <option v-for="source in industrySources" :key="source" :value="source">{{ source }}</option>
              </select>
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">‚ö†Ô∏è Severity:</label>
              <select class="date-input" v-model="industrySeverity" :disabled="industryLoading" style="min-width: 140px;">
                <option value="">All Severities</option>
                <option value="critical">Critical</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="info">Info</option>
              </select>
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #64748b;">üìÖ Range:</label>
              <select class="date-input" v-model="industryDays" :disabled="industryLoading" style="min-width: 140px;">
                <option :value="7">Last 7 Days</option>
                <option :value="14">Last 14 Days</option>
                <option :value="30">Last 30 Days</option>
                <option :value="60">Last 60 Days</option>
                <option :value="90">Last 90 Days</option>
              </select>
            </div>

            <button class="btn btn-primary" @click="loadIndustryUpdates" :disabled="industryLoading">
              <span v-if="industryLoading">‚è≥</span>
              <span v-else>üîÑ</span>
              {{ industryLoading ? 'Loading...' : 'Refresh' }}
            </button>

            <button class="btn btn-success" @click="refreshIndustryFeeds" :disabled="industryLoading" title="Fetch latest updates from RSS feeds">
              üì° Fetch Feeds
            </button>

            <div v-if="industryUpdates.length > 0" style="margin-left: auto; font-size: 13px; color: #64748b; font-weight: 500;">
              <strong>{{ industryUpdates.length }}</strong> updates
            </div>
          </div>

          <!-- Loading State -->
          <div v-if="industryLoading" class="card-section" style="text-align: center; padding: 80px 20px;">
            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
            <p style="font-size: 16px; font-weight: 500; color: #64748b;">Loading industry updates...</p>
          </div>

          <!-- Updates List -->
          <div v-else-if="industryUpdates.length > 0" style="display: flex; flex-direction: column; gap: 16px;">
            <div
              v-for="update in industryUpdates"
              :key="update.id"
              class="card-section"
              style="padding: 24px; transition: all 0.2s; cursor: pointer; position: relative;"
              @click="window.open(update.url, '_blank')"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.12)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'">

              <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                <div style="flex: 1;">
                  <!-- Title -->
                  <h3 style="font-size: 17px; font-weight: 700; color: #1e293b; margin: 0 0 12px 0; line-height: 1.4; display: flex; align-items: center; gap: 8px;">
                    {{ update.title }}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                  </h3>

                  <!-- Description -->
                  <p style="font-size: 14px; color: #475569; line-height: 1.6; margin: 0 0 16px 0;">
                    {{ truncateText(update.description, 250) }}
                  </p>

                  <!-- Metadata Row -->
                  <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <!-- Source Badge -->
                    <span class="badge" :style="{
                      background: update.source_type === 'Gmail' ? 'linear-gradient(135deg, #dbeafe, #bfdbfe)' :
                                  update.source_type === 'Outlook' ? 'linear-gradient(135deg, #e9d5ff, #d8b4fe)' :
                                  update.source_type === 'Spamhaus' ? 'linear-gradient(135deg, #fee2e2, #fecaca)' :
                                  'linear-gradient(135deg, #f1f5f9, #e2e8f0)',
                      color: update.source_type === 'Gmail' ? '#1e40af' :
                             update.source_type === 'Outlook' ? '#6b21a8' :
                             update.source_type === 'Spamhaus' ? '#991b1b' :
                             '#475569',
                      fontSize: '11px',
                      fontWeight: '700'
                    }">
                      {{ update.source }}
                    </span>

                    <!-- Date -->
                    <span style="font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 4px;">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      {{ formatDate(update.published_date) }}
                    </span>
                  </div>
                </div>

                <!-- Severity Badge -->
                <span :style="{
                  padding: '8px 16px',
                  borderRadius: '8px',
                  fontSize: '12px',
                  fontWeight: '800',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  background: getSeverityColor(update.severity, 0.12),
                  color: getSeverityColor(update.severity, 1),
                  border: '2px solid ' + getSeverityColor(update.severity, 0.25),
                  whiteSpace: 'nowrap',
                  boxShadow: '0 2px 8px ' + getSeverityColor(update.severity, 0.15)
                }">
                  {{ update.severity }}
                </span>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-else class="card-section" style="text-align: center; padding: 80px 20px;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5">
                <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/>
              </svg>
            </div>
            <p style="font-size: 18px; font-weight: 600; color: #64748b; margin: 0 0 8px 0;">No updates found</p>
            <p style="font-size: 14px; color: #94a3b8; margin: 0;">Try changing your filters or click Refresh to fetch the latest updates</p>
          </div>
        </div>

        <!-- Placeholder for other pages -->
        <div v-if="activePage !== 'pulsation' && activePage !== 'mbr' && activePage !== 'mappings' && activePage !== 'info' && activePage !== 'snds' && activePage !== 'gpt' && activePage !== 'bounces' && activePage !== 'updates'" style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">üöß</div>
          <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px;">Page Under Construction</h3>
          <p style="font-size: 14px; color: #64748b;">This page will be available soon with the premium design</p>
        </div>
      </div>
    </div>

    <!-- Send Email Modal -->
    <div v-if="showSendEmailModal" class="modal-overlay" @click.self="closeSendEmailModal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0;">üìß Send MBR Report via Email</h3>
          <button class="modal-close" @click="closeSendEmailModal">&times;</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" style="font-weight: 600; color: #475569; margin-bottom: 8px; display: block;">Recipients *</label>
            <div style="border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; max-height: 150px; overflow-y: auto; background: white;">
              <div v-if="emailRecipients.length === 0" style="color: #64748b; padding: 16px; text-align: center;">
                üì™ No recipients added yet.
                <a href="#" @click.prevent="openManageRecipientsModal" style="color: #2563eb; text-decoration: none; font-weight: 600;">Add recipients</a>
              </div>
              <label v-for="recipient in emailRecipients" :key="recipient.id" style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" :style="{ background: selectedRecipients.includes(recipient.email) ? '#eff6ff' : 'transparent' }">
                <input
                  type="checkbox"
                  :value="recipient.email"
                  v-model="selectedRecipients"
                  style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;"
                >
                <span style="font-size: 14px;"><strong>{{ recipient.name }}</strong> <span style="color: #64748b;">({{ recipient.email }})</span></span>
              </label>
            </div>
            <small style="color: #64748b; margin-top: 6px; display: block; font-size: 12px;">
              Selected: {{ selectedRecipients.length }} recipient(s)
            </small>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label class="form-label" style="font-weight: 600; color: #475569; margin-bottom: 8px; display: block;">Subject *</label>
            <input
              type="text"
              class="form-input"
              v-model="emailForm.subject"
              placeholder="Email subject..."
              style="width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;"
            >
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label class="form-label" style="font-weight: 600; color: #475569; margin-bottom: 8px; display: block;">Message (Optional)</label>
            <textarea
              class="form-input"
              v-model="emailForm.body"
              placeholder="Email body (HTML supported)..."
              rows="6"
              style="width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; font-family: 'Courier New', monospace; resize: vertical;"
            ></textarea>
            <small style="color: #64748b; font-size: 12px;">HTML formatting is supported</small>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" @click="closeSendEmailModal">Cancel</button>
          <button
            class="btn btn-primary"
            @click="sendReportEmail"
            :disabled="selectedRecipients.length === 0 || !emailForm.subject || sendingEmail"
          >
            <span v-if="sendingEmail" class="loading-spinner"></span>
            <span v-else>üì§</span>
            {{ sendingEmail ? 'Sending...' : 'Send Email' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Manage Recipients Modal -->
    <div v-if="showManageRecipientsModal" class="modal-overlay" @click.self="closeManageRecipientsModal">
      <div class="modal-content" style="max-width: 1200px; width: 95%;">
        <div class="modal-header">
          <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0;">
            üë• Manage Email Recipients
          </h3>
          <button class="modal-close" @click="closeManageRecipientsModal">&times;</button>
        </div>

        <div class="modal-body">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <p style="color: #475569; font-weight: 500; margin: 0;">Total: {{ emailRecipients.length }} recipient(s)</p>
            <button class="btn btn-primary" @click="openAddRecipientModal">
              <span>‚ûï</span> Add Recipient
            </button>
          </div>

          <div v-if="emailRecipients.length > 0" class="table-wrapper" style="border: 1px solid #e2e8f0; border-radius: 8px; overflow-x: auto; overflow-y: visible;">
            <table class="data-table" style="width: 100%; min-width: 900px;">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Notes</th>
                  <th style="width: 180px; text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="recipient in emailRecipients" :key="recipient.id">
                  <td style="font-weight: 600;">{{ recipient.name }}</td>
                  <td>{{ recipient.email }}</td>
                  <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ recipient.notes || '-' }}
                  </td>
                  <td style="text-align: center; white-space: nowrap; padding: 12px;">
                    <button
                      @click="editRecipient(recipient)"
                      style="
                        margin-right: 8px;
                        padding: 8px 16px;
                        font-size: 13px;
                        font-weight: 600;
                        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                        color: #0369a1;
                        border: 1px solid #bae6fd;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)'; this.style.boxShadow='0 2px 8px rgba(3, 105, 161, 0.2)';"
                      onmouseout="this.style.background='linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)'; this.style.boxShadow='none';"
                    >
                      <span style="font-size: 14px;">‚úèÔ∏è</span>
                      <span>Edit</span>
                    </button>
                    <button
                      @click="confirmDelete(recipient)"
                      style="
                        padding: 8px 16px;
                        font-size: 13px;
                        font-weight: 600;
                        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
                        color: #dc2626;
                        border: 1px solid #fecaca;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'; this.style.boxShadow='0 2px 8px rgba(220, 38, 38, 0.2)';"
                      onmouseout="this.style.background='linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)'; this.style.boxShadow='none';"
                    >
                      <span style="font-size: 14px;">üóëÔ∏è</span>
                      <span>Delete</span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div v-else style="padding: 48px; text-align: center; color: #64748b; background: #f8fafc; border-radius: 8px;">
            <div style="font-size: 40px; margin-bottom: 16px; opacity: 0.5;">üì™</div>
            <p style="margin: 0;">No recipients added yet. Click "Add Recipient" to get started.</p>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" @click="closeManageRecipientsModal">Close</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Recipient Modal -->
    <div v-if="showAddRecipientModal || showEditRecipientModal" class="modal-overlay" @click.self="closeRecipientModals">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0;">
            {{ showEditRecipientModal ? '‚úèÔ∏è Edit Recipient' : '‚ûï Add New Recipient' }}
          </h3>
          <button class="modal-close" @click="closeRecipientModals">&times;</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" style="font-weight: 600; color: #475569; margin-bottom: 8px; display: block;">Name *</label>
            <input
              type="text"
              class="form-input"
              v-model="recipientForm.name"
              placeholder="John Doe"
              style="width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;"
            >
          </div>

          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label" style="font-weight: 600; color: #475569; margin-bottom: 8px; display: block;">Email *</label>
            <input
              type="email"
              class="form-input"
              v-model="recipientForm.email"
              placeholder="john.doe@example.com"
              :disabled="showEditRecipientModal"
              style="width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;"
              :style="{ opacity: showEditRecipientModal ? 0.6 : 1, cursor: showEditRecipientModal ? 'not-allowed' : 'text' }"
            >
          </div>

          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label" style="font-weight: 600; color: #475569; margin-bottom: 8px; display: block;">Notes (Optional)</label>
            <textarea
              class="form-input"
              v-model="recipientForm.notes"
              placeholder="Additional notes..."
              rows="3"
              style="width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; resize: vertical;"
            ></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" @click="closeRecipientModals">Cancel</button>
          <button
            class="btn btn-primary"
            @click="showEditRecipientModal ? updateRecipient() : createRecipient()"
            :disabled="!recipientForm.name || !recipientForm.email"
          >
            <span>{{ showEditRecipientModal ? 'üíæ' : '‚ûï' }}</span>
            {{ showEditRecipientModal ? 'Update' : 'Create' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="showDeleteConfirmModal" class="modal-overlay" @click.self="cancelDelete">
      <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-bottom: 1px solid #fca5a5;">
          <h3 style="font-size: 18px; font-weight: 700; color: #991b1b; margin: 0;">
            ‚ö†Ô∏è Confirm Delete
          </h3>
          <button class="modal-close" @click="cancelDelete" style="color: #991b1b;">&times;</button>
        </div>

        <div class="modal-body" style="padding: 24px;">
          <p style="font-size: 15px; color: #475569; margin-bottom: 12px;">
            Are you sure you want to delete this recipient?
          </p>
          <div v-if="recipientToDelete" style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <p style="margin: 0; font-weight: 600; color: #1e293b;">{{ recipientToDelete.name }}</p>
            <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">{{ recipientToDelete.email }}</p>
          </div>
          <p style="font-size: 13px; color: #dc2626; margin-top: 12px; margin-bottom: 0;">
            This action cannot be undone.
          </p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" @click="cancelDelete" style="margin-right: 8px;">
            Cancel
          </button>
          <button
            class="btn"
            @click="deleteRecipient"
            style="
              background: linear-gradient(135deg, #dc2626, #b91c1c);
              color: white;
              border: none;
              box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            "
          >
            <span>üóëÔ∏è</span>
            <span>Delete Recipient</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Mapping Modal -->
    <div v-if="showAddMappingModal || showEditMappingModal" class="modal-overlay" @click.self="closeMappingModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header" :style="showEditMappingModal ? 'background: linear-gradient(135deg, #dbeafe, #bfdbfe);' : 'background: linear-gradient(135deg, #dcfce7, #bbf7d0);'">
        <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0;">
          {{ showEditMappingModal ? '‚úèÔ∏è Edit Mapping' : '‚ûï Add New Mapping' }}
        </h3>
        <button class="modal-close" @click="closeMappingModal">&times;</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" style="font-weight: 600; color: #1e293b; margin-bottom: 8px; display: block;">
            Sending Domain <span style="color: #dc2626;">*</span>
          </label>
          <input
            type="text"
            class="date-input"
            v-model="mappingForm.sending_domain"
            placeholder="example.com"
            :disabled="showEditMappingModal"
            style="width: 100%;"
          />
          <small v-if="showEditMappingModal" style="color: #64748b; font-size: 12px; display: block; margin-top: 4px;">
            Domain cannot be changed after creation
          </small>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label" style="font-weight: 600; color: #1e293b; margin-bottom: 8px; display: block;">
            Account Name <span style="color: #dc2626;">*</span>
          </label>
          <input
            type="text"
            class="date-input"
            v-model="mappingForm.account_name"
            placeholder="Acme Corporation"
            style="width: 100%;"
          />
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <input
              type="checkbox"
              v-model="mappingForm.is_affiliate"
              style="width: 20px; height: 20px; cursor: pointer; accent-color: #10b981;"
            />
            <div>
              <span style="font-weight: 600; color: #1e293b; display: block;">IsAffiliate</span>
              <small style="color: #64748b; font-size: 12px;">Check if this is an affiliate domain</small>
            </div>
          </label>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label" style="font-weight: 600; color: #1e293b; margin-bottom: 8px; display: block;">
            Notes (Optional)
          </label>
          <textarea
            class="date-input"
            v-model="mappingForm.notes"
            placeholder="Additional notes about this mapping..."
            rows="3"
            style="width: 100%; resize: vertical; font-family: inherit;"
          ></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button
          class="btn btn-secondary"
          @click="closeMappingModal"
          style="background: #f1f5f9; color: #64748b;"
        >
          ‚úï Cancel
        </button>
        <button
          class="btn btn-primary"
          @click="showEditMappingModal ? updateMapping() : createMapping()"
          :disabled="!mappingForm.sending_domain || !mappingForm.account_name"
          style="background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);"
        >
          <span v-if="mappingFormSubmitting" class="loading-spinner" style="width: 14px; height: 14px;"></span>
          <span v-else>{{ showEditMappingModal ? 'üíæ Update' : '‚úì Create' }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Mapping Confirmation Modal -->
  <div v-if="showDeleteMappingModal" class="modal-overlay" @click.self="cancelDeleteMapping">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
        <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0;">
          ‚ö†Ô∏è Confirm Delete
        </h3>
        <button class="modal-close" @click="cancelDeleteMapping">&times;</button>
      </div>

      <div class="modal-body">
        <p style="font-size: 15px; color: #1e293b; margin-bottom: 16px;">
          Are you sure you want to delete this mapping?
        </p>

        <div v-if="mappingToDelete" style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 600; color: #64748b; font-size: 12px; text-transform: uppercase;">Domain:</span>
            <p style="font-weight: 600; color: #1e293b; margin: 4px 0 0 0; font-family: monospace;">{{ mappingToDelete.sending_domain }}</p>
          </div>
          <div>
            <span style="font-weight: 600; color: #64748b; font-size: 12px; text-transform: uppercase;">Account:</span>
            <p style="font-weight: 600; color: #3b82f6; margin: 4px 0 0 0;">{{ mappingToDelete.account_name }}</p>
          </div>
        </div>

        <p style="margin-top: 16px; font-size: 13px; color: #dc2626; font-weight: 500;">
          ‚ö†Ô∏è This action cannot be undone
        </p>
      </div>

      <div class="modal-footer">
        <button
          class="btn btn-secondary"
          @click="cancelDeleteMapping"
          style="background: #f1f5f9; color: #64748b;"
        >
          ‚úï Cancel
        </button>
        <button
          class="btn"
          @click="deleteMapping"
          style="
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
          "
        >
          <span v-if="deletingMapping" class="loading-spinner" style="width: 14px; height: 14px;"></span>
          <span v-else>üóëÔ∏è Delete Mapping</span>
        </button>
      </div>
    </div>
  </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    const { createApp } = Vue;

    const vueApp = createApp({
      data() {
        return {
          // API Configuration - always use port 8001 for backend
          API_BASE: 'http://localhost:8001',

          // UI State
          sidebarCollapsed: false,
          activePage: 'pulsation',
          pages: [
            { key: 'pulsation', label: 'Pulsation', icon: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>' },
            { key: 'mbr', label: 'MBR Deliverability', icon: '<path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>' },
            { key: 'mappings', label: 'Account Mappings', icon: '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>' },
            { key: 'info', label: 'Account Info', icon: '<rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8"/><path d="M12 17v4"/>' },
            { key: 'snds', label: 'SNDS', icon: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>' },
            { key: 'gpt', label: 'GPT', icon: '<rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8l6 4 6-4"/>' },
            { key: 'bounces', label: 'Bounce Analytics', icon: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>' },
            { key: 'updates', label: 'Industry Updates', icon: '<path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/>' }
          ],

          // Pulsation State
          pulsationLoading: false,
          pulsationData: null,
          pulsationTab: 'overall',
          pulsationViewType: 'yesterday',
          pulsationCustomCollectDate: '',
          sortColumn: null,
          sortOrder: 'asc',
          sortDirection: 'asc',
          activeClassificationFilter: '',
          selectedDomain: '',
          chartDays: 30,
          chartData: null,
          activeCharts: {},

          // Animated counts for stat cards
          animatedCounts: {
            healthy: 0,
            monitor: 0,
            low: 0,
            critical: 0
          },

          // Toast notifications
          toasts: [],
          toastIdCounter: 0,

          // MBR Deliverability State
          mbrViewMode: 'domain',
          fromDate: '',
          toDate: '',
          loading: false,
          data: null,
          accountData: null,
          savingToDb: false,
          exporting: false,

          // Saved Reports
          savedReportsList: [],
          loadingReports: false,
          loadingReportId: null,
          deletingReportId: null,
          filterMonth: null,
          filterYear: null,

          // Email Recipients & Modals
          showSendEmailModal: false,
          showManageRecipientsModal: false,
          showAddRecipientModal: false,
          showEditRecipientModal: false,
          showDeleteConfirmModal: false,
          recipientToDelete: null,
          sendingEmail: false,
          emailRecipients: [],
          selectedRecipients: [],
          emailForm: {
            subject: '',
            body: ''
          },
          recipientForm: {
            id: null,
            name: '',
            email: '',
            notes: ''
          },

          // Account Mappings State
          accountStats: null,
          accountMappings: [],
          allAccountMappings: [], // Full dataset for search
          accountMappingsTotal: 0,
          accountMappingsLoading: false,
          accountSearchQuery: '',
          showAddMappingModal: false,
          showEditMappingModal: false,
          showDeleteMappingModal: false,
          mappingToDelete: null,
          deletingMapping: false,
          mappingFormSubmitting: false,
          mappingForm: {
            id: null,
            sending_domain: '',
            account_name: '',
            is_affiliate: false,
            notes: ''
          },
          // Animated counts for Account Mappings stat cards
          animatedMappingCounts: {
            totalMappings: 0,
            totalAccounts: 0
          },

          // Account Info State
          accountInfo: null,
          accountInfoLoading: false,
          accountInfoError: null,
          accountInfoFilters: {
            esp: '',
            region: '',
            domain: '',
            account_name: '',
            ip_addresses: '',
            subaccount: '',
            ip_pool: '',
            status: '',
            verified: '',
            created_at: ''
          },

          // SNDS State
          sndsOverview: null,
          sndsData: null,
          sndsLoading: false,
          sndsError: null,
          sndsTimePeriod: '30day',
          sndsViewBy: 'ip',
          sndsSelectedAccount: '',
          sndsSelectedIP: '',
          sndsAccountsList: [],
          sndsIPsList: [],
          sndsProblemIPs: [],
          sndsAnomalies: [],
          sndsTopPerformers: [],
          sndsReputationTrends: null,
          sndsTrafficTrends: null,
          sndsActiveTab: 'all', // all, top, worst, green, yellow, red
          sndsLastUpdated: null,
          // Animated counts for SNDS
          animatedSNDSCounts: {
            totalIPs: 0,
            totalAccounts: 0,
            totalMessages: 0,
            avgReputation: 0,
            avgSpamRate: 0,
            totalTrapHits: 0,
            greenCount: 0,
            yellowCount: 0,
            redCount: 0
          },
          // Chart instances
          sndsCharts: {
            reputationTrends: null,
            trafficVolume: null,
            spamTrap: null,
            filterDistribution: null,
            reputationDistribution: null
          },

          // GPT State
          gptAuthorized: false,
          gptLoading: false,
          gptError: null,
          gptTimePeriod: '30day',
          gptSelectedDomain: '',
          gptDomainsList: [],
          gptOverviewTable: null,
          gptDomainDetails: null,
          gptEnhancedChanges: [],
          gptLastUpdated: null,
          gptSortColumn: 'domain',
          gptSortOrder: 'asc',
          showGPTNotifications: false,
          showIPModal: false,
          gptCharts: {
            reputation: null,
            ipReputation: null,
            auth: null,
            spam: null
          },
          // Animated counts for GPT
          animatedGPTCounts: {
            totalDomains: 0,
            highDom: 0,
            medDom: 0,
            lowDom: 0,
            badDom: 0,
            highIP: 0,
            medIP: 0,
            lowIP: 0,
            badIP: 0
          },

          // Bounce Analytics State
          activeBounceESP: 'Mailgun',
          bounceStartDate: '',
          bounceEndDate: '',
          bounceSelectedDomain: 'all',
          bounceLoading: false,
          bounceData: [],
          bounceSendingDomains: [],
          bounceSortColumn: 'event_date',
          bounceSortOrder: 'desc',

          // Industry Updates State
          industryUpdates: [],
          industrySources: [],
          industrySourceType: '',
          industrySeverity: '',
          industryDays: 30,
          industryLoading: false
        };
      },
      computed: {
        filteredOverallData() {
          return this.getFilteredAndSorted(this.pulsationData?.overall_data || []);
        },
        filteredLowDeliveryData() {
          return this.getFilteredAndSorted(this.pulsationData?.top20_low_delivery || []);
        },
        filteredSpamData() {
          return this.getFilteredAndSorted(this.pulsationData?.top20_spam || []);
        },
        filteredBounceData() {
          return this.getFilteredAndSorted(this.pulsationData?.top20_bounce || []);
        },
        filteredRiskData() {
          return this.getFilteredAndSorted(this.pulsationData?.top20_risk || []);
        },
        // MBR Computed Properties
        hasData() {
          return this.data !== null;
        },
        hasAccountData() {
          return this.accountData !== null;
        },
        canFetch() {
          return this.fromDate && this.toDate && !this.loading;
        },
        overallSummary() {
          return this.data?.overall_summary || null;
        },
        espData() {
          return this.data?.esp_data || {};
        },
        espList() {
          return Object.keys(this.espData);
        },
        top10Overall() {
          return this.data?.top10_overall || [];
        },
        topAccountsByESP() {
          return this.accountData?.top_accounts_by_esp || {};
        },
        topAccountsOverall() {
          return this.accountData?.top10_accounts_overall || [];
        },
        affiliateAccounts() {
          return this.accountData?.affiliate_accounts || [];
        },
        // Filtered saved reports
        filteredSavedReports() {
          let filtered = this.savedReportsList;

          if (this.filterMonth !== null) {
            filtered = filtered.filter(r => r.month === this.filterMonth);
          }

          if (this.filterYear !== null) {
            filtered = filtered.filter(r => r.year === this.filterYear);
          }

          return filtered;
        },
        // Available months from saved reports
        availableMonths() {
          const months = [...new Set(this.savedReportsList.map(r => r.month).filter(m => m !== null))];
          return months.sort((a, b) => a - b);
        },
        // Available years from saved reports
        availableYears() {
          const years = [...new Set(this.savedReportsList.map(r => r.year).filter(y => y !== null))];
          return years.sort((a, b) => b - a); // Descending order
        },
        // SNDS Filtered Data
        filteredSNDSWorst() {
          // Use problem IPs data which is specifically for IPs with reputation < 50
          if (this.sndsProblemIPs && this.sndsProblemIPs.length > 0) {
            console.log('üìä Worst performers (from problem IPs):', this.sndsProblemIPs.length);
            return this.sndsProblemIPs.sort((a, b) => (a.reputation_score || 0) - (b.reputation_score || 0));
          }

          // Fallback to filtering sndsData if problem IPs not available
          if (!this.sndsData || this.sndsData.length === 0) {
            console.log('‚ö†Ô∏è filteredSNDSWorst: No data available');
            return [];
          }

          const worst = this.sndsData.filter(r => {
            const score = r.reputation_score || 0;
            return score < 50 && score > 0;
          }).sort((a, b) => a.reputation_score - b.reputation_score);

          console.log('üìä Worst performers (from sndsData):', worst.length, 'out of', this.sndsData.length, 'records');
          return worst;
        },
        filteredSNDSGreen() {
          if (!this.sndsData) return [];
          return this.sndsData.filter(r => r.filter_result === 'GREEN');
        },
        filteredSNDSYellow() {
          if (!this.sndsData) return [];
          return this.sndsData.filter(r => r.filter_result === 'YELLOW');
        },
        filteredSNDSRed() {
          if (!this.sndsData) return [];
          return this.sndsData.filter(r => r.filter_result === 'RED');
        },
        currentTabData() {
          let data = [];

          if (this.sndsActiveTab === 'top') {
            data = this.sndsTopPerformers || [];
          } else if (this.sndsActiveTab === 'worst') {
            data = this.filteredSNDSWorst;
          } else if (this.sndsActiveTab === 'green') {
            data = this.filteredSNDSGreen;
          } else if (this.sndsActiveTab === 'yellow') {
            data = this.filteredSNDSYellow;
          } else if (this.sndsActiveTab === 'red') {
            data = this.filteredSNDSRed;
          } else {
            data = this.sndsData || [];
          }

          console.log(`üìä currentTabData for tab '${this.sndsActiveTab}':`, data.length, 'records');
          return data;
        },
        // Filtered Account Info
        filteredAccountInfo() {
          if (!this.accountInfo || !this.accountInfo.data) return [];

          return this.accountInfo.data.filter(item => {
            // Apply all filters
            if (this.accountInfoFilters.esp && !item.esp.toLowerCase().includes(this.accountInfoFilters.esp.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.region && !item.region.toLowerCase().includes(this.accountInfoFilters.region.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.domain && !item.domain.toLowerCase().includes(this.accountInfoFilters.domain.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.account_name && !item.account_name.toLowerCase().includes(this.accountInfoFilters.account_name.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.ip_addresses && !item.ip_addresses.toLowerCase().includes(this.accountInfoFilters.ip_addresses.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.subaccount && !item.subaccount.toLowerCase().includes(this.accountInfoFilters.subaccount.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.ip_pool && !item.ip_pool.toLowerCase().includes(this.accountInfoFilters.ip_pool.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.status && !item.status.toLowerCase().includes(this.accountInfoFilters.status.toLowerCase())) {
              return false;
            }
            if (this.accountInfoFilters.verified) {
              const verifiedFilter = this.accountInfoFilters.verified.toLowerCase();
              const itemVerified = item.verified ? 'yes' : 'no';
              if (!itemVerified.includes(verifiedFilter)) {
                return false;
              }
            }
            if (this.accountInfoFilters.created_at && !item.created_at.toLowerCase().includes(this.accountInfoFilters.created_at.toLowerCase())) {
              return false;
            }
            return true;
          });
        },

        // GPT Computed Property
        sortedGPTTable() {
          if (!this.gptOverviewTable) return [];

          const sorted = [...this.gptOverviewTable].sort((a, b) => {
            let aVal = a[this.gptSortColumn];
            let bVal = b[this.gptSortColumn];

            // Handle special cases
            if (this.gptSortColumn === 'ip_reputation') {
              // Sort by first reputation key alphabetically
              aVal = Object.keys(a.ip_reputation || {})[0] || '';
              bVal = Object.keys(b.ip_reputation || {})[0] || '';
            }

            // Convert to lowercase for string comparison
            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();

            if (aVal < bVal) return this.gptSortOrder === 'asc' ? -1 : 1;
            if (aVal > bVal) return this.gptSortOrder === 'asc' ? 1 : -1;
            return 0;
          });

          return sorted;
        },

        // Bounce Analytics Computed Property
        sortedBounceData() {
          if (!this.bounceData || this.bounceData.length === 0) {
            return [];
          }

          const sorted = [...this.bounceData];
          const column = this.bounceSortColumn;
          const order = this.bounceSortOrder;

          sorted.sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];

            // Handle string comparison
            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();

            if (aVal < bVal) return order === 'asc' ? -1 : 1;
            if (aVal > bVal) return order === 'asc' ? 1 : -1;
            return 0;
          });

          return sorted;
        },

        // GPT Stats Computed Property
        gptStats() {
          if (!this.gptOverviewTable || this.gptOverviewTable.length === 0) {
            return {
              totalDomains: 0,
              domainRep: { HIGH: 0, MEDIUM: 0, LOW: 0, BAD: 0 },
              ipRep: { HIGH: 0, MEDIUM: 0, LOW: 0, BAD: 0 }
            };
          }

          const stats = {
            totalDomains: this.gptOverviewTable.length,
            domainRep: { HIGH: 0, MEDIUM: 0, LOW: 0, BAD: 0 },
            ipRep: { HIGH: 0, MEDIUM: 0, LOW: 0, BAD: 0 }
          };

          this.gptOverviewTable.forEach(item => {
            // Count domain reputation
            if (item.domain_reputation && stats.domainRep[item.domain_reputation] !== undefined) {
              stats.domainRep[item.domain_reputation]++;
            }

            // Count IP reputation
            if (item.ip_reputation && typeof item.ip_reputation === 'object') {
              Object.keys(item.ip_reputation).forEach(rep => {
                if (stats.ipRep[rep] !== undefined) {
                  stats.ipRep[rep] += item.ip_reputation[rep];
                }
              });
            }
          });

          return stats;
        }
      },
      methods: {
        async fetchPulsationData() {
          this.pulsationLoading = true;
          // Reset filters
          this.selectedDomain = '';
          this.sortColumn = '';
          this.sortDirection = 'asc';
          this.sortOrder = 'asc';
          this.activeClassificationFilter = '';

          try {
            // Correct API: POST /api/pulsation/query with body
            const response = await fetch(`${this.API_BASE}/api/pulsation/query`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                view_type: this.pulsationViewType
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to fetch data: ${response.status} ${errorText}`);
            }

            const result = await response.json();

            if (result.status === 'no_data') {
              this.showToast('info', 'No Data', result.message || 'No data available for the selected period');
              this.pulsationData = null;
            } else {
              this.pulsationData = result;
              // Trigger animation for stat cards
              this.animateStatCards();
              this.showToast('success', 'Data Loaded', 'Pulsation data loaded successfully');
            }
          } catch (error) {
            console.error('Error:', error);
            this.showToast('error', 'Load Failed', 'Failed to load pulsation data: ' + error.message);
          } finally {
            this.pulsationLoading = false;
          }
        },
        async collectYesterdayData() {
          this.pulsationLoading = true;
          try {
            // Correct API: POST /api/pulsation/collect-yesterday
            const response = await fetch(`${this.API_BASE}/api/pulsation/collect-yesterday`, {
              method: 'POST'
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to collect data: ${response.status} ${errorText}`);
            }

            const result = await response.json();
            this.showToast('success', 'Collection Started', result.message || 'Data collection started. This may take a few minutes.');

            // Refresh data
            await this.fetchPulsationData();
          } catch (error) {
            console.error('Error:', error);
            this.showToast('error', 'Collection Failed', 'Failed to collect data: ' + error.message);
          } finally {
            this.pulsationLoading = false;
          }
        },
        async collectCustomDate() {
          if (!this.pulsationCustomCollectDate) {
            this.showToast('warning', 'Date Required', 'Please select a date');
            return;
          }
          this.pulsationLoading = true;
          try {
            // Correct API: POST /api/pulsation/collect-date?date=YYYY-MM-DD
            const response = await fetch(`${this.API_BASE}/api/pulsation/collect-date?date=${this.pulsationCustomCollectDate}`, {
              method: 'POST'
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to collect data: ${response.status} ${errorText}`);
            }

            const result = await response.json();
            this.showToast('success', 'Collection Complete', result.message || 'Data collection completed!');

            // Refresh data
            await this.fetchPulsationData();
          } catch (error) {
            console.error('Error:', error);
            this.showToast('error', 'Collection Failed', 'Failed to collect data: ' + error.message);
          } finally {
            this.pulsationLoading = false;
          }
        },
        sortTable(column) {
          if (this.sortColumn === column) {
            this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortColumn = column;
            this.sortOrder = 'asc';
            this.sortDirection = 'asc';
          }
        },
        toggleClassificationFilter(classification) {
          if (this.activeClassificationFilter === classification) {
            this.activeClassificationFilter = '';
          } else {
            this.activeClassificationFilter = classification;
          }
        },
        getFilteredAndSorted(data) {
          if (!data || data.length === 0) return [];

          let result = [...data];

          // Apply classification filter
          if (this.activeClassificationFilter) {
            result = result.filter(row => row.classification === this.activeClassificationFilter);
          }

          // Apply sorting
          if (this.sortColumn) {
            result.sort((a, b) => {
              let aVal = a[this.sortColumn];
              let bVal = b[this.sortColumn];

              // Handle null/undefined values
              if (aVal == null) return 1;
              if (bVal == null) return -1;

              // Compare values
              if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
              }

              if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
              if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
              return 0;
            });
          }

          return result;
        },
        viewDomainCharts(domain) {
          this.selectedDomain = domain;
          this.chartDays = 30;
          this.pulsationTab = 'charts';
          this.$nextTick(() => {
            this.loadDomainCharts();
          });
        },
        async loadDomainCharts() {
          if (!this.selectedDomain) {
            this.destroyAllCharts();
            this.chartData = null;
            return;
          }

          try {
            const response = await fetch(
              `${this.API_BASE}/api/pulsation/domain-timeseries/${encodeURIComponent(this.selectedDomain)}?days=${this.chartDays}`
            );
            const result = await response.json();

            if (result.status === 'success' && result.data) {
              this.chartData = result.data;

              // Wait for DOM update
              this.$nextTick(() => {
                this.renderChart('chartSent', result.data.dates, result.data.sent, 'Sent', '#3498db');
                this.renderChart('chartDelivered', result.data.dates, result.data.delivered, 'Delivered', '#2ecc71');
                this.renderChart('chartDeliveryRate', result.data.dates, result.data.delivery_rate, 'Delivery Rate (%)', '#f39c12');
                this.renderChart('chartSpamRate', result.data.dates, result.data.spam_rate, 'Spam Rate (%)', '#e74c3c');
              });
            } else {
              this.chartData = null;
              this.showToast('info', 'No Chart Data', 'No chart data available for this domain');
            }
          } catch (err) {
            console.error('Error loading chart data:', err);
            this.showToast('error', 'Chart Error', 'Error loading chart data: ' + err.message);
            this.chartData = null;
          }
        },
        destroyChart(chartId) {
          if (this.activeCharts[chartId]) {
            this.activeCharts[chartId].destroy();
            delete this.activeCharts[chartId];
          }
        },
        destroyAllCharts() {
          Object.keys(this.activeCharts).forEach(chartId => {
            this.destroyChart(chartId);
          });
        },
        renderChart(canvasId, labels, data, label, color) {
          this.destroyChart(canvasId);

          const canvas = this.$refs[canvasId];
          if (!canvas) return;

          const ctx = canvas.getContext('2d');
          this.activeCharts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: label,
                data: data,
                borderColor: color || '#2563eb',
                backgroundColor: (color || '#2563eb') + '20',
                tension: 0.3,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        },
        formatNumber(num) {
          if (num === null || num === undefined) return '0';
          return new Intl.NumberFormat().format(num);
        },
        formatRate(rate) {
          if (rate === null || rate === undefined) return '0.00';
          return typeof rate === 'number' ? rate.toFixed(2) : rate;
        },
        getESPBadgeClass(esp) {
          const espLower = esp.toLowerCase();
          if (espLower.includes('send')) return 'badge-esp-sendgrid';
          if (espLower.includes('spark')) return 'badge-esp-sparkpost';
          return 'badge-esp-mailgun';
        },
        getProgressColor(rate) {
          if (rate >= 95) return '#10b981';
          if (rate >= 85) return '#f59e0b';
          return '#ef4444';
        },
        getProgressClass(rate) {
          if (rate >= 95) return 'progress-value-excellent';
          if (rate >= 85) return 'progress-value-good';
          return 'progress-value-poor';
        },
        generateSparklinePoints(data) {
          const width = 80;
          const height = 24;
          const max = Math.max(...data);
          const min = Math.min(...data);
          const range = max - min || 1;

          return data.map((v, i) => {
            const x = (i / (data.length - 1)) * width;
            const y = height - ((v - min) / range) * (height - 4) - 2;
            return `${x},${y}`;
          }).join(' ');
        },
        animateStatCards() {
          // Get target values from the data
          const targets = {
            healthy: this.pulsationData?.classification_counts?.['Green (Healthy)'] || 0,
            monitor: this.pulsationData?.classification_counts?.['Yellow (Monitor)'] || 0,
            low: this.pulsationData?.classification_counts?.['Orange (Low Delivery)'] || 0,
            critical: this.pulsationData?.classification_counts?.['Red (High Spam Complaints)'] || 0
          };

          const duration = 1000; // 1 second
          const startTime = Date.now();

          const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Update animated counts
            this.animatedCounts.healthy = Math.floor(progress * targets.healthy);
            this.animatedCounts.monitor = Math.floor(progress * targets.monitor);
            this.animatedCounts.low = Math.floor(progress * targets.low);
            this.animatedCounts.critical = Math.floor(progress * targets.critical);

            if (progress < 1) {
              requestAnimationFrame(animate);
            }
          };

          requestAnimationFrame(animate);
        },
        // Animate Account Mappings Stat Cards
        animateMappingStats() {
          // Get target values from the account stats
          const targets = {
            totalMappings: this.accountStats?.total_mappings || 0,
            totalAccounts: this.accountStats?.total_accounts || 0
          };

          const duration = 1000; // 1 second
          const startTime = Date.now();

          const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Update animated counts
            this.animatedMappingCounts.totalMappings = Math.floor(progress * targets.totalMappings);
            this.animatedMappingCounts.totalAccounts = Math.floor(progress * targets.totalAccounts);

            if (progress < 1) {
              requestAnimationFrame(animate);
            }
          };

          requestAnimationFrame(animate);
        },
        formatAnimatedNumber(num) {
          return num.toLocaleString();
        },
        getRowClass(classification) {
          if (!classification) return '';
          const classLower = classification.toLowerCase();
          if (classLower.includes('green') || classLower.includes('healthy')) return 'row-healthy';
          if (classLower.includes('yellow') || classLower.includes('monitor')) return 'row-monitor';
          if (classLower.includes('orange') || classLower.includes('low')) return 'row-low';
          if (classLower.includes('red') || classLower.includes('critical') || classLower.includes('spam')) return 'row-critical';
          return '';
        },
        formatRiskScore(score) {
          if (score === null || score === undefined) return '0.00';
          // Normalize risk score to 0-100 scale
          // If score is > 100, it means backend multiplied percentages by 100
          // So we divide by 10 to get proper scale
          let normalizedScore = typeof score === 'number' ? score : parseFloat(score);
          if (normalizedScore > 100) {
            normalizedScore = normalizedScore / 10;
          }
          return Math.min(normalizedScore, 100).toFixed(2);
        },
        showToast(type, title, message) {
          const id = this.toastIdCounter++;
          const icons = {
            success: '‚úì',
            error: '‚úï',
            warning: '‚ö†',
            info: '‚Ñπ'
          };

          const toast = {
            id,
            type,
            title,
            message,
            icon: icons[type] || '‚Ñπ',
            hiding: false
          };

          this.toasts.push(toast);

          // Auto-dismiss after 5 seconds
          setTimeout(() => {
            const toastIndex = this.toasts.findIndex(t => t.id === id);
            if (toastIndex !== -1) {
              this.toasts[toastIndex].hiding = true;
              setTimeout(() => {
                this.toasts = this.toasts.filter(t => t.id !== id);
              }, 300); // Wait for slide-out animation
            }
          }, 5000);
        },
        // MBR Methods
        async fetchMBRData() {
          if (!this.canFetch) return;

          if (this.mbrViewMode === 'domain') {
            await this.fetchData();
          } else {
            await this.fetchAccountData();
          }
        },
        async fetchData() {
          this.loading = true;
          try {
            const response = await fetch(`${this.API_BASE}/api/fetch-data`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                from_date: this.fromDate,
                to_date: this.toDate
              })
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || 'Failed to fetch data');
            }

            this.data = await response.json();
            this.showToast('success', 'Data Loaded', `Found ${this.data.total_domains || 0} domains`);
          } catch (err) {
            this.showToast('error', 'Load Failed', err.message);
            this.data = null;
          } finally {
            this.loading = false;
          }
        },
        async fetchAccountData() {
          this.loading = true;
          try {
            const response = await fetch(`${this.API_BASE}/api/fetch-data-by-account`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                from_date: this.fromDate,
                to_date: this.toDate
              })
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || 'Failed to fetch account data');
            }

            this.accountData = await response.json();
            this.showToast('success', 'Data Loaded', `Found ${this.accountData.total_accounts || 0} accounts`);
          } catch (err) {
            this.showToast('error', 'Load Failed', err.message);
            this.accountData = null;
          } finally {
            this.loading = false;
          }
        },
        getESPRegionData(esp) {
          const data = this.espData[esp];
          if (!data) return [];

          const rows = [];

          if (data.us_summary) {
            rows.push({ region: 'US', ...data.us_summary });
          }

          if (data.eu_summary) {
            rows.push({ region: 'EU', ...data.eu_summary });
          }

          if (data.combined_summary) {
            rows.push({ region: 'Total', ...data.combined_summary, isTotal: true });
          }

          return rows;
        },
        getESPTop10(esp) {
          const data = this.espData[esp];
          return data?.top10_domains || [];
        },
        getESPAccountTop10(esp) {
          const espData = this.topAccountsByESP[esp];
          return espData?.top10_accounts || [];
        },
        formatMoM(value) {
          if (value === null || value === undefined) return 'N/A';
          const sign = value >= 0 ? '+' : '';
          return `${sign}${value}%`;
        },
        getMoMClass(value) {
          if (value === null || value === undefined) return 'mom-na';
          if (value > 0) return 'mom-increase';
          if (value < 0) return 'mom-decrease';
          return '';
        },
        getHealthScoreClass(rating) {
          if (!rating) return '';
          switch (rating) {
            case 'Excellent':
              return 'health-excellent';
            case 'Good':
              return 'health-good';
            case 'Fair':
              return 'health-fair';
            case 'Poor':
              return 'health-poor';
            case 'Critical':
              return 'health-critical';
            default:
              return '';
          }
        },
        getRateClass(value, type) {
          if (value === null || value === undefined) return '';

          switch (type) {
            case 'delivery':
              return value >= 99 ? 'rate-good' : value >= 95 ? 'rate-warning' : 'rate-bad';
            case 'bounce':
            case 'spam':
            case 'unsub':
              return value <= 0.1 ? 'rate-good' : value <= 1 ? 'rate-warning' : 'rate-bad';
            case 'open':
              return value >= 20 ? 'rate-good' : value >= 10 ? 'rate-warning' : 'rate-bad';
            case 'click':
              return value >= 3 ? 'rate-good' : value >= 1 ? 'rate-warning' : 'rate-bad';
            default:
              return '';
          }
        },
        formatNumber(value) {
          if (value === null || value === undefined) return '-';
          return Number(value).toLocaleString('en-US');
        },
        formatRate(value) {
          if (value === null || value === undefined) return '-';
          return `${value}`;
        },
        setDefaultDates() {
          const today = new Date();
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

          this.fromDate = firstDay.toISOString().split('T')[0];
          this.toDate = today.toISOString().split('T')[0];
        },
        // Save Report to DB
        async saveReportToDB() {
          if (!this.hasData && !this.hasAccountData) {
            this.showToast('error', 'No Data', 'No data to save. Please fetch data first.');
            return;
          }

          const reportData = this.mbrViewMode === 'domain' ? this.data : this.accountData;
          if (!reportData) {
            this.showToast('error', 'No Data', 'No data available to save.');
            return;
          }

          this.savingToDb = true;

          try {
            const response = await fetch(`${this.API_BASE}/api/mbr/save-report`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                from_date: this.fromDate,
                to_date: this.toDate,
                report_type: this.mbrViewMode,
                report_data: reportData,
                overwrite: false
              })
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Saved', `Report saved successfully! (ID: ${result.report_id})`);
              this.fetchSavedReports();
            } else {
              this.showToast('error', 'Save Failed', result.message || 'Failed to save report');
            }
          } catch (err) {
            this.showToast('error', 'Save Error', 'Error saving report: ' + err.message);
          } finally {
            this.savingToDb = false;
          }
        },
        // Fetch Saved Reports
        async fetchSavedReports() {
          this.loadingReports = true;

          try {
            const response = await fetch(`${this.API_BASE}/api/mbr/reports?limit=100`);
            const result = await response.json();

            if (result.status === 'success') {
              this.savedReportsList = result.reports;
            } else {
              this.showToast('error', 'Load Failed', 'Failed to fetch saved reports');
            }
          } catch (err) {
            console.error('Error fetching saved reports:', err);
            this.savedReportsList = [];
          } finally {
            this.loadingReports = false;
          }
        },
        // Load Saved Report
        async loadSavedReport(reportId) {
          this.loadingReportId = reportId;

          try {
            const response = await fetch(`${this.API_BASE}/api/mbr/reports/${reportId}`);
            const result = await response.json();

            if (result.status === 'success' && result.report) {
              const report = result.report;

              // Switch to MBR tab
              this.activePage = 'mbr';

              // Set the dates from the report
              this.fromDate = report.from_date;
              this.toDate = report.to_date;

              // Load the report data based on type
              if (report.report_type === 'domain') {
                this.accountData = null;
                this.mbrViewMode = 'domain';
                this.data = { ...report.report_data };
                this.showToast('success', 'Loaded', `Loaded domain report (ID: ${reportId}) - ${report.total_domains} domains`);
              } else if (report.report_type === 'account') {
                this.data = null;
                this.mbrViewMode = 'account';
                this.accountData = { ...report.report_data };
                this.showToast('success', 'Loaded', `Loaded account report (ID: ${reportId}) - ${report.total_accounts} accounts`);
              }

              this.$nextTick(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
              });
            } else {
              this.showToast('error', 'Load Failed', 'Failed to load report');
            }
          } catch (err) {
            console.error('Error loading report:', err);
            this.showToast('error', 'Load Error', 'Error loading report: ' + err.message);
          } finally {
            this.loadingReportId = null;
          }
        },
        // Delete Saved Report
        async deleteSavedReport(reportId) {
          if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
            return;
          }

          this.deletingReportId = reportId;

          try {
            const response = await fetch(`${this.API_BASE}/api/mbr/reports/${reportId}`, {
              method: 'DELETE'
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Deleted', `Report deleted successfully (ID: ${reportId})`);
              await this.fetchSavedReports();
            } else {
              this.showToast('error', 'Delete Failed', result.message || 'Failed to delete report');
            }
          } catch (err) {
            console.error('Error deleting report:', err);
            this.showToast('error', 'Delete Error', 'Error deleting report: ' + err.message);
          } finally {
            this.deletingReportId = null;
          }
        },
        // Clear Filters
        clearFilters() {
          this.filterMonth = null;
          this.filterYear = null;
        },
        // Export Excel
        async exportExcel() {
          if (!this.hasData || this.exporting) return;

          this.exporting = true;

          try {
            await window.api.exportExcel(this.fromDate, this.toDate);
            this.showToast('success', 'Exported', 'Excel file downloaded successfully with all data!');
          } catch (err) {
            this.showToast('error', 'Export Failed', 'Failed to export Excel file');
          } finally {
            this.exporting = false;
          }
        },
        // Export PDF
        async exportPDF() {
          if (!this.hasData || this.exporting) return;

          this.exporting = true;

          try {
            await window.api.exportPDF(this.fromDate, this.toDate);
            this.showToast('success', 'Exported', 'PDF file downloaded successfully with all data!');
          } catch (err) {
            this.showToast('error', 'Export Failed', 'Failed to export PDF file');
          } finally {
            this.exporting = false;
          }
        },
        // Open Send Email Modal
        openSendEmailModal() {
          if (!this.hasData && !this.hasAccountData) {
            this.showToast('error', 'No Data', 'Please fetch data first before sending email');
            return;
          }

          // Pre-fill email subject and body
          this.emailForm.subject = `MBR Deliverability Report - ${this.fromDate} to ${this.toDate}`;
          this.emailForm.body = `
<html>
  <body style="font-family: Arial, sans-serif; color: #333;">
    <h2 style="color: #0C3C78;">Monthly Business Review (MBR) - Deliverability Report</h2>
    <p>Please find attached the MBR Deliverability Report for the period <strong>${this.fromDate} to ${this.toDate}</strong>.</p>
    <p>This report includes:</p>
    <ul>
      <li>Executive Summary with key metrics</li>
      <li>Domain-level analysis by ESP</li>
      <li>Account-level analysis</li>
      <li>Top 10 performing domains and accounts</li>
    </ul>
    <p style="margin-top: 20px;">Best regards,<br/>Blueshift Deliverability Team</p>
  </body>
</html>
          `;

          this.selectedRecipients = [];
          this.showSendEmailModal = true;
          this.fetchRecipients();
        },
        // Close Send Email Modal
        closeSendEmailModal() {
          this.showSendEmailModal = false;
          this.selectedRecipients = [];
          this.emailForm = { subject: '', body: '' };
        },
        // Send Report Email
        async sendReportEmail() {
          if (this.selectedRecipients.length === 0) {
            this.showToast('error', 'No Recipients', 'Please select at least one recipient');
            return;
          }

          if (!this.emailForm.subject) {
            this.showToast('error', 'No Subject', 'Please enter email subject');
            return;
          }

          this.sendingEmail = true;

          try {
            const response = await fetch(`${this.API_BASE}/api/send-report-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                recipient_emails: this.selectedRecipients,
                subject: this.emailForm.subject,
                body: this.emailForm.body,
                from_date: this.fromDate,
                to_date: this.toDate
              })
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Email Sent', `Email sent successfully to ${result.recipients.length} recipient(s)!`);
              this.closeSendEmailModal();
            } else {
              this.showToast('error', 'Send Failed', result.message || 'Failed to send email');
            }
          } catch (err) {
            this.showToast('error', 'Send Error', 'Error sending email: ' + err.message);
          } finally {
            this.sendingEmail = false;
          }
        },
        // Open Manage Recipients Modal
        openManageRecipientsModal() {
          this.showManageRecipientsModal = true;
          this.fetchRecipients();
        },
        // Close Manage Recipients Modal
        closeManageRecipientsModal() {
          this.showManageRecipientsModal = false;
        },
        // Open Add Recipient Modal
        openAddRecipientModal() {
          this.recipientForm = { id: null, name: '', email: '', notes: '' };
          this.showAddRecipientModal = true;
        },
        // Close Recipient Modals
        closeRecipientModals() {
          this.showAddRecipientModal = false;
          this.showEditRecipientModal = false;
          this.recipientForm = { id: null, name: '', email: '', notes: '' };
        },
        // Edit Recipient
        editRecipient(recipient) {
          this.recipientForm = {
            id: recipient.id,
            name: recipient.name,
            email: recipient.email,
            notes: recipient.notes || ''
          };
          this.showEditRecipientModal = true;
        },
        // Create Recipient
        async createRecipient() {
          if (!this.recipientForm.name || !this.recipientForm.email) {
            this.showToast('error', 'Missing Fields', 'Name and Email are required');
            return;
          }

          try {
            const response = await fetch(`${this.API_BASE}/api/email-recipients`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: this.recipientForm.name,
                email: this.recipientForm.email,
                notes: this.recipientForm.notes
              })
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
              this.showToast('success', 'Recipient Added', 'Recipient added successfully!');
              this.closeRecipientModals();
              this.fetchRecipients();
            } else {
              // Handle specific error cases
              if (response.status === 400) {
                const errorMsg = result.detail || result.message || 'Recipient already exists';
                this.showToast('warning', 'Duplicate Recipient', errorMsg);
              } else {
                this.showToast('error', 'Add Failed', result.detail || 'Failed to add recipient');
              }
            }
          } catch (err) {
            this.showToast('error', 'Add Error', 'Error adding recipient: ' + err.message);
          }
        },
        // Update Recipient
        async updateRecipient() {
          if (!this.recipientForm.name || !this.recipientForm.email) {
            this.showToast('error', 'Missing Fields', 'Name and Email are required');
            return;
          }

          try {
            const response = await fetch(`${this.API_BASE}/api/email-recipients/${this.recipientForm.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: this.recipientForm.name,
                email: this.recipientForm.email,
                notes: this.recipientForm.notes
              })
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Recipient Updated', 'Recipient updated successfully!');
              this.closeRecipientModals();
              this.fetchRecipients();
            } else {
              this.showToast('error', 'Update Failed', result.detail || 'Failed to update recipient');
            }
          } catch (err) {
            this.showToast('error', 'Update Error', 'Error updating recipient: ' + err.message);
          }
        },
        // Confirm Delete
        confirmDelete(recipient) {
          this.recipientToDelete = recipient;
          this.showDeleteConfirmModal = true;
        },
        // Cancel Delete
        cancelDelete() {
          this.recipientToDelete = null;
          this.showDeleteConfirmModal = false;
        },
        // Delete Recipient
        async deleteRecipient() {
          if (!this.recipientToDelete) return;

          const recipientId = this.recipientToDelete.id;
          this.showDeleteConfirmModal = false;

          try {
            const response = await fetch(`${this.API_BASE}/api/email-recipients/${recipientId}`, {
              method: 'DELETE'
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Recipient Deleted', 'Recipient deleted successfully!');
              this.fetchRecipients();
            } else {
              this.showToast('error', 'Delete Failed', result.detail || 'Failed to delete recipient');
            }
          } catch (err) {
            this.showToast('error', 'Delete Error', 'Error deleting recipient: ' + err.message);
          } finally {
            this.recipientToDelete = null;
          }
        },
        // Fetch Recipients
        async fetchRecipients() {
          try {
            const response = await fetch(`${this.API_BASE}/api/email-recipients?active_only=true`);
            const result = await response.json();

            if (result.status === 'success') {
              this.emailRecipients = result.recipients || [];
              console.log('‚úÖ Loaded recipients:', this.emailRecipients.length, 'recipients');
              console.log('Recipients data:', this.emailRecipients);
            } else {
              console.error('‚ùå Failed to load recipients:', result);
              this.emailRecipients = [];
            }
          } catch (err) {
            console.error('‚ùå Error loading email recipients:', err);
            this.emailRecipients = [];
          }
        },
        // Format DateTime
        formatDateTime(value) {
          if (!value) return '-';
          const date = new Date(value);
          return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        },
        // Format Date
        formatDate(value) {
          if (!value) return '-';
          const date = new Date(value);
          return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        },
        // Format Month Year
        formatMonthYear(month, year) {
          if (!month || !year) return null;
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
          return `${monthNames[month - 1]} ${year}`;
        },
        // Get Month Name
        getMonthName(month) {
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
          return monthNames[month - 1] || '';
        },

        // ======================
        // Account Mappings Methods
        // ======================

        // Load Account Mappings
        async loadAccountMappings() {
          this.accountMappingsLoading = true;
          console.log('üîÑ Loading account mappings...');
          try {
            // Fetch statistics
            const statsResponse = await fetch(`${this.API_BASE}/api/account-mappings/statistics`);
            const statsResult = await statsResponse.json();
            // Stats are directly on the result object, not nested under 'data'
            this.accountStats = {
              total_mappings: statsResult.total_mappings || 0,
              total_accounts: statsResult.total_accounts || 0
            };
            console.log('üìä Account stats:', this.accountStats);

            // Fetch mappings
            const mappingsResponse = await fetch(`${this.API_BASE}/api/account-mappings`);
            const mappingsResult = await mappingsResponse.json();
            console.log('üìã Mappings result:', mappingsResult);

            if (mappingsResult.status === 'success') {
              this.allAccountMappings = mappingsResult.mappings || [];
              this.accountMappings = this.allAccountMappings;
              this.accountMappingsTotal = mappingsResult.total || 0;
              this.accountSearchQuery = ''; // Reset search
              this.showToast('success', 'Loaded', `${this.accountMappings.length} mappings loaded successfully`);
              // Animate stat cards
              if (this.accountStats) {
                this.animateMappingStats();
              }
            } else {
              this.showToast('error', 'Load Failed', mappingsResult.detail || 'Failed to load mappings');
            }
          } catch (err) {
            this.showToast('error', 'Load Error', 'Error loading mappings: ' + err.message);
          } finally {
            this.accountMappingsLoading = false;
          }
        },

        // Search Account Mappings
        searchAccountMappings() {
          if (!this.accountSearchQuery) {
            // If search is empty, show all mappings
            this.accountMappings = this.allAccountMappings;
            return;
          }

          const query = this.accountSearchQuery.toLowerCase();
          this.accountMappings = this.allAccountMappings.filter(m =>
            m.sending_domain.toLowerCase().includes(query) ||
            m.account_name.toLowerCase().includes(query)
          );
        },

        // Open Add Mapping Modal
        openAddMappingModal() {
          this.mappingForm = {
            id: null,
            sending_domain: '',
            account_name: '',
            is_affiliate: false,
            notes: ''
          };
          this.showAddMappingModal = true;
          this.showEditMappingModal = false;
        },

        // Edit Mapping
        editMapping(mapping) {
          this.mappingForm = {
            id: mapping.id,
            sending_domain: mapping.sending_domain,
            account_name: mapping.account_name,
            is_affiliate: mapping.is_affiliate || false,
            notes: mapping.notes || ''
          };
          this.showEditMappingModal = true;
          this.showAddMappingModal = false;
        },

        // Create Mapping
        async createMapping() {
          if (!this.mappingForm.sending_domain || !this.mappingForm.account_name) {
            this.showToast('warning', 'Validation Error', 'Domain and Account Name are required');
            return;
          }

          this.mappingFormSubmitting = true;
          try {
            const response = await fetch(`${this.API_BASE}/api/account-mappings`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                sending_domain: this.mappingForm.sending_domain,
                account_name: this.mappingForm.account_name,
                is_affiliate: this.mappingForm.is_affiliate,
                notes: this.mappingForm.notes || null
              })
            });

            const result = await response.json();

            if (response.status === 201 && result.status === 'success') {
              this.showToast('success', 'Mapping Created', 'Account mapping created successfully!');
              this.closeMappingModal();
              this.loadAccountMappings();
            } else if (response.status === 400) {
              const errorMsg = result.detail || result.message || 'Mapping already exists';
              this.showToast('warning', 'Duplicate Mapping', errorMsg);
            } else {
              this.showToast('error', 'Create Failed', result.detail || 'Failed to create mapping');
            }
          } catch (err) {
            this.showToast('error', 'Create Error', 'Error creating mapping: ' + err.message);
          } finally {
            this.mappingFormSubmitting = false;
          }
        },

        // Update Mapping
        async updateMapping() {
          if (!this.mappingForm.account_name) {
            this.showToast('warning', 'Validation Error', 'Account Name is required');
            return;
          }

          this.mappingFormSubmitting = true;
          try {
            const response = await fetch(`${this.API_BASE}/api/account-mappings/${this.mappingForm.id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                account_name: this.mappingForm.account_name,
                is_affiliate: this.mappingForm.is_affiliate,
                notes: this.mappingForm.notes || null
              })
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Mapping Updated', 'Account mapping updated successfully!');
              this.closeMappingModal();
              this.loadAccountMappings();
            } else {
              this.showToast('error', 'Update Failed', result.detail || 'Failed to update mapping');
            }
          } catch (err) {
            this.showToast('error', 'Update Error', 'Error updating mapping: ' + err.message);
          } finally {
            this.mappingFormSubmitting = false;
          }
        },

        // Confirm Delete Mapping
        confirmDeleteMapping(mapping) {
          this.mappingToDelete = mapping;
          this.showDeleteMappingModal = true;
        },

        // Cancel Delete Mapping
        cancelDeleteMapping() {
          this.mappingToDelete = null;
          this.showDeleteMappingModal = false;
        },

        // Delete Mapping
        async deleteMapping() {
          if (!this.mappingToDelete) return;

          const mappingId = this.mappingToDelete.id;
          this.deletingMapping = true;

          try {
            const response = await fetch(`${this.API_BASE}/api/account-mappings/${mappingId}`, {
              method: 'DELETE'
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Mapping Deleted', 'Account mapping deleted successfully!');
              this.showDeleteMappingModal = false;
              this.mappingToDelete = null;
              this.loadAccountMappings();
            } else {
              this.showToast('error', 'Delete Failed', result.detail || 'Failed to delete mapping');
            }
          } catch (err) {
            this.showToast('error', 'Delete Error', 'Error deleting mapping: ' + err.message);
          } finally {
            this.deletingMapping = false;
          }
        },

        // Close Mapping Modal
        closeMappingModal() {
          this.showAddMappingModal = false;
          this.showEditMappingModal = false;
          this.mappingForm = {
            id: null,
            sending_domain: '',
            account_name: '',
            is_affiliate: false,
            notes: ''
          };
        },

        // Import CSV
        async importCSV() {
          try {
            const response = await fetch(`${this.API_BASE}/api/account-mappings/import-csv`, {
              method: 'POST'
            });

            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'CSV Imported', `Successfully imported ${result.imported || 0} mappings`);
              this.loadAccountMappings();
            } else {
              this.showToast('error', 'Import Failed', result.detail || 'Failed to import CSV');
            }
          } catch (err) {
            this.showToast('error', 'Import Error', 'Error importing CSV: ' + err.message);
          }
        },

        // Export CSV
        async exportCSV() {
          try {
            const response = await fetch(`${this.API_BASE}/api/account-mappings/export-csv`);

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `account_mappings_${new Date().toISOString().split('T')[0]}.csv`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);

              this.showToast('success', 'CSV Exported', 'Account mappings exported successfully');
            } else {
              this.showToast('error', 'Export Failed', 'Failed to export CSV');
            }
          } catch (err) {
            this.showToast('error', 'Export Error', 'Error exporting CSV: ' + err.message);
          }
        },

        // ======================
        // Account Info Methods
        // ======================

        // Fetch Account Info
        async fetchAccountInfo(forceRefresh = false) {
          this.accountInfoLoading = true;
          this.accountInfoError = null;
          console.log('üîÑ Fetching account info (force_refresh=' + forceRefresh + ')...');

          try {
            const response = await fetch(`${this.API_BASE}/api/account-info?force_refresh=${forceRefresh}`);
            const result = await response.json();
            console.log('üìä Account info result:', result);

            if (result.status === 'success') {
              this.accountInfo = result;
              this.showToast('success', 'Data Loaded', `Loaded ${result.total_records} ESP account records`);
            } else {
              this.accountInfoError = result.detail || 'Failed to fetch account info';
              this.showToast('error', 'Load Failed', this.accountInfoError);
            }
          } catch (err) {
            this.accountInfoError = 'Error fetching account info: ' + err.message;
            this.showToast('error', 'Load Error', this.accountInfoError);
          } finally {
            this.accountInfoLoading = false;
          }
        },

        // Clear Account Info Filters
        clearAccountInfoFilters() {
          this.accountInfoFilters = {
            esp: '',
            region: '',
            domain: '',
            account_name: '',
            ip_addresses: '',
            subaccount: '',
            ip_pool: '',
            status: '',
            verified: '',
            created_at: ''
          };
          this.showToast('success', 'Filters Cleared', 'All filters have been reset');
        },

        // Clear Account Info Cache
        async clearAccountInfoCache() {
          try {
            const response = await fetch(`${this.API_BASE}/api/account-info/clear-cache`, {
              method: 'POST'
            });
            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Cache Cleared', 'Account info cache has been cleared');
              // Refresh data after clearing cache
              this.fetchAccountInfo(true);
            } else {
              this.showToast('error', 'Clear Failed', result.detail || 'Failed to clear cache');
            }
          } catch (err) {
            this.showToast('error', 'Clear Error', 'Error clearing cache: ' + err.message);
          }
        },

        // ======================
        // SNDS Methods
        // ======================

        // Load SNDS Data
        async loadSNDSData() {
          this.sndsLoading = true;
          this.sndsError = null;
          console.log('üîÑ Loading SNDS data...');

          try {
            // Load overview
            const overviewResponse = await fetch(`${this.API_BASE}/api/snds/overview?period=${this.sndsTimePeriod}`);
            const overviewResult = await overviewResponse.json();
            console.log('üìä SNDS overview:', overviewResult);

            this.sndsOverview = overviewResult;
            this.sndsLastUpdated = new Date().toISOString();

            // Animate stat cards
            this.animateSNDSStats();

            // Load lists for dropdowns
            const [accountsRes, ipsRes] = await Promise.all([
              fetch(`${this.API_BASE}/api/snds/accounts?period=${this.sndsTimePeriod}`),
              fetch(`${this.API_BASE}/api/snds/ips?period=${this.sndsTimePeriod}`)
            ]);
            const accountsData = await accountsRes.json();
            const ipsData = await ipsRes.json();

            this.sndsAccountsList = accountsData.accounts || [];
            this.sndsIPsList = ipsData.ips || [];
            console.log('üìã Loaded accounts:', this.sndsAccountsList.length, 'IPs:', this.sndsIPsList.length);

            // Load data table
            const dataResponse = await fetch(`${this.API_BASE}/api/snds/data?period=${this.sndsTimePeriod}&view_by=${this.sndsViewBy}${this.sndsSelectedAccount ? '&account_name=' + this.sndsSelectedAccount : ''}${this.sndsSelectedIP ? '&ip_address=' + this.sndsSelectedIP : ''}`);
            const dataResult = await dataResponse.json();
            console.log('üìã SNDS data records:', dataResult.data?.length || 0);

            this.sndsData = dataResult.data || [];

            // Load top performers, problem IPs, and anomalies
            const [topPerformersRes, problemIPsRes, anomaliesRes] = await Promise.all([
              fetch(`${this.API_BASE}/api/snds/top-performers?period=${this.sndsTimePeriod}&view_by=${this.sndsViewBy}`),
              fetch(`${this.API_BASE}/api/snds/problem-ips?period=${this.sndsTimePeriod}`),
              fetch(`${this.API_BASE}/api/snds/anomalies?period=${this.sndsTimePeriod}`)
            ]);
            const topPerformersData = await topPerformersRes.json();
            const problemIPsData = await problemIPsRes.json();
            const anomaliesData = await anomaliesRes.json();

            this.sndsTopPerformers = topPerformersData.top_performers || topPerformersData.performers || [];
            this.sndsProblemIPs = problemIPsData.problem_ips || [];
            this.sndsAnomalies = anomaliesData.anomalies || [];
            console.log('üìã Top performers:', this.sndsTopPerformers.length, 'Problem IPs:', this.sndsProblemIPs.length, 'Anomalies:', this.sndsAnomalies.length);

            if (this.sndsTopPerformers.length > 0) {
              console.log('‚úÖ Sample top performer:', JSON.stringify(this.sndsTopPerformers[0], null, 2));
            }
            if (this.sndsProblemIPs.length > 0) {
              console.log('‚úÖ Sample problem IP:', JSON.stringify(this.sndsProblemIPs[0], null, 2));
            }
            if (this.sndsAnomalies.length > 0) {
              console.log('‚úÖ Sample anomaly:', JSON.stringify(this.sndsAnomalies[0], null, 2));
            }

            // Load chart data
            await this.loadSNDSCharts();

            this.showToast('success', 'SNDS Data Loaded', `Loaded data for ${this.sndsOverview.total_ips} IPs`);
          } catch (err) {
            this.sndsError = 'Error loading SNDS data: ' + err.message;
            this.showToast('error', 'Load Error', this.sndsError);
          } finally {
            this.sndsLoading = false;
          }
        },

        // Load SNDS Charts Data
        async loadSNDSCharts() {
          try {
            const [reputationRes, trafficRes] = await Promise.all([
              fetch(`${this.API_BASE}/api/snds/reputation-trends?period=${this.sndsTimePeriod}&group_by=${this.sndsViewBy}`),
              fetch(`${this.API_BASE}/api/snds/traffic-trends?period=${this.sndsTimePeriod}&group_by=${this.sndsViewBy}`)
            ]);

            const reputationData = await reputationRes.json();
            const trafficData = await trafficRes.json();

            console.log('üìà Reputation trends data:', reputationData);
            console.log('üìà Traffic trends data:', trafficData);

            // Store chart data for rendering
            this.sndsReputationTrends = reputationData;
            this.sndsTrafficTrends = trafficData;

            // Render charts after a short delay to ensure DOM is ready
            setTimeout(() => {
              this.$nextTick(() => {
                console.log('üé® Attempting to render charts...');
                this.renderSNDSCharts();
              });
            }, 500);
          } catch (err) {
            console.error('‚ùå Error loading chart data:', err);
          }
        },

        // Render SNDS Charts
        renderSNDSCharts() {
          console.log('üìä Rendering SNDS charts...');
          console.log('Chart data available:', {
            reputationTrends: this.sndsReputationTrends,
            trafficTrends: this.sndsTrafficTrends,
            overview: this.sndsOverview,
            sndsData: this.sndsData?.length || 0
          });

          // Destroy existing charts if they exist
          Object.values(this.sndsCharts).forEach(chart => {
            if (chart) chart.destroy();
          });

          if (!this.sndsReputationTrends || !this.sndsTrafficTrends) {
            console.warn('‚ö†Ô∏è No trends data available for charts');
            return;
          }

          // 1. Reputation Trends Chart (Line Chart)
          if (this.sndsReputationTrends && this.sndsReputationTrends.trends) {
            const ctx = document.getElementById('reputationTrendsChart');
            console.log('üìà Reputation chart context:', ctx);
            if (ctx) {
              const trends = this.sndsReputationTrends.trends;
              const entities = Object.keys(trends).slice(0, 5); // Top 5
              console.log('üìà Entities:', entities);

              if (entities.length === 0) {
                console.warn('‚ö†Ô∏è No entities in reputation trends');
                return;
              }

              const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
              const datasets = entities.map((entity, index) => ({
                label: entity,
                data: trends[entity].scores || [],
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                tension: 0.4,
                fill: false,
                borderWidth: 2
              }));

              const labels = trends[entities[0]]?.dates || [];

              this.sndsCharts.reputationTrends = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: datasets
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: true,
                      position: 'bottom',
                      labels: { color: '#64748b', font: { size: 11 } }
                    },
                    tooltip: {
                      mode: 'index',
                      intersect: false,
                      backgroundColor: '#1e293b',
                      padding: 12
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 100,
                      ticks: { color: '#64748b' },
                      grid: { color: '#e2e8f0' },
                      title: { display: true, text: 'Reputation Score', color: '#64748b' }
                    },
                    x: {
                      ticks: { color: '#64748b' },
                      grid: { display: false }
                    }
                  }
                }
              });
              console.log('‚úÖ Reputation chart created');
            }
          }

          // 2. Traffic Volume Chart (Bar Chart)
          if (this.sndsTrafficTrends && this.sndsTrafficTrends.trends) {
            const ctx = document.getElementById('trafficVolumeChart');
            console.log('üìä Traffic chart context:', ctx);
            if (ctx) {
              const trends = this.sndsTrafficTrends.trends;
              const entities = Object.keys(trends).slice(0, 5);

              if (entities.length === 0) {
                console.warn('‚ö†Ô∏è No entities in traffic trends');
                return;
              }

              const colors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'];
              const datasets = entities.map((entity, index) => ({
                label: entity,
                data: trends[entity].volumes || [],
                backgroundColor: colors[index] + 'CC',
                borderColor: colors[index],
                borderWidth: 1
              }));

              const labels = trends[entities[0]]?.dates || [];

              this.sndsCharts.trafficVolume = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: labels,
                  datasets: datasets
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: true,
                      position: 'bottom',
                      labels: { color: '#64748b', font: { size: 11 } }
                    },
                    tooltip: {
                      mode: 'index',
                      intersect: false,
                      backgroundColor: '#1e293b',
                      padding: 12,
                      callbacks: {
                        label: (context) => context.dataset.label + ': ' + context.parsed.y.toLocaleString()
                      }
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      stacked: false,
                      ticks: {
                        color: '#64748b',
                        callback: (value) => value >= 1000000 ? (value/1000000).toFixed(1) + 'M' : value >= 1000 ? (value/1000).toFixed(0) + 'K' : value
                      },
                      grid: { color: '#e2e8f0' },
                      title: { display: true, text: 'Message Volume', color: '#64748b' }
                    },
                    x: {
                      ticks: { color: '#64748b' },
                      grid: { display: false }
                    }
                  }
                }
              });
              console.log('‚úÖ Traffic chart created');
            }
          }

          // 3. Spam & Trap Analysis Chart (Multi-line)
          if (this.sndsReputationTrends && this.sndsReputationTrends.trends) {
            const ctx = document.getElementById('spamTrapChart');
            console.log('üêõ Spam/Trap chart context:', ctx);
            if (ctx) {
              const trends = this.sndsReputationTrends.trends;
              const entities = Object.keys(trends).slice(0, 3); // Top 3 for clarity

              if (entities.length === 0) {
                console.warn('‚ö†Ô∏è No entities for spam/trap chart');
                return;
              }

              const colors = ['#ef4444', '#f59e0b', '#f97316'];
              const datasets = [];

              // Add spam rate datasets
              entities.forEach((entity, index) => {
                datasets.push({
                  label: `${entity} - Spam Rate`,
                  data: trends[entity].spam_rates || [],
                  borderColor: colors[index],
                  backgroundColor: colors[index] + '20',
                  tension: 0.4,
                  yAxisID: 'y',
                  borderWidth: 2
                });
              });

              const labels = trends[entities[0]]?.dates || [];

              this.sndsCharts.spamTrap = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: datasets
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: true,
                      position: 'bottom',
                      labels: { color: '#64748b', font: { size: 10 } }
                    },
                    tooltip: {
                      mode: 'index',
                      intersect: false,
                      backgroundColor: '#1e293b',
                      padding: 12
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      title: { display: true, text: 'Spam Rate (%)', color: '#64748b' },
                      ticks: { color: '#64748b' },
                      grid: { color: '#e2e8f0' }
                    },
                    x: {
                      ticks: { color: '#64748b', maxRotation: 45, minRotation: 0 },
                      grid: { display: false }
                    }
                  }
                }
              });
              console.log('‚úÖ Spam/Trap chart created');
            }
          }

          // 4. Filter Status Distribution (Pie Chart)
          if (this.sndsOverview && this.sndsOverview.filter_distribution) {
            const ctx = document.getElementById('filterDistributionChart');
            console.log('ü•ß Filter dist chart context:', ctx, 'Distribution:', this.sndsOverview.filter_distribution);
            if (ctx) {
              const dist = this.sndsOverview.filter_distribution;

              this.sndsCharts.filterDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                  labels: ['GREEN', 'YELLOW', 'RED'],
                  datasets: [{
                    data: [dist.GREEN || 0, dist.YELLOW || 0, dist.RED || 0],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 2,
                    borderColor: '#fff'
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'bottom',
                      labels: { color: '#64748b', padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                      backgroundColor: '#1e293b',
                      padding: 12,
                      callbacks: {
                        label: (context) => context.label + ': ' + context.parsed + ' IPs'
                      }
                    }
                  }
                }
              });
            }
          } else {
            console.warn('‚ö†Ô∏è No filter distribution data available');
          }

          // 5. Reputation Score Distribution (Bar Chart)
          if (this.sndsData && this.sndsData.length > 0) {
            const ctx = document.getElementById('reputationDistributionChart');
            console.log('üìä Reputation dist chart context:', ctx, 'Records:', this.sndsData.length);
            if (ctx) {
              // Create distribution buckets
              const buckets = {
                '0-20': 0,
                '21-40': 0,
                '41-60': 0,
                '61-80': 0,
                '81-100': 0
              };

              this.sndsData.forEach(record => {
                const score = record.reputation_score || 0;
                if (score <= 20) buckets['0-20']++;
                else if (score <= 40) buckets['21-40']++;
                else if (score <= 60) buckets['41-60']++;
                else if (score <= 80) buckets['61-80']++;
                else buckets['81-100']++;
              });

              console.log('üìä Reputation distribution buckets:', buckets);

              this.sndsCharts.reputationDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: Object.keys(buckets),
                  datasets: [{
                    label: 'Number of Records',
                    data: Object.values(buckets),
                    backgroundColor: [
                      '#ef4444',
                      '#f97316',
                      '#f59e0b',
                      '#10b981',
                      '#059669'
                    ]
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false },
                    tooltip: {
                      backgroundColor: '#1e293b',
                      padding: 12
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: { color: '#64748b' },
                      grid: { color: '#e2e8f0' }
                    },
                    x: {
                      ticks: { color: '#64748b' },
                      grid: { display: false }
                    }
                  }
                }
              });
            }
          } else {
            console.warn('‚ö†Ô∏è No SNDS data available for reputation distribution');
          }

          console.log('‚úÖ Charts rendering complete. Chart instances:', {
            reputationTrends: !!this.sndsCharts.reputationTrends,
            trafficVolume: !!this.sndsCharts.trafficVolume,
            spamTrap: !!this.sndsCharts.spamTrap,
            filterDistribution: !!this.sndsCharts.filterDistribution,
            reputationDistribution: !!this.sndsCharts.reputationDistribution
          });
        },

        // Animate SNDS Stat Cards
        animateSNDSStats() {
          const targets = {
            totalIPs: this.sndsOverview?.total_ips || 0,
            totalAccounts: this.sndsOverview?.total_accounts || 0,
            totalMessages: this.sndsOverview?.total_messages || 0,
            avgReputation: this.sndsOverview?.avg_reputation_score || 0,
            avgSpamRate: this.sndsOverview?.avg_spam_rate || 0,
            totalTrapHits: this.sndsOverview?.total_trap_hits || 0,
            greenCount: this.sndsOverview?.filter_distribution?.GREEN || 0,
            yellowCount: this.sndsOverview?.filter_distribution?.YELLOW || 0,
            redCount: this.sndsOverview?.filter_distribution?.RED || 0
          };

          const duration = 1000; // 1 second
          const startTime = Date.now();

          const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Update animated counts
            this.animatedSNDSCounts.totalIPs = Math.floor(progress * targets.totalIPs);
            this.animatedSNDSCounts.totalAccounts = Math.floor(progress * targets.totalAccounts);
            this.animatedSNDSCounts.totalMessages = Math.floor(progress * targets.totalMessages);
            this.animatedSNDSCounts.avgReputation = Math.floor(progress * targets.avgReputation * 10) / 10; // 1 decimal
            this.animatedSNDSCounts.avgSpamRate = Math.floor(progress * targets.avgSpamRate * 10) / 10; // 1 decimal
            this.animatedSNDSCounts.totalTrapHits = Math.floor(progress * targets.totalTrapHits);
            this.animatedSNDSCounts.greenCount = Math.floor(progress * targets.greenCount);
            this.animatedSNDSCounts.yellowCount = Math.floor(progress * targets.yellowCount);
            this.animatedSNDSCounts.redCount = Math.floor(progress * targets.redCount);

            if (progress < 1) {
              requestAnimationFrame(animate);
            }
          };

          requestAnimationFrame(animate);
        },

        // Animate GPT Stat Cards
        animateGPTStats() {
          const stats = this.gptStats;
          const targets = {
            totalDomains: stats.totalDomains,
            highDom: stats.domainRep.HIGH,
            medDom: stats.domainRep.MEDIUM,
            lowDom: stats.domainRep.LOW,
            badDom: stats.domainRep.BAD,
            highIP: stats.ipRep.HIGH,
            medIP: stats.ipRep.MEDIUM,
            lowIP: stats.ipRep.LOW,
            badIP: stats.ipRep.BAD
          };

          const duration = 1000; // 1 second
          const startTime = Date.now();

          const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Update animated counts
            this.animatedGPTCounts.totalDomains = Math.floor(progress * targets.totalDomains);
            this.animatedGPTCounts.highDom = Math.floor(progress * targets.highDom);
            this.animatedGPTCounts.medDom = Math.floor(progress * targets.medDom);
            this.animatedGPTCounts.lowDom = Math.floor(progress * targets.lowDom);
            this.animatedGPTCounts.badDom = Math.floor(progress * targets.badDom);
            this.animatedGPTCounts.highIP = Math.floor(progress * targets.highIP);
            this.animatedGPTCounts.medIP = Math.floor(progress * targets.medIP);
            this.animatedGPTCounts.lowIP = Math.floor(progress * targets.lowIP);
            this.animatedGPTCounts.badIP = Math.floor(progress * targets.badIP);

            if (progress < 1) {
              requestAnimationFrame(animate);
            }
          };

          requestAnimationFrame(animate);
        },

        // Format Large Numbers (e.g., 7495786 -> 7.5M)
        formatLargeNumber(num) {
          if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
          } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
          }
          return num.toString();
        },

        // Export SNDS Data as CSV
        async exportSNDSData() {
          if (!this.sndsData || this.sndsData.length === 0) {
            this.showToast('warning', 'No Data', 'No SNDS data to export');
            return;
          }

          try {
            // Create CSV content
            const headers = Object.keys(this.sndsData[0]).join(',');
            const rows = this.sndsData.map(row =>
              Object.values(row).map(val =>
                typeof val === 'string' && val.includes(',') ? `"${val}"` : val
              ).join(',')
            );
            const csv = [headers, ...rows].join('\n');

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `snds_data_${this.sndsTimePeriod}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            this.showToast('success', 'CSV Exported', 'SNDS data exported successfully');
          } catch (err) {
            this.showToast('error', 'Export Error', 'Error exporting CSV: ' + err.message);
          }
        },

        // Get Reputation Color based on score
        getReputationColor(score) {
          if (score >= 80) return '#10b981'; // Green
          if (score >= 60) return '#f59e0b'; // Yellow/Orange
          if (score >= 40) return '#f97316'; // Orange
          return '#ef4444'; // Red
        },

        // Get Reputation Background Color
        getReputationBgColor(score) {
          if (score >= 80) return 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
          if (score >= 60) return 'linear-gradient(135deg, #fef3c7, #fde68a)';
          if (score >= 40) return 'linear-gradient(135deg, #fed7aa, #fdba74)';
          return 'linear-gradient(135deg, #fee2e2, #fecaca)';
        },

        // Get Filter Color based on result
        getFilterColor(filter) {
          if (filter === 'GREEN') return '#10b981';
          if (filter === 'YELLOW') return '#f59e0b';
          if (filter === 'RED') return '#ef4444';
          return '#64748b';
        },

        // Get Filter Background Color
        getFilterBgColor(filter) {
          if (filter === 'GREEN') return 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
          if (filter === 'YELLOW') return 'linear-gradient(135deg, #fef3c7, #fde68a)';
          if (filter === 'RED') return 'linear-gradient(135deg, #fee2e2, #fecaca)';
          return 'linear-gradient(135deg, #f1f5f9, #e2e8f0)';
        },

        // Anomaly Severity Helper Methods
        getAnomalySeverityColor(severity) {
          const severityLower = (severity || '').toLowerCase();
          if (severityLower === 'critical') return '#dc2626'; // Red
          if (severityLower === 'high') return '#ea580c'; // Orange
          if (severityLower === 'medium') return '#f59e0b'; // Yellow
          if (severityLower === 'low') return '#3b82f6'; // Blue
          if (severityLower === 'info') return '#10b981'; // Green
          return '#64748b'; // Gray
        },

        getAnomalySeverityBg(severity) {
          const severityLower = (severity || '').toLowerCase();
          if (severityLower === 'critical') return 'linear-gradient(135deg, #fee2e2, #fecaca)';
          if (severityLower === 'high') return 'linear-gradient(135deg, #fed7aa, #fdba74)';
          if (severityLower === 'medium') return 'linear-gradient(135deg, #fef3c7, #fde68a)';
          if (severityLower === 'low') return 'linear-gradient(135deg, #dbeafe, #bfdbfe)';
          if (severityLower === 'info') return 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
          return 'linear-gradient(135deg, #f1f5f9, #e2e8f0)';
        },

        getAnomalySeverityBorder(severity) {
          const severityLower = (severity || '').toLowerCase();
          if (severityLower === 'critical') return '#fca5a5';
          if (severityLower === 'high') return '#fdba74';
          if (severityLower === 'medium') return '#fde68a';
          if (severityLower === 'low') return '#93c5fd';
          if (severityLower === 'info') return '#86efac';
          return '#cbd5e1';
        },

        getAnomalySeverityIconBg(severity) {
          const severityLower = (severity || '').toLowerCase();
          if (severityLower === 'critical') return '#fee2e2';
          if (severityLower === 'high') return '#fed7aa';
          if (severityLower === 'medium') return '#fef3c7';
          if (severityLower === 'low') return '#dbeafe';
          if (severityLower === 'info') return '#dcfce7';
          return '#f1f5f9';
        },

        getAnomalyTypeIcon(type) {
          const typeLower = (type || '').toLowerCase();
          if (typeLower.includes('reputation')) return '‚ö†Ô∏è';
          if (typeLower.includes('spam')) return 'ü¶†';
          if (typeLower.includes('trap')) return 'üï∑Ô∏è';
          if (typeLower.includes('traffic')) return 'üìâ';
          if (typeLower.includes('bounce')) return '‚Ü©Ô∏è';
          if (typeLower.includes('volume')) return 'üìä';
          return 'üîî';
        },

        // ======================
        // GPT Methods
        // ======================

        async checkGPTAuthStatus() {
          try {
            const response = await fetch(`${this.API_BASE}/api/gpt/auth-status`);
            const result = await response.json();
            this.gptAuthorized = result.authorized || false;
          } catch (err) {
            console.error('Error checking GPT auth status:', err);
          }
        },

        async authorizeGPT() {
          try {
            const response = await fetch(`${this.API_BASE}/api/gpt/authorize`);
            const result = await response.json();

            if (result.authorization_url) {
              window.location.href = result.authorization_url;
            } else {
              this.showToast('error', 'Authorization Failed', 'Could not get authorization URL');
            }
          } catch (err) {
            this.showToast('error', 'Authorization Error', err.message);
          }
        },

        async handleGPTCallback(code) {
          try {
            const response = await fetch(`${this.API_BASE}/api/gpt/callback?code=${code}`);
            const result = await response.json();

            if (result.status === 'success') {
              this.gptAuthorized = true;
              this.showToast('success', 'Authorized', 'Successfully connected to Google Postmaster Tools');
              await this.loadGPTData();
            }
          } catch (err) {
            this.showToast('error', 'Callback Error', err.message);
          }
        },

        async loadGPTData() {
          if (!this.gptAuthorized) {
            await this.checkGPTAuthStatus();
            if (!this.gptAuthorized) {
              return;
            }
          }

          this.gptLoading = true;
          this.gptError = null;

          try {
            // Load domains list (always needed)
            const domainsResponse = await fetch(`${this.API_BASE}/api/gpt/domains`);
            if (!domainsResponse.ok) throw new Error('Failed to fetch domains list');
            const domainsResult = await domainsResponse.json();
            this.gptDomainsList = domainsResult.domains || [];

            // Dual-view logic: Load overview table OR detailed domain view
            if (!this.gptSelectedDomain || this.gptSelectedDomain === '') {
              // Overview mode: Load yesterday's data for all domains
              await this.loadGPTOverviewTable();
            } else {
              // Detailed mode: Load metrics for selected domain
              await this.loadGPTDomainDetails(this.gptSelectedDomain);
            }

            this.gptLastUpdated = this.formatDateTime(new Date());
            this.gptError = null;
          } catch (error) {
            console.error('GPT Error:', error);
            this.gptError = 'Error: ' + error.message;
            this.showToast('error', 'Load Error', this.gptError);
          } finally {
            this.gptLoading = false;
          }
        },

        async loadGPTOverviewTable() {
          try {
            // Load yesterday's overview table
            const tableResponse = await fetch(`${this.API_BASE}/api/gpt/overview-table`);
            if (!tableResponse.ok) throw new Error('Failed to fetch overview table');
            const tableResult = await tableResponse.json();
            this.gptOverviewTable = tableResult.domains || [];

            // Load enhanced reputation changes
            const changesResponse = await fetch(`${this.API_BASE}/api/gpt/enhanced-changes`);
            if (!changesResponse.ok) throw new Error('Failed to fetch enhanced changes');
            const changesResult = await changesResponse.json();
            this.gptEnhancedChanges = changesResult.changes || [];

            // Clear detailed view data
            this.gptDomainDetails = null;

            // Animate stat cards
            this.animateGPTStats();

            this.showToast('success', 'Data Loaded', `Loaded ${this.gptOverviewTable.length} domains`);
          } catch (error) {
            console.error('GPT Overview Table Error:', error);
            throw error;
          }
        },

        async loadGPTDomainDetails(domain) {
          try {
            // Load detailed metrics for selected domain
            const detailsResponse = await fetch(`${this.API_BASE}/api/gpt/domain-details?domain=${encodeURIComponent(domain)}&period=${this.gptTimePeriod}`);
            if (!detailsResponse.ok) throw new Error('Failed to fetch domain details');
            this.gptDomainDetails = await detailsResponse.json();

            // Clear overview table data
            this.gptOverviewTable = [];
            this.gptEnhancedChanges = [];

            // Create charts after data is loaded
            await this.$nextTick();
            this.createGPTCharts();

            this.showToast('success', 'Data Loaded', `Loaded details for ${domain}`);
          } catch (error) {
            console.error('GPT Domain Details Error:', error);
            throw error;
          }
        },

        async collectGPTData() {
          this.gptLoading = true;
          this.gptError = null;

          try {
            this.showToast('info', 'Collecting Data', 'Fetching data from Google Postmaster Tools...');
            const response = await fetch(`${this.API_BASE}/api/gpt/collect`, { method: 'POST' });
            const result = await response.json();

            if (result.status === 'success') {
              this.showToast('success', 'Collection Complete', result.message || 'Data collected successfully');
              await this.loadGPTData();
            } else {
              this.gptError = result.detail || 'Failed to collect data';
              this.showToast('error', 'Collection Failed', this.gptError);
            }
          } catch (err) {
            this.gptError = 'Error collecting data: ' + err.message;
            this.showToast('error', 'Collection Error', this.gptError);
          } finally {
            this.gptLoading = false;
          }
        },

        selectDomainForDetails(domain) {
          this.gptSelectedDomain = domain;
          this.gptDomainDetails = null;
          this.loadGPTDomainDetails(domain);
        },

        clearDomainSelection() {
          this.gptSelectedDomain = '';
          this.gptDomainDetails = null;
          this.destroyGPTCharts();
          this.loadGPTOverviewTable();
        },

        onDomainChange() {
          if (this.gptSelectedDomain) {
            this.selectDomainForDetails(this.gptSelectedDomain);
          } else {
            this.clearDomainSelection();
          }
        },

        toggleGPTNotifications() {
          this.showGPTNotifications = !this.showGPTNotifications;
        },

        sortGPTTable(column) {
          if (this.gptSortColumn === column) {
            this.gptSortOrder = this.gptSortOrder === 'asc' ? 'desc' : 'asc';
          } else {
            this.gptSortColumn = column;
            this.gptSortOrder = 'asc';
          }
        },

        hasGPTChange(domain) {
          return this.gptEnhancedChanges.some(change => change.domain === domain);
        },

        getGPTChangeColor(domain) {
          const change = this.gptEnhancedChanges.find(c => c.domain === domain);
          if (!change) return '#64748b';
          if (change.change_type === 'degraded') return '#dc2626';
          if (change.change_type === 'improved') return '#16a34a';
          return '#3b82f6';
        },

        getGPTChangeMessages(domain) {
          const changes = this.gptEnhancedChanges.filter(c => c.domain === domain);
          return changes.map(c => c.message).join('; ');
        },

        getGPTReputationColor(reputation, alpha = 1) {
          const repLower = (reputation || '').toLowerCase();
          if (repLower === 'high') return alpha === 1 ? '#16a34a' : 'rgba(22, 163, 74, ' + alpha + ')';
          if (repLower === 'medium') return alpha === 1 ? '#f59e0b' : 'rgba(245, 158, 11, ' + alpha + ')';
          if (repLower === 'low') return alpha === 1 ? '#f97316' : 'rgba(249, 115, 22, ' + alpha + ')';
          if (repLower === 'bad') return alpha === 1 ? '#dc2626' : 'rgba(220, 38, 38, ' + alpha + ')';
          return alpha === 1 ? '#64748b' : 'rgba(100, 116, 139, ' + alpha + ')';
        },

        getGPTReputationBgColor(reputation) {
          const repLower = (reputation || '').toLowerCase();
          if (repLower === 'high') return 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
          if (repLower === 'medium') return 'linear-gradient(135deg, #fef3c7, #fde68a)';
          if (repLower === 'low') return 'linear-gradient(135deg, #fed7aa, #fdba74)';
          if (repLower === 'bad') return 'linear-gradient(135deg, #fee2e2, #fecaca)';
          return 'linear-gradient(135deg, #f1f5f9, #e2e8f0)';
        },

        showIPReputationModal() {
          this.showIPModal = true;
        },

        destroyGPTCharts() {
          Object.values(this.gptCharts).forEach(chart => {
            if (chart) chart.destroy();
          });
          this.gptCharts = {
            reputation: null,
            ipReputation: null,
            auth: null,
            spam: null
          };
        },

        createGPTCharts() {
          if (!this.gptDomainDetails || !this.gptDomainDetails.trends) {
            console.warn('‚ö†Ô∏è No domain details or trends data');
            return;
          }

          this.destroyGPTCharts();

          const trends = this.gptDomainDetails.trends;
          if (!trends.dates || trends.dates.length === 0) {
            console.warn('‚ö†Ô∏è No dates in trends');
            return;
          }

          console.log('üìä Creating GPT charts with data:', {
            dates: trends.dates.length,
            domainRep: trends.domain_reputation?.length,
            ipRepBreakdown: Object.keys(trends.ip_reputation_breakdown || {})
          });

          // 1. Domain Reputation Chart
          const repCtx = document.getElementById('gptReputationChart');
          if (repCtx) {
            // API returns numeric values OR strings, handle both
            const reputationValues = trends.domain_reputation.map(r => {
              // If already a number, use it directly
              if (typeof r === 'number') return r;
              // If string, convert to number
              const rUpper = String(r).toUpperCase();
              if (rUpper === 'HIGH') return 4;
              if (rUpper === 'MEDIUM') return 3;
              if (rUpper === 'LOW') return 2;
              if (rUpper === 'BAD') return 1;
              return 0;
            });

            this.gptCharts.reputation = new Chart(repCtx, {
              type: 'line',
              data: {
                labels: trends.dates,
                datasets: [{
                  label: 'Domain Reputation',
                  data: reputationValues,
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    backgroundColor: '#1e293b',
                    padding: 12,
                    callbacks: {
                      label: (context) => {
                        const labels = ['N/A', 'BAD', 'LOW', 'MEDIUM', 'HIGH'];
                        return 'Reputation: ' + labels[context.parsed.y];
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    min: 0,
                    max: 4,
                    ticks: {
                      color: '#64748b',
                      callback: (value) => {
                        const labels = ['N/A', 'BAD', 'LOW', 'MEDIUM', 'HIGH'];
                        return labels[value] || '';
                      }
                    },
                    grid: { color: '#e2e8f0' }
                  },
                  x: {
                    ticks: { color: '#64748b', maxRotation: 45, minRotation: 0 },
                    grid: { display: false }
                  }
                }
              }
            });
          }

          // 2. IP Reputation Chart
          const ipCtx = document.getElementById('gptIpReputationChart');
          if (ipCtx && trends.ip_reputation_breakdown) {
            const datasets = [];
            const reputations = ['HIGH', 'MEDIUM', 'LOW', 'BAD'];
            const colors = ['#16a34a', '#f59e0b', '#f97316', '#dc2626'];

            reputations.forEach((rep, index) => {
              const data = trends.ip_reputation_breakdown[rep] || [];
              datasets.push({
                label: rep,
                data: data,
                borderColor: colors[index],
                backgroundColor: colors[index] + '33',
                tension: 0.4,
                fill: true,
                borderWidth: 2
              });
            });

            this.gptCharts.ipReputation = new Chart(ipCtx, {
              type: 'line',
              data: {
                labels: trends.dates,
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: { color: '#64748b', font: { size: 11 } }
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: '#1e293b',
                    padding: 12
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    stacked: true,
                    ticks: { color: '#64748b' },
                    grid: { color: '#e2e8f0' }
                  },
                  x: {
                    ticks: { color: '#64748b', maxRotation: 45, minRotation: 0 },
                    grid: { display: false }
                  }
                }
              }
            });
          }

          // 3. Authentication Rates Chart
          const authCtx = document.getElementById('gptAuthChart');
          if (authCtx && trends.spf_rate) {
            this.gptCharts.auth = new Chart(authCtx, {
              type: 'line',
              data: {
                labels: trends.dates,
                datasets: [
                  {
                    label: 'SPF',
                    data: trends.spf_rate,
                    borderColor: '#16a34a',
                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                  },
                  {
                    label: 'DKIM',
                    data: trends.dkim_rate,
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                  },
                  {
                    label: 'DMARC',
                    data: trends.dmarc_rate,
                    borderColor: '#14b8a6',
                    backgroundColor: 'rgba(20, 184, 166, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: { color: '#64748b', font: { size: 11 } }
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: '#1e293b',
                    padding: 12,
                    callbacks: {
                      label: (context) => context.dataset.label + ': ' + context.parsed.y + '%'
                    }
                  }
                },
                scales: {
                  y: {
                    min: 0,
                    max: 100,
                    ticks: { color: '#64748b', callback: (value) => value + '%' },
                    grid: { color: '#e2e8f0' }
                  },
                  x: {
                    ticks: { color: '#64748b', maxRotation: 45, minRotation: 0 },
                    grid: { display: false }
                  }
                }
              }
            });
          }

          // 4. Spam Rate Chart
          const spamCtx = document.getElementById('gptSpamChart');
          if (spamCtx && trends.spam_rate) {
            this.gptCharts.spam = new Chart(spamCtx, {
              type: 'line',
              data: {
                labels: trends.dates,
                datasets: [{
                  label: 'Spam Rate',
                  data: trends.spam_rate,
                  borderColor: '#dc2626',
                  backgroundColor: 'rgba(220, 38, 38, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    backgroundColor: '#1e293b',
                    padding: 12,
                    callbacks: {
                      label: (context) => 'Spam Rate: ' + context.parsed.y + '%'
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { color: '#64748b', callback: (value) => value + '%' },
                    grid: { color: '#e2e8f0' }
                  },
                  x: {
                    ticks: { color: '#64748b', maxRotation: 45, minRotation: 0 },
                    grid: { display: false }
                  }
                }
              }
            });
          }

          console.log('‚úÖ GPT charts created successfully');
        },

        // ======================
        // Bounce Analytics Methods
        // ======================

        async loadBounceData() {
          this.bounceLoading = true;

          try {
            // Load sending domains for the selected ESP
            const domainsResponse = await fetch(`${this.API_BASE}/api/bounces/${this.activeBounceESP}/domains`);
            if (domainsResponse.ok) {
              const domainsData = await domainsResponse.json();
              this.bounceSendingDomains = domainsData.domains || [];
            }

            // Load bounce data
            const params = new URLSearchParams({
              start_date: this.bounceStartDate,
              end_date: this.bounceEndDate
            });

            if (this.bounceSelectedDomain && this.bounceSelectedDomain !== 'all') {
              params.append('sending_domain', this.bounceSelectedDomain);
            }

            const response = await fetch(`${this.API_BASE}/api/bounces/${this.activeBounceESP}?${params}`);

            if (response.ok) {
              const data = await response.json();
              this.bounceData = data.bounces || [];
              this.showToast('success', 'Data Loaded', `Loaded ${this.bounceData.length} bounce events`);
            } else {
              throw new Error('Failed to load bounce data');
            }
          } catch (error) {
            console.error('Error loading bounce data:', error);
            this.showToast('error', 'Load Error', error.message);
          } finally {
            this.bounceLoading = false;
          }
        },

        sortBounceTable(column) {
          if (this.bounceSortColumn === column) {
            this.bounceSortOrder = this.bounceSortOrder === 'asc' ? 'desc' : 'asc';
          } else {
            this.bounceSortColumn = column;
            this.bounceSortOrder = 'asc';
          }
        },

        async exportBounceCSV() {
          try {
            const params = new URLSearchParams({
              esp: this.activeBounceESP,
              start_date: this.bounceStartDate,
              end_date: this.bounceEndDate
            });

            if (this.bounceSelectedDomain && this.bounceSelectedDomain !== 'all') {
              params.append('sending_domain', this.bounceSelectedDomain);
            }

            const response = await fetch(`${this.API_BASE}/api/bounces/export-csv?${params}`);

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              const domainSuffix = (this.bounceSelectedDomain && this.bounceSelectedDomain !== 'all')
                ? `_${this.bounceSelectedDomain}`
                : '';
              a.download = `bounces_${this.activeBounceESP.toLowerCase()}_${this.bounceStartDate}_${this.bounceEndDate}${domainSuffix}.csv`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
              this.showToast('success', 'Exported', 'CSV file downloaded successfully');
            } else {
              throw new Error('Failed to export CSV');
            }
          } catch (error) {
            console.error('Error exporting CSV:', error);
            this.showToast('error', 'Export Failed', error.message);
          }
        },

        getBounceTypeColor(type, opacity) {
          const typeLower = (type || '').toLowerCase();
          if (opacity === 1) {
            if (typeLower === 'hard') return '#ef4444';
            if (typeLower === 'soft') return '#f97316';
            if (typeLower === 'block') return '#eab308';
            return '#6b7280';
          } else {
            if (typeLower === 'hard') return 'rgba(239, 68, 68, 0.1)';
            if (typeLower === 'soft') return 'rgba(249, 115, 22, 0.1)';
            if (typeLower === 'block') return 'rgba(234, 179, 8, 0.1)';
            return 'rgba(107, 114, 128, 0.1)';
          }
        },

        initBounceDates() {
          // Set default dates to yesterday
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          this.bounceStartDate = yesterdayStr;
          this.bounceEndDate = yesterdayStr;
        },

        // ======================
        // Industry Updates Methods
        // ======================

        async loadIndustryUpdates() {
          this.industryLoading = true;

          try {
            // Build query parameters
            const params = new URLSearchParams({
              limit: '50',
              days: this.industryDays.toString()
            });

            if (this.industrySourceType) {
              params.append('source_type', this.industrySourceType);
            }

            if (this.industrySeverity) {
              params.append('severity', this.industrySeverity);
            }

            const response = await fetch(`${this.API_BASE}/api/industry-updates?${params}`);

            if (response.ok) {
              const data = await response.json();
              this.industryUpdates = data.updates || [];
              this.showToast('success', 'Updates Loaded', `Loaded ${this.industryUpdates.length} industry updates`);

              // Load sources list if empty
              if (this.industrySources.length === 0) {
                await this.loadIndustrySources();
              }
            } else {
              throw new Error('Failed to load industry updates');
            }
          } catch (error) {
            console.error('Error loading industry updates:', error);
            this.showToast('error', 'Load Error', error.message);
          } finally {
            this.industryLoading = false;
          }
        },

        async loadIndustrySources() {
          try {
            const response = await fetch(`${this.API_BASE}/api/industry-updates/sources`);
            if (response.ok) {
              const data = await response.json();
              this.industrySources = data.sources || [];
            }
          } catch (error) {
            console.error('Error loading industry sources:', error);
          }
        },

        async refreshIndustryFeeds() {
          this.industryLoading = true;

          try {
            const response = await fetch(`${this.API_BASE}/api/industry-updates/refresh`, {
              method: 'POST'
            });

            if (response.ok) {
              const data = await response.json();
              this.showToast('success', 'Feeds Refreshed', data.message || 'RSS feeds updated successfully');

              // Reload updates after refresh
              await this.loadIndustryUpdates();
            } else {
              throw new Error('Failed to refresh industry updates');
            }
          } catch (error) {
            console.error('Error refreshing industry updates:', error);
            this.showToast('error', 'Refresh Failed', error.message);
          } finally {
            this.industryLoading = false;
          }
        },

        getSeverityColor(severity, opacity) {
          const sevLower = (severity || '').toLowerCase();
          if (opacity === 1) {
            if (sevLower === 'critical') return '#dc2626';
            if (sevLower === 'high') return '#f97316';
            if (sevLower === 'medium') return '#eab308';
            return '#3b82f6';
          } else {
            if (sevLower === 'critical') return `rgba(220, 38, 38, ${opacity})`;
            if (sevLower === 'high') return `rgba(249, 115, 22, ${opacity})`;
            if (sevLower === 'medium') return `rgba(234, 179, 8, ${opacity})`;
            return `rgba(59, 130, 246, ${opacity})`;
          }
        },

        truncateText(text, maxLength) {
          if (!text) return '';
          if (text.length <= maxLength) return text;
          return text.substring(0, maxLength) + '...';
        },

        formatDate(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          const options = { year: 'numeric', month: 'short', day: 'numeric' };
          return date.toLocaleDateString('en-US', options);
        }
      },
      mounted() {
        // Auto-load pulsation data
        this.fetchPulsationData();
        // Set default dates for MBR
        this.setDefaultDates();
        // Load saved reports and email recipients
        this.fetchSavedReports();
        this.fetchRecipients();
        // Load account mappings
        this.loadAccountMappings();
        // Check GPT authorization status
        this.checkGPTAuthStatus();
        // Initialize bounce dates
        this.initBounceDates();
        // Load industry updates
        this.loadIndustryUpdates();
      },
      watch: {
        gptTimePeriod() {
          if (this.gptAuthorized) {
            this.loadGPTData();
          }
        },

        // Auto-load data when navigating to specific pages
        activePage(newPage, oldPage) {
          // Auto-load SNDS data
          if (newPage === 'snds') {
            this.loadSNDSData();
          }

          // Auto-load GPT data (if authorized)
          if (newPage === 'gpt' && this.gptAuthorized) {
            this.loadGPTData();
          }

          // Auto-load Account Info data
          if (newPage === 'info') {
            this.fetchAccountInfo();
          }
        }
      }
    });

    // Mount app and expose globally for debugging
    window.app = vueApp.mount('#app');
    console.log('‚úÖ Vue app mounted. Access via window.app or just app in console');
  </script>
</body>
</html>
